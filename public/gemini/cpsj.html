<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº§å“æµ·æŠ¥è®¾è®¡</title>
    <link rel="stylesheet" href="../styles/workspace.css">
    <link rel="stylesheet" href="../styles/mobile.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif; background: #f5f7fa; min-height: 100vh; color: #1e293b; }

        .top-header { background: #fff; padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; position: fixed; top: 0; left: 0; right: 0; z-index: 100; height: 56px; }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .header-btn { display: flex; align-items: center; gap: 6px; padding: 8px 16px; background: #f8f9fb; border: 1px solid #e8ecf1; border-radius: 8px; font-size: 13px; color: #475569; cursor: pointer; transition: all 0.2s; text-decoration: none; }
        .header-btn:hover { background: #f0f2f5; border-color: #d1d5db; }
        .page-title { font-size: 20px; font-weight: 600; background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%); -webkit-background-clip: text; background-clip: text; color: transparent; }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .header-icon-btn { width: 36px; height: 36px; border-radius: 8px; border: 1px solid #e8ecf1; background: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; color: #64748b; }

        .tab-nav { background: #fff; padding: 0 24px; border-bottom: 1px solid #e8ecf1; position: fixed; top: 56px; left: 0; right: 0; z-index: 99; height: 48px; display: flex; align-items: center; gap: 8px; }
        .tab-item { padding: 8px 20px; font-size: 14px; color: #64748b; border-radius: 6px; cursor: pointer; transition: all 0.2s; text-decoration: none; }
        .tab-item:hover { background: #f5f7fa; color: #475569; }
        .tab-item.active { background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%); color: #fff; font-weight: 500; }

        .main-content { margin-top: 104px; padding: 24px; display: grid; grid-template-columns: 1fr 1fr; gap: 24px; max-width: 1600px; margin-left: auto; margin-right: auto; }
        .left-panel, .right-panel { display: flex; flex-direction: column; gap: 20px; }
        .panel-section { background: #fff; border-radius: 12px; padding: 20px; border: 1px solid #e8ecf1; }
        .section-title { font-size: 15px; font-weight: 600; color: #1e293b; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .section-title .badge { font-size: 11px; padding: 2px 8px; background: #fef3c7; color: #92400e; border-radius: 10px; font-weight: 500; }

        .credential-input { width: 100%; padding: 10px 14px; border: 1px solid #e8ecf1; border-radius: 8px; font-size: 13px; background: #fafbfc; }
        .credential-input:focus { outline: none; border-color: #f59e0b; background: #fff; }
        .helper { font-size: 12px; color: #94a3b8; margin-top: 8px; line-height: 1.5; }

        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .upload-box { border: 2px dashed #d1d5db; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s; background: #fafbfc; min-height: 180px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .upload-box:hover { border-color: #f59e0b; background: #fffbeb; }
        .upload-box.has-image { border-style: solid; border-color: #f59e0b; padding: 0; background: #fff; }
        .upload-box .upload-icon { font-size: 32px; margin-bottom: 8px; }
        .upload-box .upload-label { font-size: 14px; font-weight: 500; color: #475569; margin-bottom: 4px; }
        .upload-box .upload-hint { font-size: 12px; color: #94a3b8; }
        .upload-box img { max-width: 100%; max-height: 170px; width: auto; height: auto; object-fit: contain; border-radius: 8px; }
        .upload-box .delete-btn { position: absolute; top: 8px; right: 8px; width: 28px; height: 28px; background: rgba(255,255,255,0.95); border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; color: #ef4444; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 10; transition: all 0.2s; }
        .upload-box .delete-btn:hover { background: #fff; transform: scale(1.1); box-shadow: 0 4px 12px rgba(0,0,0,0.25); }
        /* å®Œå…¨éšè—æ–‡ä»¶è¾“å…¥æ¡† - ä½¿ç”¨å¤šç§æ–¹æ³•ç¡®ä¿å…¼å®¹æ€§ */
        .file-input,
        .upload-box input[type="file"],
        input.file-input[type="file"] {
            position: absolute !important;
            width: 1px !important;
            height: 1px !important;
            padding: 0 !important;
            margin: -1px !important;
            overflow: hidden !important;
            clip: rect(0, 0, 0, 0) !important;
            clip-path: inset(50%) !important;
            white-space: nowrap !important;
            border: 0 !important;
            opacity: 0 !important;
            pointer-events: none !important;
            visibility: hidden !important;
        }

        /* ç”»å¸ƒç¼–è¾‘åŒº */
        .canvas-section { background: #fff; border-radius: 12px; padding: 20px; border: 1px solid #e8ecf1; }
        .canvas-toolbar { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
        .tool-btn { padding: 8px 16px; border: 1px solid #e8ecf1; border-radius: 8px; background: #fff; font-size: 13px; color: #475569; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
        .tool-btn:hover { border-color: #f59e0b; background: #fffbeb; }
        .tool-btn.active { background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%); color: #fff; border-color: transparent; }
        .tool-separator { width: 1px; height: 24px; background: #e8ecf1; }
        .brush-size { display: flex; align-items: center; gap: 8px; }
        .brush-size label { font-size: 12px; color: #64748b; }
        .brush-size input { width: 80px; }

        .canvas-container { position: relative; background: #f1f5f9; border-radius: 8px; overflow: hidden; min-height: 400px; display: flex; align-items: center; justify-content: center; }
        .canvas-placeholder { text-align: center; color: #94a3b8; }
        .canvas-placeholder .icon { font-size: 48px; margin-bottom: 12px; }
        .canvas-placeholder p { font-size: 14px; }
        #maskCanvas { position: absolute; top: 0; left: 0; cursor: crosshair; }
        #bgImage { max-width: 100%; max-height: 500px; display: block; }

        /* æ–‡å­—è®¾ç½® */
        .text-settings { display: flex; flex-direction: column; gap: 12px; }
        .text-row { display: flex; gap: 12px; align-items: center; }
        .text-row input { flex: 1; }
        .text-row select { width: 120px; }
        .add-text-btn { padding: 8px 16px; background: #f8f9fb; border: 1px solid #e8ecf1; border-radius: 8px; font-size: 13px; color: #475569; cursor: pointer; }
        .add-text-btn:hover { background: #f0f2f5; }

        /* æç¤ºè¯ */
        .prompt-textarea { width: 100%; min-height: 80px; padding: 12px; border: 1px solid #e8ecf1; border-radius: 8px; font-size: 14px; background: #fafbfc; resize: vertical; }
        .prompt-textarea:focus { outline: none; border-color: #f59e0b; background: #fff; }

        /* è¾“å‡ºè®¾ç½® */
        .ratio-btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .ratio-btn { display: flex; align-items: center; gap: 6px; padding: 8px 14px; border: 1px solid #e8ecf1; border-radius: 20px; font-size: 13px; color: #475569; background: #fff; cursor: pointer; transition: all 0.2s; }
        .ratio-btn:hover { border-color: #f59e0b; background: #fffbeb; }
        .ratio-btn.active { background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%); color: #fff; border-color: transparent; }
        .ratio-icon { width: 12px; height: 12px; border: 1.5px solid currentColor; border-radius: 2px; }

        .model-select { width: 100%; padding: 10px 14px; border: 1px solid #e8ecf1; border-radius: 8px; font-size: 13px; background: #fff; }

        /* æŒ‰é’® */
        .submit-btn { width: 100%; padding: 14px 24px; background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%); color: #fff; border: none; border-radius: 10px; font-size: 15px; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3); }
        .submit-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4); }
        .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        .status { font-size: 13px; padding: 10px 14px; border-radius: 8px; margin-top: 12px; }
        .status:empty { display: none; }
        .status.success { background: #ecfdf5; color: #059669; }
        .status.error { background: #fef2f2; color: #dc2626; }
        .status.info { background: #eff6ff; color: #2563eb; }

        /* å†å²è®°å½• */
        .history-empty { text-align: center; color: #94a3b8; font-size: 13px; padding: 40px 20px; }
        .task-list { display: flex; flex-direction: column; gap: 12px; }
        .history-item { background: #f8f9fb; border: 1px solid #e8ecf1; border-radius: 10px; padding: 16px; }
        .history-item header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .history-meta { font-size: 12px; color: #64748b; }
        .history-meta strong { color: #1e293b; font-size: 14px; display: block; margin-bottom: 4px; }
        .history-actions button { padding: 6px 12px; background: #fff; border: 1px solid #e8ecf1; border-radius: 6px; font-size: 12px; color: #475569; cursor: pointer; margin-left: 8px; }
        .history-actions button:hover { border-color: #f59e0b; color: #f59e0b; }
        .history-image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; }
        .history-image img { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 8px; border: 1px solid #e8ecf1; cursor: pointer; }
        .history-image img:hover { transform: scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

        /* æ¨¡å¼åˆ‡æ¢ */
        .mode-switch { display: flex; gap: 8px; margin-bottom: 16px; }
        .mode-btn { flex: 1; padding: 12px; border: 2px solid #e8ecf1; border-radius: 10px; background: #fff; font-size: 14px; color: #475569; cursor: pointer; text-align: center; transition: all 0.2s; }
        .mode-btn:hover { border-color: #f59e0b; }
        .mode-btn.active { border-color: #f59e0b; background: #fffbeb; color: #92400e; }
        .mode-btn .mode-icon { font-size: 24px; display: block; margin-bottom: 6px; }

        @media (max-width: 1024px) { .main-content { grid-template-columns: 1fr; } }
        @media (max-width: 768px) {
            .upload-row { grid-template-columns: 1fr; }
            .canvas-toolbar { justify-content: center; }
        }

        /* å›¾ç‰‡é¢„è§ˆå¼¹çª— */
        .preview-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: none; align-items: center; justify-content: center; padding: 20px; }
        .preview-modal.show { display: flex; }
        .preview-modal img { max-width: 95%; max-height: 95%; object-fit: contain; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
        .preview-close { position: absolute; top: 20px; right: 20px; width: 44px; height: 44px; background: rgba(255,255,255,0.15); border: none; border-radius: 50%; cursor: pointer; font-size: 24px; color: #fff; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .preview-close:hover { background: rgba(255,255,255,0.25); transform: scale(1.1); }
    </style>
</head>
<body>
    <header class="top-header">
        <div class="header-left">
        </div>
        <span class="page-title">äº§å“æµ·æŠ¥è®¾è®¡</span>
        <div class="header-right">
            <button class="header-icon-btn">ğŸ””</button>
        </div>
    </header>

    <nav class="tab-nav">
        <a href="tiqu-yinhua.html" class="tab-item">æå–å°èŠ±</a>
        <a href="situcankao.html" class="tab-item">å››å›¾å‚è€ƒ</a>
        <a href="shitucankao.html" class="tab-item">åå›¾å‚è€ƒ</a>
        <a href="zidingyi.html" class="tab-item">è‡ªå®šä¹‰</a>
        <a href="cpsj.html" class="tab-item active">äº§å“æµ·æŠ¥</a>
    </nav>

    <main class="main-content">
        <div class="left-panel">
            <!-- API Key -->
            <div class="panel-section">
                <h2 class="section-title">APIKeyå¡«å†™åŒº</h2>
                <input type="password" id="credential" class="credential-input" placeholder="ç²˜è´´è®¿é—®å‡­è¯" required autocomplete="off">
                <p class="helper">å¡«å†™DUUè°ƒç”¨ç«™çš„APIkey</p>
            </div>

            <!-- ä¸Šä¼ åŒºåŸŸ -->
            <div class="panel-section">
                <h2 class="section-title">ğŸ“¦ ä¸Šä¼ ç´ æ</h2>
                <div class="upload-row">
                    <label class="upload-box" id="productUpload">
                        <input type="file" class="file-input" id="productFile" accept="image/*" style="position:absolute;width:1px;height:1px;opacity:0;visibility:hidden;pointer-events:none;">
                        <span class="upload-icon">ğŸ“¦</span>
                        <span class="upload-label">ä¸Šä¼ å•†å“å›¾</span>
                        <span class="upload-hint">å¿…å¡«ï¼Œä½ çš„äº§å“å›¾ç‰‡</span>
                    </label>
                    <label class="upload-box" id="bgUpload">
                        <input type="file" class="file-input" id="bgFile" accept="image/*" style="position:absolute;width:1px;height:1px;opacity:0;visibility:hidden;pointer-events:none;">
                        <span class="upload-icon">ğŸ–¼ï¸</span>
                        <span class="upload-label">ä¸Šä¼ èƒŒæ™¯å›¾</span>
                        <span class="upload-hint">å¯é€‰ï¼Œä¸ä¸Šä¼ åˆ™AIç”Ÿæˆ</span>
                    </label>
                </div>
            </div>

            <!-- æ¨¡å¼é€‰æ‹© -->
            <div class="panel-section">
                <h2 class="section-title">ğŸ¨ è®¾è®¡æ¨¡å¼</h2>
                <div class="mode-switch">
                    <button class="mode-btn active" data-mode="auto">
                        <span class="mode-icon">âœ¨</span>
                        AIè‡ªåŠ¨è®¾è®¡
                    </button>
                    <button class="mode-btn" data-mode="mask">
                        <span class="mode-icon">ğŸ¯</span>
                        æ‰‹åŠ¨æ ‡è®°ä½ç½®
                    </button>
                </div>
                <p class="helper" id="modeHint">AIå°†è‡ªåŠ¨åˆ†æå•†å“å’ŒèƒŒæ™¯ï¼Œæ™ºèƒ½èåˆç”Ÿæˆæµ·æŠ¥</p>
            </div>

            <!-- é®ç½©ç¼–è¾‘åŒºï¼ˆæ‰‹åŠ¨æ¨¡å¼ï¼‰ -->
            <div class="canvas-section" id="maskSection" style="display: none;">
                <h2 class="section-title">ğŸ¯ æ ‡è®°äº§å“ä½ç½® <span class="badge">åœ¨èƒŒæ™¯å›¾ä¸Šæ¶‚æŠ¹æ ‡è®°</span></h2>
                <div class="canvas-toolbar">
                    <button class="tool-btn active" data-tool="brush">ğŸ–Œï¸ ç”»ç¬”</button>
                    <button class="tool-btn" data-tool="eraser">ğŸ§¹ æ©¡çš®æ“¦</button>
                    <span class="tool-separator"></span>
                    <div class="brush-size">
                        <label>ç¬”åˆ·å¤§å°:</label>
                        <input type="range" id="brushSize" min="5" max="100" value="30">
                        <span id="brushSizeValue">30</span>
                    </div>
                    <span class="tool-separator"></span>
                    <button class="tool-btn" id="clearMask">ğŸ—‘ï¸ æ¸…é™¤é®ç½©</button>
                    <button class="tool-btn" id="saveMask">ğŸ’¾ ä¿å­˜é®ç½©</button>
                </div>
                <div class="canvas-container" id="canvasContainer">
                    <div class="canvas-placeholder" id="canvasPlaceholder">
                        <div class="icon">ğŸ–¼ï¸</div>
                        <p>è¯·å…ˆä¸Šä¼ èƒŒæ™¯å›¾</p>
                    </div>
                    <img id="bgImage" style="display: none;">
                    <canvas id="maskCanvas" style="display: none;"></canvas>
                </div>
                <p class="helper">åœ¨èƒŒæ™¯å›¾ä¸Šæ¶‚æŠ¹çº¢è‰²åŒºåŸŸï¼Œæ ‡è®°äº§å“åº”è¯¥å‡ºç°çš„ä½ç½®</p>
            </div>

            <!-- æ–‡å­—è®¾ç½® -->
            <div class="panel-section">
                <h2 class="section-title">âœï¸ æµ·æŠ¥æ–‡å­—</h2>
                <div class="text-settings" id="textSettings">
                    <div class="text-row">
                        <input type="text" class="credential-input" id="mainText" placeholder="ä¸»æ ‡é¢˜æ–‡å­—ï¼ˆå¦‚ï¼šæ–°å“ä¸Šå¸‚ï¼‰">
                    </div>
                    <div class="text-row">
                        <input type="text" class="credential-input" id="subText" placeholder="å‰¯æ ‡é¢˜æ–‡å­—ï¼ˆå¦‚ï¼šé™æ—¶ç‰¹æƒ  8æŠ˜èµ·ï¼‰">
                    </div>
                    <div class="text-row">
                        <input type="text" class="credential-input" id="extraText1" placeholder="é™„åŠ æ–‡å­—1ï¼ˆå¦‚ï¼šå…¨åœºåŒ…é‚®ï¼‰">
                    </div>
                    <div class="text-row">
                        <input type="text" class="credential-input" id="extraText2" placeholder="é™„åŠ æ–‡å­—2ï¼ˆå¦‚ï¼šä»…é™ä»Šæ—¥ï¼‰">
                    </div>
                    <div class="text-row">
                        <input type="text" class="credential-input" id="extraText3" placeholder="é™„åŠ æ–‡å­—3ï¼ˆå¦‚ï¼šæ‰«ç é¢†åˆ¸ï¼‰">
                    </div>
                </div>
                <p class="helper">è¾“å…¥å¸Œæœ›åœ¨æµ·æŠ¥ä¸­æ˜¾ç¤ºçš„æ–‡å­—ï¼ŒAIä¼šæ™ºèƒ½æ’ç‰ˆï¼ˆå¯ç•™ç©ºï¼‰</p>
            </div>

            <!-- é¢å¤–æè¿° -->
            <div class="panel-section">
                <h2 class="section-title">ğŸ’¬ è®¾è®¡æè¿°</h2>
                <textarea id="promptInput" class="prompt-textarea" placeholder="æè¿°ä½ æƒ³è¦çš„æµ·æŠ¥é£æ ¼ï¼Œå¦‚ï¼šç®€çº¦ç°ä»£é£æ ¼ã€æš–è‰²è°ƒã€èŠ‚æ—¥ä¿ƒé”€æ°›å›´..."></textarea>
                <div id="optimizeControls" style="display: none; align-items: center; gap: 12px; margin-top: 12px;">
                    <button type="button" class="tool-btn" id="aiOptimizeBtn" style="flex-shrink: 0;">
                        âœ¨ AIæ™ºèƒ½æ¶¦è‰²
                    </button>
                    <label style="display: flex; align-items: center; gap: 6px; font-size: 13px; color: #475569; cursor: pointer;">
                        <input type="checkbox" id="autoOptimize" style="accent-color: #f59e0b;"> ç”Ÿæˆæ—¶è‡ªåŠ¨æ¶¦è‰²
                    </label>
                </div>
                <p class="helper" id="optimizeHint">AIè‡ªåŠ¨è®¾è®¡æ¨¡å¼ä¸‹ä¼šè‡ªåŠ¨è¿›è¡Œæç¤ºè¯æ¶¦è‰²</p>
            </div>

            <!-- è¾“å‡ºè®¾ç½® -->
            <div class="panel-section">
                <h2 class="section-title">âš™ï¸ è¾“å‡ºè®¾ç½®</h2>
                <div style="margin-bottom: 16px;">
                    <label class="helper">è¾“å‡ºæ¯”ä¾‹</label>
                    <div class="ratio-btn-group" style="margin-top: 8px;">
                        <button type="button" class="ratio-btn active" data-ratio="1:1"><span class="ratio-icon"></span> 1:1</button>
                        <button type="button" class="ratio-btn" data-ratio="2:3"><span class="ratio-icon" style="width:10px;height:15px;"></span> 2:3</button>
                        <button type="button" class="ratio-btn" data-ratio="3:4"><span class="ratio-icon" style="width:10px;height:13px;"></span> 3:4</button>
                        <button type="button" class="ratio-btn" data-ratio="9:16"><span class="ratio-icon" style="width:9px;height:16px;"></span> 9:16</button>
                        <button type="button" class="ratio-btn" data-ratio="16:9"><span class="ratio-icon" style="width:16px;height:9px;"></span> 16:9</button>
                    </div>
                    <input type="hidden" id="aspectRatio" value="1:1">
                </div>
                <div style="margin-bottom: 16px;">
                    <label class="helper">è¾“å‡ºåˆ†è¾¨ç‡</label>
                    <select id="resolutionSelect" class="model-select" style="margin-top: 6px;">
                        <option value="1024" selected>1Kï¼ˆ1024ï¼‰</option>
                        <option value="2048">2Kï¼ˆ2048ï¼‰</option>
                        <option value="4096">4Kï¼ˆ4096ï¼‰</option>
                    </select>
                    <p class="helper">ä½¿ç”¨ Gemini 3 Pro Image Preview æ¨¡å‹ï¼Œæœ€é«˜æ”¯æŒ 4K åˆ†è¾¨ç‡</p>
                </div>
                <!-- æ‰¹é‡ç”Ÿæˆè®¾ç½® -->
                <div id="batchSettings">
                    <label class="helper">æ‰¹é‡ç”Ÿæˆï¼ˆæœªä¸Šä¼ èƒŒæ™¯æ—¶å¯ç”¨ï¼‰</label>
                    <div style="margin-top: 8px;">
                        <label class="helper" style="margin: 0; font-size: 11px;">ç”Ÿæˆæ•°é‡</label>
                        <select id="batchCount" class="model-select" style="margin-top: 4px;">
                            <option value="1" selected>1 å¼ </option>
                            <option value="2">2 å¼ </option>
                            <option value="3">3 å¼ </option>
                            <option value="5">5 å¼ </option>
                            <option value="10">10 å¼ </option>
                            <option value="custom">è‡ªå®šä¹‰</option>
                        </select>
                    </div>
                    <input type="number" id="customBatchCount" class="credential-input" min="1" max="50" value="5" placeholder="è¾“å…¥æ•°é‡ (1-50)" style="margin-top: 8px; display: none;">
                    <p class="helper">æœªä¸Šä¼ èƒŒæ™¯æ—¶ï¼ŒAIä¼šä¸ºæ¯å¼ æµ·æŠ¥ç”Ÿæˆä¸åŒçš„åˆ›æ„èƒŒæ™¯ï¼ˆå…¨éƒ¨å¹¶å‘æ‰§è¡Œï¼‰</p>
                </div>
            </div>

            <button type="button" class="submit-btn" id="submitBtn">ğŸ¨ ç”Ÿæˆæµ·æŠ¥</button>
            <p id="status" class="status"></p>
            <!-- æ‰¹é‡è¿›åº¦ -->
            <div id="batchProgress" style="display: none; margin-top: 12px;">
                <div style="display: flex; justify-content: space-between; font-size: 13px; color: #475569; margin-bottom: 6px;">
                    <span>ç”Ÿæˆè¿›åº¦</span>
                    <span id="progressText">0/0</span>
                </div>
                <div style="height: 8px; background: #e8ecf1; border-radius: 4px; overflow: hidden;">
                    <div id="progressBar" style="height: 100%; background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%); width: 0%; transition: width 0.3s;"></div>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <!-- é¢„è§ˆåŒº -->
            <div class="panel-section" id="outputSection" style="display: none;">
                <h2 class="section-title">ğŸ–¼ï¸ ç”Ÿæˆç»“æœ</h2>
                <div id="imageOutput" class="history-image-grid"></div>
            </div>

            <!-- å†å²è®°å½• -->
            <div class="panel-section" style="flex: 1;">
                <h2 class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>ğŸ“‹ å†å²è®°å½•</span>
                    <button type="button" class="tool-btn" id="refreshHistory" style="padding: 6px 12px; font-size: 12px;">ğŸ”„ åˆ·æ–°</button>
                </h2>
                <p id="historyEmpty" class="history-empty">æš‚æ— ç”Ÿæˆè®°å½•</p>
                <div id="taskHistoryList" class="task-list"></div>
            </div>
        </div>
    </main>

    <!-- å›¾ç‰‡é¢„è§ˆå¼¹çª— -->
    <div class="preview-modal" id="previewModal" onclick="closePreview(event)">
        <button class="preview-close" onclick="closePreview(event)">âœ•</button>
        <img id="previewImage" src="" alt="é¢„è§ˆ">
    </div>

    <script src="../scripts/duu-db.js"></script>
    <script src="../scripts/apikeys.js"></script>
    <script src="../scripts/auth.js"></script>
    <script src="../scripts/image-server.js"></script>
</body>
</html>

    <script>
      // ========== å¸¸é‡å’ŒçŠ¶æ€ ==========
      const API_BASE = '';
      const MODEL_ENDPOINT = (apiKey) => `${API_BASE}/v1beta/models/gemini-3-pro-image-preview:generateContent?key=${encodeURIComponent(apiKey)}`;
      const OPTIMIZER_MODEL_ENDPOINT = (apiKey) => `${API_BASE}/v1beta/models/gemini-2.5-flash-lite-nothinking:generateContent?key=${encodeURIComponent(apiKey)}`;
      
      // DOM å…ƒç´ 
      const credentialInput = document.getElementById('credential');
      const productFileInput = document.getElementById('productFile');
      const bgFileInput = document.getElementById('bgFile');
      const productUpload = document.getElementById('productUpload');
      const bgUpload = document.getElementById('bgUpload');
      const submitBtn = document.getElementById('submitBtn');
      const statusEl = document.getElementById('status');
      const imageOutput = document.getElementById('imageOutput');
      const outputSection = document.getElementById('outputSection');
      const historyEmpty = document.getElementById('historyEmpty');
      const taskHistoryList = document.getElementById('taskHistoryList');
      const maskSection = document.getElementById('maskSection');
      const canvasContainer = document.getElementById('canvasContainer');
      const canvasPlaceholder = document.getElementById('canvasPlaceholder');
      const bgImage = document.getElementById('bgImage');
      const maskCanvas = document.getElementById('maskCanvas');
      const brushSizeInput = document.getElementById('brushSize');
      const brushSizeValue = document.getElementById('brushSizeValue');
      const mainTextInput = document.getElementById('mainText');
      const subTextInput = document.getElementById('subText');
      const extraText1Input = document.getElementById('extraText1');
      const extraText2Input = document.getElementById('extraText2');
      const extraText3Input = document.getElementById('extraText3');
      const promptInput = document.getElementById('promptInput');
      const aspectRatioInput = document.getElementById('aspectRatio');
      const resolutionSelect = document.getElementById('resolutionSelect');
      const modeHint = document.getElementById('modeHint');
      const aiOptimizeBtn = document.getElementById('aiOptimizeBtn');
      const autoOptimizeCheckbox = document.getElementById('autoOptimize');
      const batchCountSelect = document.getElementById('batchCount');
      const customBatchCountInput = document.getElementById('customBatchCount');
      const batchProgress = document.getElementById('batchProgress');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');

      // çŠ¶æ€
      let productFile = null;
      let bgFile = null;
      let productPreviewUrl = null;
      let bgPreviewUrl = null;
      let currentMode = 'auto';
      let currentTool = 'brush';
      let isDrawing = false;
      let maskSaved = false;
      let maskDataUrl = null;
      let taskHistory = [];
      let isGenerating = false;
      const ctx = maskCanvas.getContext('2d');

      // åˆå§‹åŒ–ç¼“å­˜
      const pageCache = new CacheManager('gemini-cpsj');

      // ========== å·¥å…·å‡½æ•° ==========
      const readFileAsBase64 = (file) => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const result = reader.result;
          const base64 = result.split(',').pop();
          resolve({ base64, mimeType: file.type, dataUrl: result });
        };
        reader.onerror = () => reject(reader.error);
        reader.readAsDataURL(file);
      });

      const setStatus = (msg, type = '') => {
        statusEl.textContent = msg;
        statusEl.className = type ? `status ${type}` : 'status';
      };

      const formatDate = (date) => {
        const d = new Date(date);
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
      };

      // ========== åˆå§‹åŒ– ==========
      // åˆå§‹åŒ– API Key
      if (window.initApiKeyInput) {
        window.initApiKeyInput('gemini', 'credential');
      }

      // API Key ç¼“å­˜
      let apiKeyTimer = null;
      credentialInput.addEventListener('input', (e) => {
        if (apiKeyTimer) clearTimeout(apiKeyTimer);
        apiKeyTimer = setTimeout(async () => {
          const apiKey = e.target.value.trim();
          if (apiKey) await pageCache.set('apiKey', apiKey, { ttl: null });
        }, 500);
      });

      // æ¢å¤ç¼“å­˜
      (async function restoreCache() {
        const [cachedApiKey, cachedHistory, cachedTexts] = await Promise.all([
          pageCache.get('apiKey'),
          pageCache.get('taskHistory'),
          pageCache.get('posterTexts')
        ]);
        if (cachedApiKey) credentialInput.value = cachedApiKey;
        if (cachedHistory && Array.isArray(cachedHistory)) {
          taskHistory = cachedHistory.map(t => ({ ...t, createdAt: new Date(t.createdAt) }));
          renderHistory();
        }
        // æ¢å¤æµ·æŠ¥æ–‡å­—
        if (cachedTexts) {
          if (cachedTexts.mainText) mainTextInput.value = cachedTexts.mainText;
          if (cachedTexts.subText) subTextInput.value = cachedTexts.subText;
          if (cachedTexts.extraText1) extraText1Input.value = cachedTexts.extraText1;
          if (cachedTexts.extraText2) extraText2Input.value = cachedTexts.extraText2;
          if (cachedTexts.extraText3) extraText3Input.value = cachedTexts.extraText3;
        }
      })();

      // æµ·æŠ¥æ–‡å­—ç¼“å­˜
      const saveTextsToCache = async () => {
        await pageCache.set('posterTexts', {
          mainText: mainTextInput.value,
          subText: subTextInput.value,
          extraText1: extraText1Input.value,
          extraText2: extraText2Input.value,
          extraText3: extraText3Input.value
        }, { ttl: null });
      };

      // ç›‘å¬æ–‡å­—è¾“å…¥å˜åŒ–
      [mainTextInput, subTextInput, extraText1Input, extraText2Input, extraText3Input].forEach(input => {
        let timer = null;
        input.addEventListener('input', () => {
          if (timer) clearTimeout(timer);
          timer = setTimeout(saveTextsToCache, 500);
        });
      });

      // ========== æ–‡ä»¶ä¸Šä¼  ==========
      productFileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        productFile = file;
        if (productPreviewUrl) URL.revokeObjectURL(productPreviewUrl);
        productPreviewUrl = URL.createObjectURL(file);
        productUpload.classList.add('has-image');
        productUpload.innerHTML = `
          <input type="file" class="file-input" id="productFile" accept="image/*" style="position:absolute;width:1px;height:1px;opacity:0;visibility:hidden;pointer-events:none;">
          <img src="${productPreviewUrl}" alt="å•†å“å›¾">
          <button type="button" class="delete-btn" onclick="removeProduct(event)">âœ•</button>
        `;
        document.getElementById('productFile').addEventListener('change', arguments.callee);
      });

      bgFileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        bgFile = file;
        if (bgPreviewUrl) URL.revokeObjectURL(bgPreviewUrl);
        bgPreviewUrl = URL.createObjectURL(file);
        bgUpload.classList.add('has-image');
        bgUpload.innerHTML = `
          <input type="file" class="file-input" id="bgFile" accept="image/*" style="position:absolute;width:1px;height:1px;opacity:0;visibility:hidden;pointer-events:none;">
          <img src="${bgPreviewUrl}" alt="èƒŒæ™¯å›¾">
          <button type="button" class="delete-btn" onclick="removeBg(event)">âœ•</button>
        `;
        document.getElementById('bgFile').addEventListener('change', arguments.callee);
        
        // å¦‚æœæ˜¯æ‰‹åŠ¨æ¨¡å¼ï¼ŒåŠ è½½åˆ°ç”»å¸ƒ
        if (currentMode === 'mask') {
          loadBgToCanvas(bgPreviewUrl);
        }
      });

      window.removeProduct = (e) => {
        e.preventDefault();
        e.stopPropagation();
        productFile = null;
        if (productPreviewUrl) URL.revokeObjectURL(productPreviewUrl);
        productPreviewUrl = null;
        productUpload.classList.remove('has-image');
        productUpload.innerHTML = `
          <input type="file" class="file-input" id="productFile" accept="image/*" style="position:absolute;width:1px;height:1px;opacity:0;visibility:hidden;pointer-events:none;">
          <span class="upload-icon">ğŸ“¦</span>
          <span class="upload-label">ä¸Šä¼ å•†å“å›¾</span>
          <span class="upload-hint">å¿…å¡«ï¼Œä½ çš„äº§å“å›¾ç‰‡</span>
        `;
        document.getElementById('productFile').addEventListener('change', productFileInput.onchange);
      };

      window.removeBg = (e) => {
        e.preventDefault();
        e.stopPropagation();
        bgFile = null;
        if (bgPreviewUrl) URL.revokeObjectURL(bgPreviewUrl);
        bgPreviewUrl = null;
        bgUpload.classList.remove('has-image');
        bgUpload.innerHTML = `
          <input type="file" class="file-input" id="bgFile" accept="image/*" style="position:absolute;width:1px;height:1px;opacity:0;visibility:hidden;pointer-events:none;">
          <span class="upload-icon">ğŸ–¼ï¸</span>
          <span class="upload-label">ä¸Šä¼ èƒŒæ™¯å›¾</span>
          <span class="upload-hint">å¯é€‰ï¼Œä¸ä¸Šä¼ åˆ™AIç”Ÿæˆ</span>
        `;
        document.getElementById('bgFile').addEventListener('change', bgFileInput.onchange);
        
        // æ¸…é™¤ç”»å¸ƒ
        if (currentMode === 'mask') {
          bgImage.style.display = 'none';
          maskCanvas.style.display = 'none';
          canvasPlaceholder.style.display = 'block';
          maskSaved = false;
          maskDataUrl = null;
        }
      };

      // è·å–æ¶¦è‰²æ§åˆ¶åŒºåŸŸ
      const optimizeControls = document.getElementById('optimizeControls');
      const optimizeHint = document.getElementById('optimizeHint');

      // ========== æ¨¡å¼åˆ‡æ¢ ==========
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentMode = btn.dataset.mode;
          
          if (currentMode === 'mask') {
            maskSection.style.display = 'block';
            modeHint.textContent = 'åœ¨èƒŒæ™¯å›¾ä¸Šæ¶‚æŠ¹æ ‡è®°äº§å“ä½ç½®ï¼ŒAIä¼šå°†äº§å“æ”¾ç½®åˆ°æ ‡è®°åŒºåŸŸ';
            // æ‰‹åŠ¨æ¨¡å¼æ˜¾ç¤ºæ¶¦è‰²é€‰é¡¹
            optimizeControls.style.display = 'flex';
            optimizeHint.textContent = 'ç‚¹å‡»"AIæ™ºèƒ½æ¶¦è‰²"å¯æ ¹æ®ä¸Šä¼ çš„å›¾ç‰‡è‡ªåŠ¨ç”Ÿæˆä¸“ä¸šçš„è®¾è®¡æè¿°ï¼Œæˆ–å‹¾é€‰è‡ªåŠ¨æ¶¦è‰²åœ¨ç”Ÿæˆæ—¶è‡ªåŠ¨ä¼˜åŒ–';
            if (bgPreviewUrl) loadBgToCanvas(bgPreviewUrl);
          } else {
            maskSection.style.display = 'none';
            modeHint.textContent = 'AIå°†è‡ªåŠ¨åˆ†æå•†å“å’ŒèƒŒæ™¯ï¼Œæ™ºèƒ½èåˆç”Ÿæˆæµ·æŠ¥ï¼ˆè‡ªåŠ¨å¯ç”¨æç¤ºè¯æ¶¦è‰²ï¼‰';
            // AIè‡ªåŠ¨æ¨¡å¼éšè—æ¶¦è‰²é€‰é¡¹ï¼ˆå› ä¸ºä¼šè‡ªåŠ¨æ¶¦è‰²ï¼‰
            optimizeControls.style.display = 'none';
            optimizeHint.textContent = 'AIè‡ªåŠ¨è®¾è®¡æ¨¡å¼ä¸‹ä¼šè‡ªåŠ¨è¿›è¡Œæç¤ºè¯æ¶¦è‰²';
          }
        });
      });

      // ========== ç”»å¸ƒé®ç½© ==========
      function loadBgToCanvas(url) {
        const img = new Image();
        img.onload = () => {
          bgImage.src = url;
          bgImage.style.display = 'block';
          canvasPlaceholder.style.display = 'none';
          
          // è®¾ç½®ç”»å¸ƒå¤§å°
          const containerWidth = canvasContainer.clientWidth - 40;
          const scale = Math.min(1, containerWidth / img.width, 500 / img.height);
          const displayWidth = img.width * scale;
          const displayHeight = img.height * scale;
          
          bgImage.style.width = displayWidth + 'px';
          bgImage.style.height = displayHeight + 'px';
          
          maskCanvas.width = displayWidth;
          maskCanvas.height = displayHeight;
          maskCanvas.style.display = 'block';
          
          // æ¸…é™¤ä¹‹å‰çš„é®ç½©
          ctx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
          maskSaved = false;
          maskDataUrl = null;
        };
        img.src = url;
      }

      // ç”»ç¬”å·¥å…·
      document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tool-btn[data-tool]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentTool = btn.dataset.tool;
        });
      });

      brushSizeInput.addEventListener('input', () => {
        brushSizeValue.textContent = brushSizeInput.value;
      });

      // ç»˜åˆ¶é®ç½©
      maskCanvas.addEventListener('mousedown', (e) => {
        isDrawing = true;
        draw(e);
      });

      maskCanvas.addEventListener('mousemove', (e) => {
        if (isDrawing) draw(e);
      });

      maskCanvas.addEventListener('mouseup', () => isDrawing = false);
      maskCanvas.addEventListener('mouseleave', () => isDrawing = false);

      // è§¦æ‘¸æ”¯æŒ
      maskCanvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        isDrawing = true;
        drawTouch(e);
      });
      maskCanvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (isDrawing) drawTouch(e);
      });
      maskCanvas.addEventListener('touchend', () => isDrawing = false);

      function draw(e) {
        const rect = maskCanvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const size = parseInt(brushSizeInput.value);
        
        ctx.beginPath();
        ctx.arc(x, y, size / 2, 0, Math.PI * 2);
        
        if (currentTool === 'brush') {
          ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
          ctx.fill();
        } else {
          ctx.globalCompositeOperation = 'destination-out';
          ctx.fill();
          ctx.globalCompositeOperation = 'source-over';
        }
      }

      function drawTouch(e) {
        const touch = e.touches[0];
        const rect = maskCanvas.getBoundingClientRect();
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        const size = parseInt(brushSizeInput.value);
        
        ctx.beginPath();
        ctx.arc(x, y, size / 2, 0, Math.PI * 2);
        
        if (currentTool === 'brush') {
          ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
          ctx.fill();
        } else {
          ctx.globalCompositeOperation = 'destination-out';
          ctx.fill();
          ctx.globalCompositeOperation = 'source-over';
        }
      }

      // æ¸…é™¤é®ç½©
      document.getElementById('clearMask').addEventListener('click', () => {
        ctx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
        maskSaved = false;
        maskDataUrl = null;
        setStatus('é®ç½©å·²æ¸…é™¤', 'info');
      });

      // ä¿å­˜é®ç½©
      document.getElementById('saveMask').addEventListener('click', () => {
        maskDataUrl = maskCanvas.toDataURL('image/png');
        maskSaved = true;
        setStatus('é®ç½©å·²ä¿å­˜ï¼', 'success');
      });

      // ========== æ¯”ä¾‹é€‰æ‹© ==========
      document.querySelectorAll('.ratio-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.ratio-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          aspectRatioInput.value = btn.dataset.ratio;
        });
      });

      // ========== AI æ™ºèƒ½æ¶¦è‰² ==========
      const optimizePrompt = async (apiKey) => {
        const systemPrompt = `# Role
ä½ æ˜¯ä¸€ä½ç²¾é€š "nanobanana" å›¾åƒç¼–è¾‘æ¨¡å‹çš„æç¤ºè¯ä¸“å®¶ã€‚ä½ çš„æ ¸å¿ƒèƒ½åŠ›æ˜¯ç†è§£ç”¨æˆ·çš„å¤šå›¾å‚è€ƒæ„å›¾ï¼Œç”Ÿæˆç²¾å‡†ã€å…‹åˆ¶ä¸”é«˜è´¨é‡çš„ä¸­æ–‡ç¼–è¾‘æŒ‡ä»¤ã€‚

# Task
æ ¹æ®ç”¨æˆ·æä¾›çš„å•†å“å›¾ç‰‡å’ŒèƒŒæ™¯å›¾ç‰‡ï¼ˆå¦‚æœ‰ï¼‰ï¼Œç”Ÿæˆé€‚ç”¨äºäº§å“æµ·æŠ¥è®¾è®¡çš„ä¸­æ–‡ Promptã€‚

# Constraints & Rules
1. ä¸­æ–‡è¾“å‡ºï¼šæ‰€æœ‰çš„ Prompt å¿…é¡»ä½¿ç”¨ç®€ä½“ä¸­æ–‡ã€‚
2. å‘½ä»¤å¼å¥å¼ï¼šä½¿ç”¨ç›´æ¥ã€æœæ–­çš„åŠ¨ä½œåŠ¨è¯å¼€å¤´ï¼ˆå¦‚ï¼šèåˆã€æ”¾ç½®ã€è®¾è®¡ã€è¥é€ ï¼‰ã€‚
3. å¤šå›¾é€»è¾‘å¤„ç†ï¼š
   - å•†å“å›¾ä¸ºä¸»ä½“ï¼ŒèƒŒæ™¯å›¾ä¸ºåœºæ™¯å‚è€ƒã€‚
   - å¿…é¡»æ¸…æ™°ç•Œå®šå•†å“ä¸èƒŒæ™¯çš„èåˆå…³ç³»ã€‚
4. å…‹åˆ¶è”æƒ³ï¼ˆé«˜ä¿çœŸï¼‰ï¼š
   - ä¸¥ç¦éšæ„æ·»åŠ ç”¨æˆ·æœªæåŠçš„ç‰©ä½“æˆ–å¤æ‚èƒŒæ™¯ã€‚
   - ä»…åœ¨æè´¨ã€å…‰å½±ã€æ¸…æ™°åº¦è¿™ä¸‰ä¸ªç»´åº¦è¿›è¡Œå¿…è¦çš„ä¸“ä¸šæœ¯è¯­è¡¥å…¨ï¼Œä»¥ä¿è¯ç”Ÿæˆè´¨é‡ã€‚
5. ç”»è´¨å¢å¼ºï¼šåœ¨ Prompt æœ«å°¾è¿½åŠ  2 ä¸ªé€šç”¨çš„ç”»è´¨å¢å¼ºè¯ã€‚

# Output Format
ç›´æ¥è¾“å‡º Prompt å†…å®¹ï¼Œä¸åŒ…å«ä»»ä½•è§£é‡Šã€å‰è¨€æˆ–é¢å¤–ç¬¦å·ã€‚

# Workflow
1. åˆ†æå•†å“å›¾ï¼Œè¯†åˆ«äº§å“ç±»å‹ã€æè´¨ã€è‰²å½©ç‰¹å¾ã€‚
2. åˆ†æèƒŒæ™¯å›¾ï¼ˆå¦‚æœ‰ï¼‰ï¼Œæå–åœºæ™¯é£æ ¼å’Œæ°›å›´ã€‚
3. ç¼–å†™èåˆæŒ‡ä»¤ï¼Œç¡®ä¿å•†å“ä¸èƒŒæ™¯è‡ªç„¶åè°ƒã€‚
4. æ£€æŸ¥æ˜¯å¦è¿‡åº¦è”æƒ³ï¼Œåˆ é™¤å¤šä½™çš„å½¢å®¹è¯ã€‚
5. è¿½åŠ ç”»è´¨è¯ã€‚

# Examples
User: æŠŠè¿™ä¸ªäº§å“æ”¾åˆ°è¿™ä¸ªèƒŒæ™¯é‡Œåšæµ·æŠ¥
Output: å°†å•†å“è‡ªç„¶èå…¥èƒŒæ™¯åœºæ™¯ä¸­ï¼Œä¿æŒå•†å“åŸæœ‰çš„æè´¨è´¨æ„Ÿå’Œå…‰å½±æ•ˆæœã€‚è°ƒæ•´å•†å“é€è§†è§’åº¦ä¸èƒŒæ™¯ä¸€è‡´ï¼Œç¡®ä¿å…‰æºæ–¹å‘ç»Ÿä¸€ã€‚æ•´ä½“æ„å›¾çªå‡ºå•†å“ä¸»ä½“ï¼ŒèƒŒæ™¯é€‚å½“è™šåŒ–ã€‚é«˜ç”»è´¨ï¼Œç»†èŠ‚æ¸…æ™°ã€‚

User: ç»™è¿™ä¸ªäº§å“è®¾è®¡ä¸€ä¸ªä¿ƒé”€æµ·æŠ¥
Output: ä»¥å•†å“ä¸ºè§†è§‰ä¸­å¿ƒï¼Œè®¾è®¡ç®€æ´æœ‰åŠ›çš„ä¿ƒé”€æµ·æŠ¥ã€‚èƒŒæ™¯é‡‡ç”¨çº¯è‰²æˆ–æ¸å˜ï¼Œçªå‡ºå•†å“è´¨æ„Ÿã€‚é¢„ç•™æ–‡å­—æ’ç‰ˆç©ºé—´ï¼Œæ•´ä½“é£æ ¼ç°ä»£ä¸“ä¸šã€‚çœŸå®å…‰å½±ï¼Œ8kåˆ†è¾¨ç‡ã€‚

# Quality Boosters (éšæœºé€‰æ‹©2ä¸ª)
(é«˜ç”»è´¨, ç»†èŠ‚æ¸…æ™°, çœŸå®å…‰å½±, ç”µå½±çº§è´¨æ„Ÿ, 8kåˆ†è¾¨ç‡)`;

        const userPrompt = promptInput.value.trim();
        const mainText = mainTextInput.value.trim();
        const subText = subTextInput.value.trim();
        const extraText1 = extraText1Input.value.trim();
        const extraText2 = extraText2Input.value.trim();
        const extraText3 = extraText3Input.value.trim();
        
        let instruction = systemPrompt + '\n\n';
        if (userPrompt) {
          instruction += `ç”¨æˆ·çš„è®¾è®¡éœ€æ±‚ï¼š${userPrompt}\n\n`;
        }
        const allTexts = [mainText, subText, extraText1, extraText2, extraText3].filter(t => t);
        if (allTexts.length > 0) {
          instruction += `æµ·æŠ¥æ–‡å­—è¦æ±‚ï¼š${allTexts.join('ã€')}\n\n`;
        }
        instruction += 'è¯·åˆ†æå›¾ç‰‡å¹¶ç”Ÿæˆä¸“ä¸šçš„äº§å“æµ·æŠ¥è®¾è®¡æç¤ºè¯ï¼š';

        const parts = [{ text: instruction }];
        
        // æ·»åŠ å•†å“å›¾
        if (productFile) {
          const productData = await readFileAsBase64(productFile);
          parts.push({
            inline_data: {
              mime_type: productData.mimeType,
              data: productData.base64
            }
          });
        }
        
        // æ·»åŠ èƒŒæ™¯å›¾
        if (bgFile) {
          const bgData = await readFileAsBase64(bgFile);
          parts.push({
            inline_data: {
              mime_type: bgData.mimeType,
              data: bgData.base64
            }
          });
        }

        const body = {
          contents: [{ role: 'user', parts }]
        };

        const response = await fetch(OPTIMIZER_MODEL_ENDPOINT(apiKey), {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify(body)
        });

        const responseText = await response.text();
        if (!response.ok) {
          throw new Error(`API é”™è¯¯: ${response.status}`);
        }

        const json = JSON.parse(responseText);
        const candidates = json?.candidates || [];
        let optimizedText = '';

        candidates.forEach(candidate => {
          candidate.content?.parts?.forEach(part => {
            if (part.text) {
              optimizedText += part.text;
            }
          });
        });

        return optimizedText.trim();
      };

      // AIæ¶¦è‰²æŒ‰é’®ç‚¹å‡»
      aiOptimizeBtn.addEventListener('click', async () => {
        const apiKey = credentialInput.value.trim();
        if (!apiKey) {
          setStatus('è¯·å…ˆå¡«å†™ API Key', 'error');
          return;
        }
        if (!productFile) {
          setStatus('è¯·å…ˆä¸Šä¼ å•†å“å›¾', 'error');
          return;
        }

        aiOptimizeBtn.disabled = true;
        aiOptimizeBtn.textContent = 'â³ æ­£åœ¨æ¶¦è‰²...';
        setStatus('AIæ­£åœ¨åˆ†æå›¾ç‰‡å¹¶ç”Ÿæˆè®¾è®¡æè¿°...', 'info');

        try {
          const optimizedPrompt = await optimizePrompt(apiKey);
          if (optimizedPrompt) {
            promptInput.value = optimizedPrompt;
            setStatus('âœ¨ æç¤ºè¯æ¶¦è‰²å®Œæˆï¼', 'success');
          } else {
            setStatus('æ¶¦è‰²ç»“æœä¸ºç©ºï¼Œè¯·é‡è¯•', 'error');
          }
        } catch (error) {
          console.error('æ¶¦è‰²å¤±è´¥:', error);
          setStatus(`æ¶¦è‰²å¤±è´¥: ${error.message}`, 'error');
        } finally {
          aiOptimizeBtn.disabled = false;
          aiOptimizeBtn.textContent = 'âœ¨ AIæ™ºèƒ½æ¶¦è‰²';
        }
      });

      // ========== æ‰¹é‡æ•°é‡é€‰æ‹© ==========
      batchCountSelect.addEventListener('change', () => {
        customBatchCountInput.style.display = batchCountSelect.value === 'custom' ? 'block' : 'none';
      });

      // è·å–æ‰¹é‡æ•°é‡
      const getBatchCount = () => {
        if (bgFile) return 1; // æœ‰èƒŒæ™¯å›¾æ—¶åªç”Ÿæˆ1å¼ 
        if (batchCountSelect.value === 'custom') {
          return Math.max(1, Math.min(50, parseInt(customBatchCountInput.value) || 1));
        }
        return parseInt(batchCountSelect.value) || 1;
      };

      // å•æ¬¡ç”Ÿæˆè¯·æ±‚
      const generateSingle = async (apiKey, productData, extraPrompt, aspectRatio, resolution, index) => {
        const mainText = mainTextInput.value.trim();
        const subText = subTextInput.value.trim();
        const extraText1 = extraText1Input.value.trim();
        const extraText2 = extraText2Input.value.trim();
        const extraText3 = extraText3Input.value.trim();

        let prompt = 'ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„äº§å“æµ·æŠ¥è®¾è®¡å¸ˆã€‚è¯·æ ¹æ®æä¾›çš„å•†å“å›¾ç‰‡åˆ›å»ºä¸€å¼ ç²¾ç¾çš„äº§å“å®£ä¼ æµ·æŠ¥ã€‚\n\n';
        
        if (bgFile) {
          if (currentMode === 'mask' && maskSaved && maskDataUrl) {
            prompt += 'æˆ‘æä¾›äº†å•†å“å›¾ã€èƒŒæ™¯å›¾å’Œé®ç½©å›¾ã€‚è¯·å°†å•†å“æ”¾ç½®åœ¨é®ç½©æ ‡è®°çš„çº¢è‰²åŒºåŸŸä½ç½®ï¼Œä¸èƒŒæ™¯è‡ªç„¶èåˆã€‚\n';
          } else {
            prompt += 'æˆ‘æä¾›äº†å•†å“å›¾å’ŒèƒŒæ™¯å›¾ã€‚è¯·å°†å•†å“è‡ªç„¶åœ°èåˆåˆ°èƒŒæ™¯ä¸­ï¼Œåˆ›å»ºå’Œè°çš„æµ·æŠ¥æ•ˆæœã€‚\n';
          }
        } else {
          prompt += `è¯·ä¸ºè¿™ä¸ªå•†å“ç”Ÿæˆä¸€ä¸ªç‹¬ç‰¹ä¸”æœ‰åˆ›æ„çš„èƒŒæ™¯ï¼Œåˆ›å»ºä¸“ä¸šçš„äº§å“æµ·æŠ¥ã€‚è¿™æ˜¯ç¬¬ ${index + 1} ä¸ªç‰ˆæœ¬ï¼Œè¯·ç¡®ä¿èƒŒæ™¯é£æ ¼ä¸å…¶ä»–ç‰ˆæœ¬ä¸åŒã€‚\n`;
        }

        const allTexts = [
          mainText && `ä¸»æ ‡é¢˜ï¼š${mainText}`,
          subText && `å‰¯æ ‡é¢˜ï¼š${subText}`,
          extraText1 && `é™„åŠ æ–‡å­—ï¼š${extraText1}`,
          extraText2 && `é™„åŠ æ–‡å­—ï¼š${extraText2}`,
          extraText3 && `é™„åŠ æ–‡å­—ï¼š${extraText3}`
        ].filter(Boolean);
        
        if (allTexts.length > 0) {
          prompt += '\næµ·æŠ¥æ–‡å­—è¦æ±‚ï¼š\n';
          allTexts.forEach(t => prompt += `- ${t}\n`);
          prompt += 'è¯·å°†æ–‡å­—ä»¥ç¾è§‚çš„æ’ç‰ˆæ–¹å¼èå…¥æµ·æŠ¥è®¾è®¡ä¸­ã€‚\n';
        }

        if (extraPrompt) {
          prompt += `\nè®¾è®¡é£æ ¼è¦æ±‚ï¼š${extraPrompt}\n`;
        }

        prompt += `\nè¾“å‡ºè¦æ±‚ï¼š\n- æ¯”ä¾‹ï¼š${aspectRatio}\n- é«˜è´¨é‡ã€ä¸“ä¸šçš„äº§å“æµ·æŠ¥\n- å•†å“æ¸…æ™°çªå‡º\n- æ•´ä½“è®¾è®¡åè°ƒç¾è§‚`;

        const parts = [{ text: prompt }];
        
        parts.push({
          inline_data: {
            mime_type: productData.mimeType,
            data: productData.base64
          }
        });

        if (bgFile) {
          const bgData = await readFileAsBase64(bgFile);
          parts.push({
            inline_data: {
              mime_type: bgData.mimeType,
              data: bgData.base64
            }
          });
        }

        if (currentMode === 'mask' && maskSaved && maskDataUrl) {
          const maskBase64 = maskDataUrl.split(',')[1];
          parts.push({
            inline_data: {
              mime_type: 'image/png',
              data: maskBase64
            }
          });
        }

        const requestBody = {
          contents: [{ role: 'user', parts }],
          generationConfig: {
            responseModalities: ['IMAGE', 'TEXT'],
            imageDimension: resolution
          }
        };

        const response = await fetch(MODEL_ENDPOINT(apiKey), {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify(requestBody)
        });

        const responseText = await response.text();
        if (!response.ok) {
          console.error('APIå“åº”é”™è¯¯:', responseText);
          throw new Error(`API é”™è¯¯: ${response.status} - ${responseText.substring(0, 200)}`);
        }

        const json = JSON.parse(responseText);
        console.log('APIå“åº”:', JSON.stringify(json).substring(0, 500));
        
        const candidates = json?.candidates || [];
        const images = [];

        // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
        if (json?.error) {
          throw new Error(json.error.message || 'APIè¿”å›é”™è¯¯');
        }

        // æ£€æŸ¥æ˜¯å¦è¢«å®‰å…¨è¿‡æ»¤
        if (candidates.length > 0 && candidates[0].finishReason === 'SAFETY') {
          throw new Error('å†…å®¹è¢«å®‰å…¨è¿‡æ»¤ï¼Œè¯·ä¿®æ”¹æè¿°åé‡è¯•');
        }

        candidates.forEach(candidate => {
          candidate.content?.parts?.forEach(part => {
            // æ”¯æŒä¸¤ç§å‘½åæ ¼å¼ï¼šinlineData (APIè¿”å›) å’Œ inline_data
            const inlineData = part.inlineData || part.inline_data;
            if (inlineData) {
              images.push({
                mimeType: inlineData.mimeType || inlineData.mime_type,
                data: inlineData.data
              });
            }
          });
        });

        if (images.length === 0) {
          console.warn('æœªæ‰¾åˆ°å›¾ç‰‡æ•°æ®ï¼Œå®Œæ•´å“åº”:', responseText.substring(0, 1000));
        }

        return images;
      };

      // ========== ç”Ÿæˆæµ·æŠ¥ ==========
      submitBtn.addEventListener('click', async () => {
        const apiKey = credentialInput.value.trim();
        if (!apiKey) {
          setStatus('è¯·å¡«å†™ API Key', 'error');
          return;
        }
        if (!productFile) {
          setStatus('è¯·ä¸Šä¼ å•†å“å›¾', 'error');
          return;
        }
        if (isGenerating) {
          setStatus('æ­£åœ¨ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...', 'info');
          return;
        }

        isGenerating = true;
        submitBtn.disabled = true;
        
        const batchCount = getBatchCount();
        
        try {
          const productData = await readFileAsBase64(productFile);
          let extraPrompt = promptInput.value.trim();
          const aspectRatio = aspectRatioInput.value;
          const resolution = resolutionSelect.value;

          // è‡ªåŠ¨æ¶¦è‰²é€»è¾‘ï¼š
          // - AIè‡ªåŠ¨è®¾è®¡æ¨¡å¼ï¼šè‡ªåŠ¨å¯ç”¨æ¶¦è‰²
          // - æ‰‹åŠ¨æ ‡è®°ä½ç½®æ¨¡å¼ï¼šæ ¹æ®å‹¾é€‰å†³å®š
          const shouldOptimize = (currentMode === 'auto') || (currentMode === 'mask' && autoOptimizeCheckbox.checked);
          
          if (shouldOptimize && productFile) {
            setStatus('AIæ­£åœ¨ä¼˜åŒ–è®¾è®¡æè¿°...', 'info');
            try {
              const optimizedPrompt = await optimizePrompt(apiKey);
              if (optimizedPrompt) {
                extraPrompt = optimizedPrompt;
                promptInput.value = optimizedPrompt;
              }
            } catch (e) {
              console.warn('è‡ªåŠ¨æ¶¦è‰²å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æè¿°:', e);
            }
          }

          // æ‰¹é‡ç”Ÿæˆ
          if (batchCount > 1) {
            batchProgress.style.display = 'block';
            progressBar.style.width = '0%';
            progressText.textContent = `0/${batchCount}`;
            
            const BATCH_SIZE = 20; // æ¯æ‰¹æœ€å¤§å¹¶å‘æ•°
            const needBatch = batchCount > BATCH_SIZE;
            setStatus(`å¼€å§‹æ‰¹é‡ç”Ÿæˆ ${batchCount} å¼ æµ·æŠ¥${needBatch ? `ï¼ˆæ¯${BATCH_SIZE}å¼ ä¸€æ‰¹ï¼‰` : 'ï¼ˆå…¨éƒ¨å¹¶å‘ï¼‰'}...`, 'info');

            let completed = 0;
            let failed = 0;
            const allImages = [];

            // å¦‚æœæ•°é‡å¤§äº20ï¼Œåˆ†æ‰¹æ‰§è¡Œï¼›å¦åˆ™å…¨éƒ¨å¹¶å‘
            if (needBatch) {
              for (let batchStart = 0; batchStart < batchCount; batchStart += BATCH_SIZE) {
                const batchEnd = Math.min(batchStart + BATCH_SIZE, batchCount);
                const currentBatch = batchEnd - batchStart;
                setStatus(`æ­£åœ¨ç”Ÿæˆç¬¬ ${batchStart + 1}-${batchEnd} å¼ ï¼ˆå…±${batchCount}å¼ ï¼‰...`, 'info');
                
                const promises = [];
                for (let i = batchStart; i < batchEnd; i++) {
                  promises.push(
                    generateSingle(apiKey, productData, extraPrompt, aspectRatio, resolution, i)
                      .then(images => {
                        completed++;
                        const progress = Math.round((completed / batchCount) * 100);
                        progressBar.style.width = progress + '%';
                        progressText.textContent = `${completed}/${batchCount}`;
                        return images;
                      })
                      .catch(err => {
                        completed++;
                        failed++;
                        const progress = Math.round((completed / batchCount) * 100);
                        progressBar.style.width = progress + '%';
                        progressText.textContent = `${completed}/${batchCount}`;
                        console.error(`ç¬¬ ${i + 1} å¼ ç”Ÿæˆå¤±è´¥:`, err);
                        return [];
                      })
                  );
                }
                const batchResults = await Promise.all(promises);
                allImages.push(...batchResults.flat());
              }
            } else {
              // å…¨éƒ¨åŒæ—¶å¹¶å‘
              const promises = [];
              for (let i = 0; i < batchCount; i++) {
                promises.push(
                  generateSingle(apiKey, productData, extraPrompt, aspectRatio, resolution, i)
                    .then(images => {
                      completed++;
                      const progress = Math.round((completed / batchCount) * 100);
                      progressBar.style.width = progress + '%';
                      progressText.textContent = `${completed}/${batchCount}`;
                      setStatus(`å·²å®Œæˆ ${completed}/${batchCount}ï¼Œå¤±è´¥ ${failed}`, 'info');
                      return images;
                    })
                    .catch(err => {
                      completed++;
                      failed++;
                      const progress = Math.round((completed / batchCount) * 100);
                      progressBar.style.width = progress + '%';
                      progressText.textContent = `${completed}/${batchCount}`;
                      console.error(`ç¬¬ ${i + 1} å¼ ç”Ÿæˆå¤±è´¥:`, err);
                      return [];
                    })
                );
              }
              const results = await Promise.all(promises);
              allImages.push(...results.flat());
            }

            if (allImages.length === 0) {
              throw new Error('æ‰€æœ‰ç”Ÿæˆéƒ½å¤±è´¥äº†ï¼Œè¯·é‡è¯•');
            }

            // æ˜¾ç¤ºç»“æœ
            outputSection.style.display = 'block';
            imageOutput.innerHTML = allImages.map((img, i) => {
              const src = `data:${img.mimeType};base64,${img.data}`;
              return `
                <div class="history-image">
                  <img src="${src}" alt="ç”Ÿæˆç»“æœ ${i+1}" onclick="openPreview('${src}')" style="cursor:zoom-in;">
                  <div class="history-actions">
                    <button onclick="downloadImage('${src}', 'poster_${Date.now()}_${i}.png')">ğŸ“¥ ä¸‹è½½</button>
                  </div>
                </div>
              `;
            }).join('');

            // ä¿å­˜å†å²
            const mainText = mainTextInput.value.trim();
            const subText = subTextInput.value.trim();
            const entry = {
              id: `task-${Date.now()}`,
              createdAt: new Date(),
              prompt: mainText || subText || extraPrompt || 'äº§å“æµ·æŠ¥',
              images: allImages
            };
            taskHistory.unshift(entry);
            taskHistory = taskHistory.slice(0, 10);
            renderHistory();
            await pageCache.set('taskHistory', taskHistory.map(t => ({
              ...t,
              createdAt: t.createdAt.getTime()
            })), { ttl: null });

            // äº‘ç«¯ä¿å­˜
            if (window.ImageServer && window.shouldSaveToCloud && shouldSaveToCloud()) {
              try {
                const serverImages = allImages.map(img => ({
                  base64: `data:${img.mimeType};base64,${img.data}`
                }));
                await ImageServer.saveGeneration(apiKey, entry.prompt, serverImages, 'gemini-cpsj', 'poster');
              } catch (e) {
                console.error('äº‘ç«¯ä¿å­˜å¤±è´¥:', e);
              }
            }

            setStatus(`âœ… æ‰¹é‡ç”Ÿæˆå®Œæˆï¼æˆåŠŸ ${allImages.length} å¼ ï¼Œå¤±è´¥ ${failed} å¼ `, 'success');

          } else {
            // å•å¼ ç”Ÿæˆ
            setStatus('æ­£åœ¨ç”Ÿæˆæµ·æŠ¥ï¼Œè¯·ç¨å€™...', 'info');
            const images = await generateSingle(apiKey, productData, extraPrompt, aspectRatio, resolution, 0);

            if (images.length === 0) {
              throw new Error('æœªç”Ÿæˆå›¾ç‰‡ï¼Œå¯èƒ½æ˜¯å†…å®¹è¢«è¿‡æ»¤æˆ–APIé™åˆ¶ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—');
            }

            outputSection.style.display = 'block';
            imageOutput.innerHTML = images.map((img, i) => {
              const src = `data:${img.mimeType};base64,${img.data}`;
              return `
                <div class="history-image">
                  <img src="${src}" alt="ç”Ÿæˆç»“æœ ${i+1}" onclick="openPreview('${src}')" style="cursor:zoom-in;">
                  <div class="history-actions">
                    <button onclick="downloadImage('${src}', 'poster_${Date.now()}_${i}.png')">ğŸ“¥ ä¸‹è½½</button>
                  </div>
                </div>
              `;
            }).join('');

            const mainText = mainTextInput.value.trim();
            const subText = subTextInput.value.trim();
            const entry = {
              id: `task-${Date.now()}`,
              createdAt: new Date(),
              prompt: mainText || subText || extraPrompt || 'äº§å“æµ·æŠ¥',
              images
            };
            taskHistory.unshift(entry);
            taskHistory = taskHistory.slice(0, 10);
            renderHistory();
            await pageCache.set('taskHistory', taskHistory.map(t => ({
              ...t,
              createdAt: t.createdAt.getTime()
            })), { ttl: null });

            if (window.ImageServer && window.shouldSaveToCloud && shouldSaveToCloud()) {
              try {
                const serverImages = images.map(img => ({
                  base64: `data:${img.mimeType};base64,${img.data}`
                }));
                await ImageServer.saveGeneration(apiKey, entry.prompt, serverImages, 'gemini-cpsj', 'poster');
              } catch (e) {
                console.error('äº‘ç«¯ä¿å­˜å¤±è´¥:', e);
              }
            }

            setStatus('æµ·æŠ¥ç”ŸæˆæˆåŠŸï¼', 'success');
          }

        } catch (error) {
          console.error('ç”Ÿæˆå¤±è´¥:', error);
          setStatus(`ç”Ÿæˆå¤±è´¥: ${error.message}`, 'error');
        } finally {
          isGenerating = false;
          submitBtn.disabled = false;
          batchProgress.style.display = 'none';
        }
      });

      // ========== ä¸‹è½½å›¾ç‰‡ ==========
      window.downloadImage = (src, filename) => {
        const a = document.createElement('a');
        a.href = src;
        a.download = filename;
        a.click();
      };

      // ========== å›¾ç‰‡é¢„è§ˆ ==========
      const previewModal = document.getElementById('previewModal');
      const previewImage = document.getElementById('previewImage');

      window.openPreview = (src) => {
        previewImage.src = src;
        previewModal.classList.add('show');
        document.body.style.overflow = 'hidden';
      };

      window.closePreview = (e) => {
        if (e.target === previewModal || e.target.classList.contains('preview-close')) {
          previewModal.classList.remove('show');
          document.body.style.overflow = '';
        }
      };

      // ESCé”®å…³é—­é¢„è§ˆ
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && previewModal.classList.contains('show')) {
          previewModal.classList.remove('show');
          document.body.style.overflow = '';
        }
      });

      // ========== åˆ·æ–°å†å²è®°å½• ==========
      document.getElementById('refreshHistory').addEventListener('click', async () => {
        const btn = document.getElementById('refreshHistory');
        btn.disabled = true;
        btn.textContent = 'åˆ·æ–°ä¸­...';
        
        try {
          const cachedHistory = await pageCache.get('taskHistory');
          if (cachedHistory && Array.isArray(cachedHistory)) {
            taskHistory = cachedHistory.map(t => ({ ...t, createdAt: new Date(t.createdAt) }));
          }
          renderHistory();
          setStatus('å†å²è®°å½•å·²åˆ·æ–°', 'success');
        } catch (e) {
          console.error('åˆ·æ–°å¤±è´¥:', e);
          setStatus('åˆ·æ–°å¤±è´¥', 'error');
        } finally {
          btn.disabled = false;
          btn.textContent = 'ğŸ”„ åˆ·æ–°';
        }
      });

      // ========== å†å²è®°å½• ==========
      function renderHistory() {
        if (taskHistory.length === 0) {
          historyEmpty.style.display = 'block';
          taskHistoryList.innerHTML = '';
          return;
        }
        historyEmpty.style.display = 'none';
        taskHistoryList.innerHTML = taskHistory.map((task, index) => {
          const timeStr = formatDate(task.createdAt);
          const imagesHtml = task.images.map((img, i) => {
            const src = img.data ? `data:${img.mimeType};base64,${img.data}` : img.url;
            return `
              <div class="history-image">
                <img src="${src}" alt="å†å²å›¾ç‰‡" onclick="openPreview('${src}')" style="cursor:zoom-in;">
                <div class="history-actions">
                  <button onclick="downloadImage('${src}', 'poster_${task.id}_${i}.png')">ğŸ“¥</button>
                </div>
              </div>
            `;
          }).join('');
          
          return `
            <div class="history-item">
              <header>
                <div class="history-meta">
                  <strong>ä»»åŠ¡ #${taskHistory.length - index}</strong>
                  <span>${timeStr} | ${task.prompt.substring(0, 30)}...</span>
                </div>
                <div class="history-actions">
                  <button onclick="deleteTask('${task.id}')">ğŸ—‘ï¸ åˆ é™¤</button>
                </div>
              </header>
              <div class="history-image-grid">${imagesHtml}</div>
            </div>
          `;
        }).join('');
      }

      window.deleteTask = async (taskId) => {
        taskHistory = taskHistory.filter(t => t.id !== taskId);
        renderHistory();
        await pageCache.set('taskHistory', taskHistory.map(t => ({
          ...t,
          createdAt: t.createdAt.getTime()
        })), { ttl: null });
      };
    </script>
