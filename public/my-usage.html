<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ç”¨é‡</title>
    <link rel="stylesheet" href="styles/workspace.css">
    <link rel="stylesheet" href="styles/mobile.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif; background: #f5f7fa; min-height: 100vh; color: #1e293b; }

        .top-header { background: #fff; padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; position: fixed; top: 0; left: 0; right: 0; z-index: 100; height: 56px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .header-btn { display: flex; align-items: center; gap: 6px; padding: 8px 16px; background: #f8f9fb; border: 1px solid #e8ecf1; border-radius: 8px; font-size: 13px; color: #475569; cursor: pointer; transition: all 0.2s; text-decoration: none; }
        .header-btn:hover { background: #f0f2f5; border-color: #d1d5db; }
        .page-title { font-size: 20px; font-weight: 600; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); -webkit-background-clip: text; background-clip: text; color: transparent; }

        .main-content { margin-top: 72px; padding: 24px; max-width: 1200px; margin-left: auto; margin-right: auto; }

        .api-key-section { background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 24px; border: 1px solid #e8ecf1; }
        .api-key-input-group { display: flex; gap: 12px; }
        .api-key-input { flex: 1; padding: 12px 16px; border: 1px solid #e8ecf1; border-radius: 8px; font-size: 14px; }
        .api-key-input:focus { outline: none; border-color: #6366f1; }
        .query-btn { padding: 12px 24px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: #fff; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .query-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); }
        .query-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: #fff; border-radius: 12px; padding: 20px; border: 1px solid #e8ecf1; }
        .stat-label { font-size: 13px; color: #64748b; margin-bottom: 8px; }
        .stat-value { font-size: 28px; font-weight: 600; color: #1e293b; }
        .stat-value.balance { color: #10b981; }
        .stat-value.used { color: #f59e0b; }
        .stat-unit { font-size: 14px; font-weight: 400; color: #64748b; margin-left: 4px; }

        .log-section { background: #fff; border-radius: 12px; padding: 20px; border: 1px solid #e8ecf1; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .section-title { font-size: 16px; font-weight: 600; color: #1e293b; }
        .refresh-btn { padding: 8px 16px; background: #f8f9fb; border: 1px solid #e8ecf1; border-radius: 6px; font-size: 13px; color: #475569; cursor: pointer; }
        .refresh-btn:hover { background: #f0f2f5; }

        .log-table { width: 100%; border-collapse: collapse; }
        .log-table th, .log-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e8ecf1; }
        .log-table th { font-size: 13px; font-weight: 500; color: #64748b; background: #f8f9fb; }
        .log-table td { font-size: 13px; color: #1e293b; }
        .log-table tr:hover { background: #f8f9fb; }
        .model-tag { display: inline-block; padding: 2px 8px; background: #e0e7ff; color: #4f46e5; border-radius: 4px; font-size: 12px; }
        .cost-cell { font-weight: 500; color: #f59e0b; }

        .empty-state { text-align: center; padding: 60px 20px; color: #94a3b8; }
        .empty-state .icon { font-size: 48px; margin-bottom: 16px; }

        .loading { text-align: center; padding: 40px; color: #64748b; }
        .loading::after { content: ''; display: inline-block; width: 20px; height: 20px; border: 2px solid #e8ecf1; border-top-color: #6366f1; border-radius: 50%; animation: spin 1s linear infinite; margin-left: 8px; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .error-msg { background: #fef2f2; color: #dc2626; padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; }
        .success-msg { background: #ecfdf5; color: #059669; padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; }

        .pagination { display: flex; justify-content: center; gap: 8px; margin-top: 20px; }
        .page-btn { padding: 8px 12px; border: 1px solid #e8ecf1; background: #fff; border-radius: 6px; font-size: 13px; cursor: pointer; }
        .page-btn:hover { background: #f8f9fb; }
        .page-btn.active { background: #6366f1; color: #fff; border-color: #6366f1; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .helper { font-size: 12px; color: #94a3b8; margin-top: 8px; }
    </style>
</head>
<body>
    <header class="top-header">
        <div class="header-left">
        </div>
        <span class="page-title">æˆ‘çš„ç”¨é‡</span>
        <div></div>
    </header>

    <main class="main-content">
        <div class="api-key-section">
            <div class="api-key-input-group">
                <input type="password" id="apiKeyInput" class="api-key-input" placeholder="è¾“å…¥ä½ çš„ API Key æŸ¥è¯¢ç”¨é‡">
                <button id="queryBtn" class="query-btn">æŸ¥è¯¢</button>
            </div>
            <p class="helper">è¾“å…¥ API Key åç‚¹å‡»æŸ¥è¯¢ï¼Œå³å¯æŸ¥çœ‹ä½™é¢å’Œè°ƒç”¨æ˜ç»†</p>
        </div>

        <div id="errorMsg" class="error-msg" style="display: none;"></div>
        <div id="successMsg" class="success-msg" style="display: none;"></div>

        <div id="statsSection" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">å½“å‰ä½™é¢</div>
                    <div class="stat-value balance" id="balanceValue">-<span class="stat-unit">å…ƒ</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å·²ç”¨é¢åº¦</div>
                    <div class="stat-value used" id="usedValue">-<span class="stat-unit">å…ƒ</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æ€»è¯·æ±‚æ¬¡æ•°</div>
                    <div class="stat-value" id="requestCount">-<span class="stat-unit">æ¬¡</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ä»Šæ—¥è¯·æ±‚</div>
                    <div class="stat-value" id="todayCount">-<span class="stat-unit">æ¬¡</span></div>
                </div>
            </div>

            <div class="log-section">
                <div class="section-header">
                    <span class="section-title">è°ƒç”¨æ˜ç»†</span>
                    <button id="refreshBtn" class="refresh-btn">ğŸ”„ åˆ·æ–°</button>
                </div>
                <div id="logContent">
                    <div class="empty-state">
                        <div class="icon">ğŸ“‹</div>
                        <div>æš‚æ— è°ƒç”¨è®°å½•</div>
                    </div>
                </div>
                <div id="pagination" class="pagination" style="display: none;"></div>
            </div>
        </div>
    </main>

    <script>
        // ä½¿ç”¨è‡ªå·±æœåŠ¡å™¨çš„ä»£ç†æ¥å£ï¼Œä¸æš´éœ²ä¸Šæ¸¸åœ°å€
        const API_BASE = '';
        
        const apiKeyInput = document.getElementById('apiKeyInput');
        const queryBtn = document.getElementById('queryBtn');
        const errorMsg = document.getElementById('errorMsg');
        const successMsg = document.getElementById('successMsg');
        const statsSection = document.getElementById('statsSection');
        const logContent = document.getElementById('logContent');
        const refreshBtn = document.getElementById('refreshBtn');
        const pagination = document.getElementById('pagination');

        let currentPage = 1;
        const pageSize = 20;
        let currentApiKey = '';

        // ä»ç¼“å­˜æ¢å¤ API Key
        const cachedKey = localStorage.getItem('duu_usage_apikey');
        if (cachedKey) {
            apiKeyInput.value = cachedKey;
        }

        // æ˜¾ç¤ºé”™è¯¯
        const showError = (msg) => {
            errorMsg.textContent = msg;
            errorMsg.style.display = 'block';
            successMsg.style.display = 'none';
            setTimeout(() => { errorMsg.style.display = 'none'; }, 5000);
        };

        // æ˜¾ç¤ºæˆåŠŸ
        const showSuccess = (msg) => {
            successMsg.textContent = msg;
            successMsg.style.display = 'block';
            errorMsg.style.display = 'none';
            setTimeout(() => { successMsg.style.display = 'none'; }, 3000);
        };

        // KIE credits are not quota; display raw credit values.
        const formatCredit = (value) => {
            if (value === null || value === undefined) return '-';
            const n = Number(value);
            if (Number.isNaN(n)) return String(value);
            return n.toLocaleString('zh-CN', { maximumFractionDigits: 4 });
        };

        // æ ¼å¼åŒ–æ—¶é—´
        const formatTime = (timestamp) => {
            const date = new Date(timestamp * 1000);
            return date.toLocaleString('zh-CN', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        };

        // æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ˆé€šè¿‡ API Keyï¼‰
        const queryUserInfo = async (apiKey) => {
            const response = await fetch(`${API_BASE}/api/proxy/token/info`, {
                headers: { 'Authorization': `Bearer ${apiKey}` }
            });
            if (!response.ok) {
                throw new Error('API Key æ— æ•ˆæˆ–å·²è¿‡æœŸ');
            }
            return response.json();
        };

        // æŸ¥è¯¢è°ƒç”¨æ—¥å¿—
        const queryLogs = async (apiKey, page = 1) => {
            const response = await fetch(`${API_BASE}/api/proxy/log/self?p=${page - 1}&size=${pageSize}`, {
                headers: { 'Authorization': `Bearer ${apiKey}` }
            });
            if (!response.ok) {
                throw new Error('è·å–æ—¥å¿—å¤±è´¥');
            }
            return response.json();
        };

        // æ¸²æŸ“æ—¥å¿—è¡¨æ ¼
        const renderLogs = (logs, total) => {
            if (!logs || logs.length === 0) {
                logContent.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ“‹</div>
                        <div>æš‚æ— è°ƒç”¨è®°å½•</div>
                    </div>
                `;
                pagination.style.display = 'none';
                return;
            }

            let html = `
                <table class="log-table">
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>æ¨¡å‹</th>
                            <th>æç¤ºè¯</th>
                            <th>ç”Ÿæˆæ•°é‡</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            logs.forEach(log => {
                const promptShort = (log.prompt || 'æ— ').length > 30 
                    ? log.prompt.substring(0, 30) + '...' 
                    : (log.prompt || 'æ— ');
                html += `
                    <tr>
                        <td>${formatTime(log.created_at)}</td>
                        <td><span class="model-tag">${log.model_name || log.model || 'gemini'}</span></td>
                        <td title="${(log.prompt || '').replace(/"/g, '&quot;')}">${promptShort}</td>
                        <td>${log.image_count || 1} å¼ </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            logContent.innerHTML = html;

            // æ¸²æŸ“åˆ†é¡µ
            const totalPages = Math.ceil(total / pageSize);
            if (totalPages > 1) {
                let pageHtml = '';
                pageHtml += `<button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">ä¸Šä¸€é¡µ</button>`;
                
                for (let i = 1; i <= Math.min(totalPages, 5); i++) {
                    pageHtml += `<button class="page-btn ${currentPage === i ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
                }
                
                if (totalPages > 5) {
                    pageHtml += `<span style="padding: 8px;">...</span>`;
                    pageHtml += `<button class="page-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
                }
                
                pageHtml += `<button class="page-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">ä¸‹ä¸€é¡µ</button>`;
                
                pagination.innerHTML = pageHtml;
                pagination.style.display = 'flex';
            } else {
                pagination.style.display = 'none';
            }
        };

        // è·³è½¬é¡µé¢
        window.goToPage = async (page) => {
            if (page < 1 || !currentApiKey) return;
            currentPage = page;
            
            logContent.innerHTML = '<div class="loading">åŠ è½½ä¸­</div>';
            
            try {
                const logData = await queryLogs(currentApiKey, page);
                renderLogs(logData.data, logData.total || 0);
            } catch (e) {
                showError(e.message);
            }
        };

        // ä¸»æŸ¥è¯¢å‡½æ•°
        const doQuery = async () => {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                showError('è¯·è¾“å…¥ API Key');
                return;
            }

            queryBtn.disabled = true;
            queryBtn.textContent = 'æŸ¥è¯¢ä¸­...';
            currentApiKey = apiKey;
            currentPage = 1;

            try {
                // ä¿å­˜åˆ°ç¼“å­˜
                localStorage.setItem('duu_usage_apikey', apiKey);

                // æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
                const userInfo = await queryUserInfo(apiKey);
                
                if (!userInfo.success) {
                    throw new Error(userInfo.message || 'API Key æ— æ•ˆ');
                }

                const user = userInfo.data;
                
                // æ›´æ–°ç»Ÿè®¡å¡ç‰‡ï¼ˆKIE creditsï¼‰
                const credit = user.credit ?? user.credits ?? user.balance ?? user.quota;
                const used = user.used ?? user.usedCredit ?? user.used_credits ?? user.used_quota;
                document.getElementById('balanceValue').innerHTML = `${formatCredit(credit)}<span class="stat-unit">credits</span>`;
                document.getElementById('usedValue').innerHTML = `${formatCredit(used)}<span class="stat-unit">credits</span>`;
                
                // æŸ¥è¯¢æ—¥å¿—ï¼ˆä»å°åŠ©æ‰‹æœ¬åœ°æ•°æ®åº“ï¼‰
                const logData = await queryLogs(apiKey, 1);
                
                // è¯·æ±‚æ¬¡æ•°ä»æœ¬åœ°æ—¥å¿—è·å–
                document.getElementById('requestCount').innerHTML = `${logData.total || 0}<span class="stat-unit">æ¬¡</span>`;
                
                // è®¡ç®—ä»Šæ—¥è¯·æ±‚æ•°
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayTimestamp = Math.floor(today.getTime() / 1000);
                const todayLogs = (logData.data || []).filter(log => log.created_at >= todayTimestamp);
                document.getElementById('todayCount').innerHTML = `${todayLogs.length}<span class="stat-unit">æ¬¡</span>`;

                renderLogs(logData.data, logData.total || 0);
                
                statsSection.style.display = 'block';
                showSuccess('æŸ¥è¯¢æˆåŠŸ');

            } catch (e) {
                showError(e.message);
                statsSection.style.display = 'none';
            } finally {
                queryBtn.disabled = false;
                queryBtn.textContent = 'æŸ¥è¯¢';
            }
        };

        // ç»‘å®šäº‹ä»¶
        queryBtn.addEventListener('click', doQuery);
        apiKeyInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') doQuery();
        });
        refreshBtn.addEventListener('click', () => goToPage(currentPage));

        // å¦‚æœæœ‰ç¼“å­˜çš„ Keyï¼Œè‡ªåŠ¨æŸ¥è¯¢
        if (cachedKey) {
            doQuery();
        }
    </script>
</body>
</html>
