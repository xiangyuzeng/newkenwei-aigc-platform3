<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯çµå›¾ç”Ÿè§†é¢‘</title>
    <link rel="stylesheet" href="../styles/workspace.css">
    <link rel="stylesheet" href="../styles/mobile.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif; background: #f5f7fa; min-height: 100vh; color: #1e293b; }

        .top-header { background: #fff; padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; position: fixed; top: 0; left: 0; right: 0; z-index: 100; height: 56px; }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .header-btn { display: flex; align-items: center; gap: 6px; padding: 8px 16px; background: #f8f9fb; border: 1px solid #e8ecf1; border-radius: 8px; font-size: 13px; color: #475569; cursor: pointer; transition: all 0.2s; text-decoration: none; }
        .header-btn:hover { background: #f0f2f5; border-color: #d1d5db; }
        .page-title { font-size: 20px; font-weight: 600; background: linear-gradient(135deg, #10b981 0%, #34d399 100%); -webkit-background-clip: text; background-clip: text; color: transparent; }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .header-icon-btn { width: 36px; height: 36px; border-radius: 8px; border: 1px solid #e8ecf1; background: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; color: #64748b; }

        .tab-nav { background: #fff; padding: 0 24px; border-bottom: 1px solid #e8ecf1; position: fixed; top: 56px; left: 0; right: 0; z-index: 99; height: 48px; display: flex; align-items: center; gap: 8px; }
        .tab-item { padding: 8px 20px; font-size: 14px; color: #64748b; border-radius: 6px; cursor: pointer; transition: all 0.2s; text-decoration: none; }
        .tab-item:hover { background: #f5f7fa; color: #475569; }
        .tab-item.active { background: linear-gradient(135deg, #10b981 0%, #34d399 100%); color: #fff; font-weight: 500; }

        .main-content { margin-top: 104px; padding: 24px; display: grid; grid-template-columns: 1fr 1fr; gap: 24px; max-width: 1400px; margin-left: auto; margin-right: auto; }
        .left-panel, .right-panel { display: flex; flex-direction: column; gap: 20px; }
        .panel-section { background: #fff; border-radius: 12px; padding: 20px; border: 1px solid #e8ecf1; }
        .section-title { font-size: 15px; font-weight: 600; color: #1e293b; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        @keyframes redBlink { 0%, 100% { color: #ef4444; } 50% { color: #fca5a5; } }
        .red-blink { animation: redBlink 1s infinite; }
</style>
</head>
<body>
    <header class="top-header">
        <span class="page-title">å¯çµå›¾ç”Ÿè§†é¢‘</span>
        <div class="header-right"><button class="header-icon-btn" onclick="location.reload()">ğŸ”„</button></div>
    </header>
    <nav class="tab-nav">
        <a href="klwssp.html" class="tab-item">æ–‡ç”Ÿè§†é¢‘</a>
        <a href="kltssp.html" class="tab-item active">å›¾ç”Ÿè§†é¢‘</a>
    </nav>
    <main class="main-content">
        <div class="left-panel" id="left-panel"></div>
        <div class="right-panel" id="right-panel"></div>
    </main>
    <script src="../scripts/duu-db.js"></script>
    <script src="../scripts/apikeys.js"></script>
    <script src="../scripts/auth.js"></script>
    <script src="../scripts/image-server.js"></script>
    <script src="../scripts/batch-processor.js"></script>
    <script>
        const PAGE_KEY = 'kling-image2video';
        const API_BASE = '';
        
        // åŠ¨æ€ç”Ÿæˆé¡µé¢å†…å®¹
        document.getElementById('left-panel').innerHTML = `
            <div class="panel-section">
                <h2 class="section-title">ğŸ”‘ APIKeyå¡«å†™åŒº</h2>
                <input type="password" id="credential" class="credential-input" placeholder="ç²˜è´´å¯çµè®¿é—®å‡­è¯" autocomplete="off">
                <p class="helper">å¡«å†™DUUè°ƒç”¨ç«™çš„APIKeyï¼Œ<span class="red-blink">ç›®å‰å¯çµåªæ”¯æŒdefaultåˆ†ç»„</span></p>
                <p class="helper warning-blink">âš ï¸ å¯çµè¾ƒè´µï¼Œéœ€è¦é…Œæƒ…ä½¿ç”¨ï¼</p>
            </div>
            <div class="panel-section">
                <h2 class="section-title">ğŸ–¼ï¸ ä¸Šä¼ å›¾ç‰‡</h2>
                <div class="upload-zone" id="uploadZone">
                    <div class="upload-icon">ğŸ–¼ï¸</div>
                    <p class="upload-title">ä¸Šä¼ å‚è€ƒå›¾ç‰‡</p>
                    <label class="upload-btn">
                        <input type="file" class="file-input" id="imageFile" accept="image/*">
                        ğŸ“¤ é€‰æ‹©æ–‡ä»¶
                    </label>
                    <p class="upload-hint">æ”¯æŒ JPGã€PNGã€WebPï¼Œæ–‡ä»¶å¤§å° â‰¤ 10MB</p>
                </div>
                <div id="previewContainer" class="preview-container hidden">
                    <img id="previewImage" class="preview-image" alt="é¢„è§ˆ">
                    <button type="button" class="remove-btn" onclick="removeImage()">âœ• ç§»é™¤</button>
                </div>
            </div>
            <div class="panel-section">
                <h2 class="section-title">âœï¸ æç¤ºè¯ï¼ˆå¯é€‰ï¼‰</h2>
                <textarea id="promptInput" class="prompt-textarea" placeholder="æè¿°ä½ å¸Œæœ›å›¾ç‰‡å¦‚ä½•åŠ¨èµ·æ¥..."></textarea>
                <p class="helper">å¯é€‰ï¼Œæè¿°å›¾ç‰‡ä¸­å…ƒç´ çš„è¿åŠ¨æ–¹å¼</p>
                <div style="margin-top: 12px;">
                    <label style="display: flex; align-items: center; gap: 6px; font-size: 13px; color: #475569; cursor: pointer;">
                        <input type="checkbox" id="optimizeToggle" style="accent-color: #10b981;"> å¯ç”¨æç¤ºè¯ä¼˜åŒ–ï¼ˆAIåˆ†æå›¾ç‰‡ç”Ÿæˆè§†é¢‘æç¤ºè¯ï¼‰
                    </label>
                    <p class="helper">å¼€å¯åï¼ŒAIä¼šåˆ†æå›¾ç‰‡å†…å®¹ï¼Œç”Ÿæˆé€‚åˆè§†é¢‘ç”Ÿæˆçš„æç¤ºè¯</p>
                </div>
            </div>
            <div class="panel-section">
                <h2 class="section-title">âš™ï¸ å‚æ•°è®¾ç½®</h2>
                <div style="margin-bottom: 20px;">
                    <p class="param-label">ğŸ¤– æ¨¡å‹é€‰æ‹©</p>
                    <select id="modelSelect" class="model-select">
                        <option value="kling-v2-5-turbo" selected>Kling v2.5 Turboï¼ˆå¿«é€Ÿï¼‰</option>
                        <option value="kling-v1-6">Kling v1.6</option>
                        <option value="kling-v1-5">Kling v1.5</option>
                    </select>
                </div>
                <div style="margin-bottom: 20px;">
                    <p class="param-label">â±ï¸ è§†é¢‘æ—¶é•¿</p>
                    <div class="param-btn-group" id="durationGroup">
                        <button type="button" class="param-btn active" data-value="5">5ç§’</button>
                        <button type="button" class="param-btn" data-value="10">10ç§’</button>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <p class="param-label">ğŸ¬ ç”Ÿæˆæ¨¡å¼</p>
                    <div class="param-btn-group" id="modeGroup">
                        <button type="button" class="param-btn active" data-value="std">æ ‡å‡†æ¨¡å¼</button>
                        <button type="button" class="param-btn" data-value="pro">ä¸“ä¸šæ¨¡å¼</button>
                    </div>
                </div>
                <div>
                    <p class="param-label">ğŸ”¢ æ‰§è¡Œæ¬¡æ•°</p>
                    <div style="display: flex; gap: 8px; margin-top: 6px;">
                        <select id="execCountSelect" class="model-select" style="flex: 1;">
                            <option value="1" selected>1 æ¬¡</option>
                            <option value="10">10 æ¬¡</option>
                            <option value="20">20 æ¬¡</option>
                            <option value="custom">è‡ªå®šä¹‰</option>
                        </select>
                        <input type="number" id="execCountCustom" class="model-select" min="1" max="1000" value="5" style="flex: 1; display: none;" placeholder="è¾“å…¥æ¬¡æ•°">
                    </div>
                    <p class="helper">å¯¹åŒä¸€å¼ å›¾ç‰‡å¹¶å‘æ‰§è¡Œå¤šæ¬¡ç”Ÿæˆï¼Œè¶…è¿‡20æ¬¡è‡ªåŠ¨åˆ†æ‰¹æ‰§è¡Œ</p>
                </div>
            </div>
            <div id="batch-progress-container" style="margin-bottom: 12px;"></div>
            <button type="button" class="submit-btn" id="submitBtn">ğŸ¬ å¼€å§‹ç”Ÿæˆ</button>
            <p id="status" class="status"></p>
        `;

        document.getElementById('right-panel').innerHTML = `
            <div class="panel-section" style="flex: 1;">
                <div class="task-header">
                    <h2 class="section-title" style="margin-bottom: 0;">ä»»åŠ¡å†å²</h2>
                </div>
                <p class="task-desc">ç”Ÿæˆè§†é¢‘å¤§çº¦éœ€è¦1-3åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…</p>
                <p id="history-empty" class="history-empty">æš‚æ— ä»»åŠ¡è®°å½•</p>
                <div id="task-history-list" class="task-list"></div>
            </div>
        `;

        // æ·»åŠ é¢å¤–æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
            .credential-input { width: 100%; padding: 10px 14px; border: 1px solid #e8ecf1; border-radius: 8px; font-size: 13px; background: #fafbfc; }
            .credential-input:focus { outline: none; border-color: #10b981; background: #fff; }
            .helper { font-size: 12px; color: #94a3b8; margin-top: 8px; line-height: 1.5; }
            .warning-blink { font-size: 14px !important; color: #dc2626 !important; font-weight: 600; animation: blink-warning 1s ease-in-out infinite; background: #fef2f2; padding: 8px 12px; border-radius: 6px; margin-top: 12px !important; }
            @keyframes blink-warning { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
            .upload-zone { border: 2px dashed #d1d5db; border-radius: 12px; padding: 40px 20px; text-align: center; cursor: pointer; transition: all 0.2s; background: #fafbfc; }
            .upload-zone:hover, .upload-zone.dragover { border-color: #10b981; background: #ecfdf5; }
            .upload-icon { width: 48px; height: 48px; background: linear-gradient(135deg, #10b981 0%, #34d399 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; font-size: 24px; }
            .upload-title { font-size: 14px; color: #475569; margin-bottom: 8px; }
            .upload-btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 20px; background: #fff; border: 1px solid #e8ecf1; border-radius: 8px; font-size: 13px; color: #10b981; cursor: pointer; margin: 12px 0; }
            .upload-hint { font-size: 12px; color: #94a3b8; }
            .file-input { display: none; }
            .preview-container { margin-top: 16px; position: relative; display: inline-block; }
            .preview-image { max-width: 100%; max-height: 200px; border-radius: 8px; border: 1px solid #e8ecf1; }
            .remove-btn { position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; background: #ef4444; color: #fff; border: none; border-radius: 50%; cursor: pointer; font-size: 12px; }
            .prompt-textarea { width: 100%; min-height: 80px; padding: 12px 14px; border: 1px solid #e8ecf1; border-radius: 8px; font-size: 13px; background: #fafbfc; resize: vertical; font-family: inherit; }
            .prompt-textarea:focus { outline: none; border-color: #10b981; background: #fff; }
            .param-label { font-size: 13px; color: #475569; margin-bottom: 10px; }
            .param-btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
            .param-btn { padding: 10px 20px; border: 1px solid #e8ecf1; border-radius: 20px; font-size: 13px; color: #475569; background: #fff; cursor: pointer; }
            .param-btn:hover { border-color: #10b981; background: #ecfdf5; }
            .param-btn.active { background: linear-gradient(135deg, #10b981 0%, #34d399 100%); color: #fff; border-color: transparent; }
            .model-select { width: 100%; padding: 10px 14px; border: 1px solid #e8ecf1; border-radius: 8px; font-size: 13px; background: #fff; }
            .submit-btn { width: 100%; padding: 14px 24px; background: linear-gradient(135deg, #10b981 0%, #34d399 100%); color: #fff; border: none; border-radius: 10px; font-size: 15px; font-weight: 500; cursor: pointer; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
            .submit-btn:hover:not(:disabled) { transform: translateY(-2px); }
            .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; }
            .status { font-size: 13px; padding: 10px 14px; border-radius: 8px; margin-top: 12px; }
            .status:empty { display: none; }
            .status.success { background: #ecfdf5; color: #059669; }
            .status.error { background: #fef2f2; color: #dc2626; }
            .status.info { background: #ecfdf5; color: #059669; }
            .task-desc { font-size: 13px; color: #64748b; margin-bottom: 16px; }
            .task-list { display: flex; flex-direction: column; gap: 12px; max-height: 600px; overflow-y: auto; }
            .history-empty { text-align: center; color: #94a3b8; font-size: 13px; padding: 40px 20px; }
            .history-item { background: #f8f9fb; border: 1px solid #e8ecf1; border-radius: 10px; padding: 16px; }
            .history-item header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
            .history-meta { display: flex; flex-direction: column; gap: 4px; font-size: 12px; color: #64748b; }
            .history-meta strong { color: #1e293b; font-size: 13px; }
            .history-status { padding: 4px 10px; border-radius: 12px; font-size: 12px; }
            .history-status.pending { background: #fef3c7; color: #92400e; }
            .history-status.processing { background: #dbeafe; color: #1d4ed8; }
            .history-status.completed { background: #d1fae5; color: #065f46; }
            .history-status.failed { background: #fee2e2; color: #991b1b; }
            .history-video video { width: 100%; max-height: 200px; border-radius: 8px; background: #000; margin-top: 12px; }
            .history-actions { display: flex; gap: 8px; margin-top: 12px; }
            .history-actions button { padding: 6px 12px; background: #fff; border: 1px solid #e8ecf1; border-radius: 6px; font-size: 12px; color: #475569; cursor: pointer; }
            .history-actions button:hover { border-color: #10b981; color: #10b981; }
            .hidden { display: none !important; }
        `;
        document.head.appendChild(style);

        // ç¼“å­˜ç®¡ç†
        const pageCache = new CacheManager('kling-tssp');
        
        // ESC å…³é—­å¼¹çª—ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å…³é—­å¼¹çª—çš„é€»è¾‘
            }
        });

        // çŠ¶æ€å˜é‡
        let selectedDuration = 5;
        let selectedMode = 'std';
        let taskHistory = [];
        let pollingTimers = {};
        let currentFile = null;
        let currentImageBase64 = null;

        const statusEl = document.getElementById('status');
        const promptInput = document.getElementById('promptInput');
        const submitBtn = document.getElementById('submitBtn');
        const modelSelect = document.getElementById('modelSelect');
        const historyList = document.getElementById('task-history-list');
        const historyEmpty = document.getElementById('history-empty');
        const imageFile = document.getElementById('imageFile');
        const uploadZone = document.getElementById('uploadZone');
        const previewContainer = document.getElementById('previewContainer');
        const previewImage = document.getElementById('previewImage');
        const credentialInput = document.getElementById('credential');
        const execCountSelect = document.getElementById('execCountSelect');
        const execCountCustom = document.getElementById('execCountCustom');
        const optimizeToggle = document.getElementById('optimizeToggle');

        // æç¤ºè¯ä¼˜åŒ–å‡½æ•° - ä½¿ç”¨Geminiåˆ†æå›¾ç‰‡ç”Ÿæˆè§†é¢‘æç¤ºè¯
        const optimizePromptForVideo = async (imageBase64, credential, userPrompt = '') => {
            const GEMINI_API = '/v1/chat/completions';
            
            const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è§†é¢‘ç”Ÿæˆæç¤ºè¯ä¸“å®¶ã€‚åˆ†æå›¾ç‰‡å†…å®¹ï¼Œç”Ÿæˆé€‚åˆAIè§†é¢‘ç”Ÿæˆçš„æç¤ºè¯ã€‚

è¦æ±‚ï¼š
1. è¯†åˆ«å›¾ç‰‡ä¸»ä½“ï¼šäººç‰©ã€åŠ¨ç‰©ã€ç‰©ä½“ã€åœºæ™¯
2. åˆ†æé€‚åˆçš„è¿åŠ¨æ–¹å¼ï¼šé•œå¤´ç§»åŠ¨ã€ä¸»ä½“åŠ¨ä½œã€ç¯å¢ƒå˜åŒ–
3. æè¿°åŠ¨æ€æ•ˆæœï¼šé£å¹ã€æ°´æµã€å…‰å½±å˜åŒ–ç­‰
4. ä¿æŒç”»é¢è¿è´¯æ€§å’Œè‡ªç„¶æ„Ÿ

è¾“å‡ºè¦æ±‚ï¼š
- ç›´æ¥è¾“å‡ºæç¤ºè¯ï¼Œä¸è¦ä»»ä½•è§£é‡Šã€å‰ç¼€æˆ–åç¼€
- æç¤ºè¯åº”ç®€æ´æœ‰åŠ›ï¼Œä¸è¶…è¿‡200å­—
- ä½¿ç”¨ä¸­æ–‡æè¿°`;

            const messages = [
                { role: 'system', content: systemPrompt },
                { 
                    role: 'user', 
                    content: [
                        { type: 'text', text: userPrompt ? `ç”¨æˆ·è¡¥å……è¯´æ˜ï¼š${userPrompt}\n\nè¯·åˆ†æè¿™å¼ å›¾ç‰‡ï¼Œç”Ÿæˆè§†é¢‘æç¤ºè¯ï¼š` : 'è¯·åˆ†æè¿™å¼ å›¾ç‰‡ï¼Œç”Ÿæˆè§†é¢‘æç¤ºè¯ï¼š' },
                        { type: 'image_url', image_url: { url: `data:image/jpeg;base64,${imageBase64}` } }
                    ]
                }
            ];

            const response = await fetch(GEMINI_API, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${credential}`
                },
                body: JSON.stringify({
                    model: 'gemini-2.0-flash',
                    messages: messages,
                    max_tokens: 500
                })
            });

            if (!response.ok) {
                throw new Error('æç¤ºè¯ä¼˜åŒ–è¯·æ±‚å¤±è´¥');
            }

            const result = await response.json();
            const optimizedPrompt = result.choices?.[0]?.message?.content?.trim() || '';
            
            // æ¸…ç†å¯èƒ½çš„å‰ç¼€åç¼€
            return optimizedPrompt
                .replace(/^(æç¤ºè¯[ï¼š:]\s*|è§†é¢‘æç¤ºè¯[ï¼š:]\s*|ç”Ÿæˆçš„æç¤ºè¯[ï¼š:]\s*)/i, '')
                .replace(/\n+/g, ' ')
                .trim();
        };

        // æ‰§è¡Œæ¬¡æ•°é€‰æ‹©åˆ‡æ¢
        execCountSelect.addEventListener('change', () => {
            execCountCustom.style.display = execCountSelect.value === 'custom' ? 'block' : 'none';
        });

        // è·å–æ‰§è¡Œæ¬¡æ•°
        const getExecCount = () => {
            if (execCountSelect.value === 'custom') {
                const customValue = parseInt(execCountCustom.value || '1', 10);
                return Math.max(1, Math.min(1000, customValue));
            }
            return parseInt(execCountSelect.value, 10) || 1;
        };

        // API Key ç¼“å­˜
        let apiKeyTimer = null;
        credentialInput.addEventListener('input', (e) => {
            if (apiKeyTimer) clearTimeout(apiKeyTimer);
            apiKeyTimer = setTimeout(() => {
                if (e.target.value.trim()) pageCache.set('apiKey', e.target.value.trim(), { ttl: null });
            }, 500);
        });

        // æç¤ºè¯ç¼“å­˜
        let promptTimer = null;
        promptInput.addEventListener('input', (e) => {
            if (promptTimer) clearTimeout(promptTimer);
            promptTimer = setTimeout(() => {
                pageCache.set('prompt', e.target.value.trim(), { ttl: null });
            }, 500);
        });

        // æ¢å¤ç¼“å­˜
        (async () => {
            try {
                const [apiKey, prompt, model, duration, mode] = await Promise.all([
                    pageCache.get('apiKey'), pageCache.get('prompt'), pageCache.get('model'),
                    pageCache.get('duration'), pageCache.get('mode')
                ]);
                if (apiKey) credentialInput.value = apiKey;
                if (prompt) promptInput.value = prompt;
                if (model) modelSelect.value = model;
                if (duration) {
                    selectedDuration = parseInt(duration);
                    document.querySelectorAll('#durationGroup .param-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.value === duration);
                    });
                }
                if (mode) {
                    selectedMode = mode;
                    document.querySelectorAll('#modeGroup .param-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.value === mode);
                    });
                }
            } catch (e) { console.warn('æ¢å¤ç¼“å­˜å¤±è´¥:', e); }
        })();

        // å‚æ•°æŒ‰é’®ç»„
        const setupParamGroup = (groupId, callback) => {
            const group = document.getElementById(groupId);
            if (!group) return;
            group.querySelectorAll('.param-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    group.querySelectorAll('.param-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    callback(btn.dataset.value);
                    pageCache.set(groupId.replace('Group', ''), btn.dataset.value, { ttl: null });
                });
            });
        };

        setupParamGroup('durationGroup', (val) => { selectedDuration = parseInt(val); });
        setupParamGroup('modeGroup', (val) => { selectedMode = val; });

        const setStatus = (msg, type = '') => {
            statusEl.textContent = msg;
            statusEl.className = type ? `status ${type}` : 'status';
        };

        const formatDate = (date) => {
            const d = new Date(date);
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        };

        const getStatusText = (status) => {
            const map = { pending: 'æ’é˜Ÿä¸­', processing: 'ç”Ÿæˆä¸­', completed: 'å·²å®Œæˆ', failed: 'å¤±è´¥', submitted: 'æ’é˜Ÿä¸­' };
            return map[status] || status || 'æœªçŸ¥';
        };

        // å›¾ç‰‡å¤„ç†
        const readFileAsBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });

        imageFile.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                currentFile = file;
                currentImageBase64 = await readFileAsBase64(file);
                previewImage.src = URL.createObjectURL(file);
                previewContainer.classList.remove('hidden');
                uploadZone.style.display = 'none';
                setStatus('å·²é€‰æ‹©å›¾ç‰‡: ' + file.name, 'success');
            }
        });

        uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
        uploadZone.addEventListener('dragleave', () => { uploadZone.classList.remove('dragover'); });
        uploadZone.addEventListener('drop', async (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                currentFile = file;
                currentImageBase64 = await readFileAsBase64(file);
                previewImage.src = URL.createObjectURL(file);
                previewContainer.classList.remove('hidden');
                uploadZone.style.display = 'none';
                setStatus('å·²é€‰æ‹©å›¾ç‰‡: ' + file.name, 'success');
            }
        });

        window.removeImage = () => {
            currentFile = null;
            currentImageBase64 = null;
            imageFile.value = '';
            previewContainer.classList.add('hidden');
            uploadZone.style.display = 'block';
            setStatus('');
        };

        const renderHistory = () => {
            if (taskHistory.length === 0) {
                historyEmpty.hidden = false;
                historyList.innerHTML = '';
                return;
            }
            historyEmpty.hidden = true;
            historyList.innerHTML = taskHistory.map((task, idx) => {
                const status = task.status || 'pending';
                return `
                <article class="history-item">
                    <header>
                        <div class="history-meta">
                            <strong>${(task.prompt || 'å›¾ç”Ÿè§†é¢‘').substring(0, 30)}${task.prompt?.length > 30 ? '...' : ''}</strong>
                            <span>æ—¶é—´ï¼š${formatDate(task.createdAt)}</span>
                        </div>
                        <span class="history-status ${status}">${getStatusText(status)}</span>
                    </header>
                    ${task.videoUrl ? `<div class="history-video"><video src="${task.videoUrl}" controls></video></div>` : ''}
                    <div class="history-actions">
                        ${status === 'pending' || status === 'processing' ? `<button onclick="refreshTask(${idx})">åˆ·æ–°çŠ¶æ€</button>` : ''}
                        ${task.videoUrl ? `<button onclick="downloadVideo('${task.videoUrl}', '${task.taskId}')">ä¸‹è½½è§†é¢‘</button>` : ''}
                        <button onclick="deleteTask(${idx})">åˆ é™¤</button>
                    </div>
                </article>
            `}).join('');
        };

        window.deleteTask = async (idx) => {
            const task = taskHistory[idx];
            if (task?.taskId && pollingTimers[task.taskId]) {
                clearInterval(pollingTimers[task.taskId]);
            }
            taskHistory.splice(idx, 1);
            renderHistory();
            if (task?.id) await HistoryDB.deleteTask(task.id).catch(console.warn);
        };

        window.downloadVideo = (url, taskId) => {
            const a = document.createElement('a');
            a.href = url;
            a.download = `kling-i2v-${taskId || Date.now()}.mp4`;
            a.target = '_blank';
            a.click();
        };

        window.refreshTask = async (idx) => {
            console.log('åˆ·æ–°ä»»åŠ¡:', idx, taskHistory[idx]);
            const task = taskHistory[idx];
            if (!task) { 
                setStatus('ä»»åŠ¡ä¸å­˜åœ¨', 'error'); 
                return; 
            }
            if (!task.taskId) { 
                setStatus('ä»»åŠ¡IDä¸å­˜åœ¨ï¼Œæ— æ³•åˆ·æ–°', 'error'); 
                console.log('ä»»åŠ¡æ•°æ®:', task);
                return; 
            }
            const credential = document.getElementById('credential').value.trim();
            if (!credential) { setStatus('è¯·å¡«å†™APIKey', 'error'); return; }
            setStatus('æ­£åœ¨åˆ·æ–°çŠ¶æ€...', 'info');
            startPolling(task.taskId, credential);
        };

        const startPolling = (taskId, credential) => {
            if (pollingTimers[taskId]) clearInterval(pollingTimers[taskId]);
            const poll = async () => {
                try {
                    const response = await fetch(`${API_BASE}/kling/v1/videos/image2video/${taskId}`, {
                        headers: { 'Authorization': `Bearer ${credential}`, 'Accept': 'application/json' }
                    });
                    const result = await response.json();
                    console.log('è½®è¯¢ç»“æœ:', taskId, result);
                    
                    const data = result.data || result;
                    const task = taskHistory.find(t => t.taskId === taskId);
                    if (!task) { clearInterval(pollingTimers[taskId]); return; }
                    
                    // å…¼å®¹å¤šç§çŠ¶æ€å­—æ®µ
                    const status = data.task_status || data.status;
                    console.log('ä»»åŠ¡çŠ¶æ€:', status);
                    
                    if (status === 'succeed' || status === 'completed' || status === 'success') {
                        task.status = 'completed';
                        // å…¼å®¹å¤šç§è§†é¢‘URLè·¯å¾„
                        task.videoUrl = data.task_result?.videos?.[0]?.url 
                            || data.task_result?.images?.[0]?.url
                            || data.videos?.[0]?.url
                            || data.video_url
                            || data.url;
                        clearInterval(pollingTimers[taskId]);
                        delete pollingTimers[taskId];
                        setStatus('è§†é¢‘ç”Ÿæˆå®Œæˆï¼', 'success');
                        
                        // ä¿å­˜åˆ°äº‘ç«¯ï¼ˆç™»å½•ç”¨æˆ·ï¼‰
                        if (task.videoUrl) {
                            try {
                                await ImageServer.saveGeneration(
                                    document.getElementById('credential').value.trim(),
                                    task.prompt,
                                    [{ url: task.videoUrl }],
                                    'kling-image2video',
                                    'image'
                                );
                                console.log('è§†é¢‘å·²ä¿å­˜åˆ°äº‘ç«¯');
                            } catch (e) {
                                console.warn('ä¿å­˜åˆ°äº‘ç«¯å¤±è´¥:', e);
                            }
                        }
                    } else if (status === 'failed' || status === 'error') {
                        task.status = 'failed';
                        clearInterval(pollingTimers[taskId]);
                        delete pollingTimers[taskId];
                        setStatus(`ç”Ÿæˆå¤±è´¥: ${data.task_status_msg || data.message || ''}`, 'error');
                    } else if (status === 'processing' || status === 'running') {
                        task.status = 'processing';
                    } else if (status === 'submitted' || status === 'pending' || status === 'queued') {
                        task.status = 'pending';
                    }
                    renderHistory();
                    HistoryDB.saveTask(PAGE_KEY, task).catch(console.warn);
                } catch (e) { console.warn('è½®è¯¢å¤±è´¥:', e); }
            };
            poll();
            pollingTimers[taskId] = setInterval(poll, 10000);
        };

        submitBtn.addEventListener('click', async () => {
            const credential = document.getElementById('credential').value.trim();
            if (!credential) { setStatus('è¯·å¡«å†™APIKey', 'error'); return; }
            if (!currentImageBase64) { setStatus('è¯·ä¸Šä¼ å›¾ç‰‡', 'error'); return; }

            const execCount = getExecCount();
            const enableOptimize = optimizeToggle.checked;
            const userPrompt = promptInput.value.trim();
            submitBtn.disabled = true;

            // å¦‚æœå¯ç”¨ä¼˜åŒ–ï¼Œå…ˆè·å–ä¼˜åŒ–åçš„æç¤ºè¯
            let finalPrompt = userPrompt;
            if (enableOptimize && currentImageBase64) {
                setStatus('æ­£åœ¨åˆ†æå›¾ç‰‡ï¼Œä¼˜åŒ–æç¤ºè¯ä¸­...', 'info');
                try {
                    finalPrompt = await optimizePromptForVideo(currentImageBase64, credential, userPrompt);
                    setStatus(`æç¤ºè¯ä¼˜åŒ–å®Œæˆ: ${finalPrompt.substring(0, 50)}...`, 'success');
                } catch (e) {
                    console.warn('æç¤ºè¯ä¼˜åŒ–å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æç¤ºè¯:', e);
                    setStatus('æç¤ºè¯ä¼˜åŒ–å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æç¤ºè¯', 'warning');
                }
            }

            if (execCount > 1) {
                // å¤šæ¬¡æ‰§è¡Œæ¨¡å¼ - å¹¶å‘å¤„ç†ï¼Œæœ€å¤§20å¹¶å‘
                const progressBar = new ProgressBar('batch-progress-container');
                progressBar.show();
                progressBar.reset();

                const tasks = [];
                for (let i = 0; i < execCount; i++) {
                    tasks.push({
                        fileName: `ä»»åŠ¡ ${i + 1}`,
                        execIndex: i,
                        execute: async () => {
                            const body = {
                                model_name: modelSelect.value,
                                image: currentImageBase64,
                                prompt: finalPrompt || undefined,
                                duration: String(selectedDuration),
                                mode: selectedMode
                            };

                            const response = await fetch(`${API_BASE}/kling/v1/videos/image2video`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${credential}` },
                                body: JSON.stringify(body)
                            });

                            const result = await response.json();
                            if (!response.ok) {
                                const errMsg = typeof result.message === 'string' ? result.message 
                                    : (typeof result.error === 'string' ? result.error 
                                    : JSON.stringify(result.message || result.error || result));
                                throw new Error(errMsg || 'è¯·æ±‚å¤±è´¥');
                            }

                            const taskId = result.data?.task_id || result.task_id;
                            if (!taskId) throw new Error('æœªè·å–åˆ°ä»»åŠ¡ID');

                            return { taskId, result };
                        }
                    });
                }

                // æ”¶é›†å¤±è´¥ä¿¡æ¯
                const failedItems = [];
                
                // é‡è¯•å¤±è´¥é¡¹
                const retryFailedItems = async (items) => {
                    if (items.length === 0) return;
                    progressBar.reset();
                    progressBar.show();
                    failedItems.length = 0;
                    
                    const retryTasks = items.map((item, idx) => ({
                        fileName: item.fileName,
                        execute: async () => {
                            const body = {
                                model_name: modelSelect.value,
                                image: currentImageBase64,
                                prompt: finalPrompt || undefined,
                                duration: String(selectedDuration),
                                mode: selectedMode
                            };
                            const response = await fetch(`${API_BASE}/kling/v1/videos/image2video`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${credential}` },
                                body: JSON.stringify(body)
                            });
                            const result = await response.json();
                            if (!response.ok) {
                                const errMsg = typeof result.message === 'string' ? result.message 
                                    : (typeof result.error === 'string' ? result.error 
                                    : JSON.stringify(result.message || result.error || result));
                                throw new Error(errMsg || 'è¯·æ±‚å¤±è´¥');
                            }
                            const taskId = result.data?.task_id || result.task_id;
                            if (!taskId) throw new Error('æœªè·å–åˆ°ä»»åŠ¡ID');
                            return { taskId, result };
                        }
                    }));
                    
                    const retryProcessor = new BatchProcessor({
                        maxConcurrent: 20,
                        onProgress: (progress) => {
                            progressBar.update(progress);
                            setStatus(`é‡è¯•ä¸­: ${progress.completed}/${progress.total}`, 'info');
                        },
                        onTaskComplete: ({ index, success, result }) => {
                            if (success && result?.taskId) {
                                const task = {
                                    id: `task-${Date.now()}-retry-${index}`,
                                    taskId: result.taskId,
                                    prompt: finalPrompt,
                                    status: 'pending',
                                    videoUrl: null,
                                    createdAt: Date.now()
                                };
                                taskHistory.unshift(task);
                                renderHistory();
                                HistoryDB.saveTask(PAGE_KEY, task).catch(console.warn);
                                startPolling(result.taskId, credential);
                            }
                        },
                        onComplete: (summary) => {
                            progressBar.complete(summary, failedItems);
                            if (summary.failed === 0) {
                                setStatus(`é‡è¯•å®Œæˆï¼Œå…¨éƒ¨æˆåŠŸï¼`, 'success');
                            } else {
                                setStatus(`é‡è¯•ç»“æŸï¼ŒæˆåŠŸ ${summary.succeeded} ä¸ªï¼Œä»æœ‰ ${summary.failed} ä¸ªå¤±è´¥ã€‚`, 'warning');
                            }
                        },
                        onError: ({ index, error }) => {
                            const errMsg = error?.message || error?.toString() || 'è¯·æ±‚å¤±è´¥';
                            failedItems.push({ fileName: `é‡è¯•ä»»åŠ¡ ${index + 1}`, error: errMsg.length > 30 ? errMsg.substring(0, 30) + '...' : errMsg });
                        }
                    });
                    await retryProcessor.process(retryTasks);
                };
                
                progressBar.onRetry = retryFailedItems;
                
                const batchProcessor = new BatchProcessor({
                    maxConcurrent: 20,
                    onProgress: (progress) => {
                        progressBar.update(progress);
                        setStatus(`æ­£åœ¨å¤„ç†: ${progress.completed}/${progress.total}`, 'info');
                    },
                    onTaskComplete: ({ index, success, result, error }) => {
                        if (success && result?.taskId) {
                            const task = {
                                id: `task-${Date.now()}-${index}`,
                                taskId: result.taskId,
                                prompt: finalPrompt,
                                status: 'pending',
                                videoUrl: null,
                                createdAt: Date.now()
                            };
                            taskHistory.unshift(task);
                            renderHistory();
                            HistoryDB.saveTask(PAGE_KEY, task).catch(console.warn);
                            startPolling(result.taskId, credential);
                        }
                    },
                    onComplete: (summary) => {
                        progressBar.complete(summary, failedItems);
                        setStatus(`æ‰¹é‡æäº¤å®Œæˆï¼æˆåŠŸ ${summary.succeeded} ä¸ªï¼Œå¤±è´¥ ${summary.failed} ä¸ª`, summary.failed > 0 ? 'warning' : 'success');
                        submitBtn.disabled = false;
                    },
                    onError: ({ index, error }) => {
                        console.warn(`ä»»åŠ¡ ${index + 1} å¤±è´¥:`, error);
                        const errMsg = error?.message || error?.toString() || 'è¯·æ±‚å¤±è´¥';
                        failedItems.push({ fileName: `ä»»åŠ¡ ${index + 1}`, error: errMsg.length > 30 ? errMsg.substring(0, 30) + '...' : errMsg });
                    }
                });

                await batchProcessor.process(tasks);
            } else {
                // å•æ¬¡æ‰§è¡Œæ¨¡å¼
                setStatus('æ­£åœ¨æäº¤ä»»åŠ¡...', 'info');

                try {
                    const body = {
                        model_name: modelSelect.value,
                        image: currentImageBase64,
                        prompt: finalPrompt || undefined,
                        duration: String(selectedDuration),
                        mode: selectedMode
                    };

                    const response = await fetch(`${API_BASE}/kling/v1/videos/image2video`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${credential}` },
                        body: JSON.stringify(body)
                    });

                    const result = await response.json();
                    if (!response.ok) {
                        const errMsg = typeof result.message === 'string' ? result.message 
                            : (typeof result.error === 'string' ? result.error 
                            : JSON.stringify(result.message || result.error || result));
                        throw new Error(errMsg || 'è¯·æ±‚å¤±è´¥');
                    }

                    const taskId = result.data?.task_id || result.task_id;
                    if (!taskId) throw new Error('æœªè·å–åˆ°ä»»åŠ¡ID');

                    const task = {
                        id: `task-${Date.now()}`,
                        taskId, prompt: finalPrompt,
                        status: 'pending', videoUrl: null, createdAt: Date.now()
                    };
                    taskHistory.unshift(task);
                    renderHistory();
                    HistoryDB.saveTask(PAGE_KEY, task).catch(console.warn);
                    setStatus(`ä»»åŠ¡å·²æäº¤ï¼ŒID: ${taskId}`, 'success');
                    startPolling(taskId, credential);
                } catch (e) {
                    const errMsg = typeof e === 'string' ? e : (e.message || JSON.stringify(e));
                    setStatus(`æäº¤å¤±è´¥: ${errMsg}`, 'error');
                } finally {
                    submitBtn.disabled = false;
                }
            }
        });

        // åŠ è½½å†å²å¹¶æ¢å¤æœªå®Œæˆä»»åŠ¡çš„è½®è¯¢
        (async () => {
            const tasks = await HistoryDB.getTasks(PAGE_KEY).catch(() => []);
            if (tasks?.length) {
                taskHistory = tasks;
                renderHistory();
                
                // æ¢å¤æœªå®Œæˆä»»åŠ¡çš„è½®è¯¢
                const credential = credentialInput.value.trim();
                if (credential) {
                    tasks.forEach(task => {
                        const status = task.status || 'pending';
                        if ((status === 'pending' || status === 'processing') && task.taskId) {
                            startPolling(task.taskId, credential);
                        }
                    });
                }
            }
        })();

        if (window.initApiKeyInput) window.initApiKeyInput('kling', 'credential');
    </script>
</body>
</html>
