<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soraå›¾ç”Ÿè§†é¢‘</title>
    <link rel="stylesheet" href="../styles/workspace.css">
    <link rel="stylesheet" href="../styles/mobile.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif; background: #f5f7fa; min-height: 100vh; color: #1e293b; }

        .top-header { background: #fff; padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; position: fixed; top: 0; left: 0; right: 0; z-index: 100; height: 56px; }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .header-btn { display: flex; align-items: center; gap: 6px; padding: 8px 16px; background: #f8f9fb; border: 1px solid #e8ecf1; border-radius: 8px; font-size: 13px; color: #475569; cursor: pointer; transition: all 0.2s; text-decoration: none; }
        .header-btn:hover { background: #f0f2f5; border-color: #d1d5db; }
        .page-title { font-size: 20px; font-weight: 600; background: linear-gradient(135deg, #f97316 0%, #fb923c 100%); -webkit-background-clip: text; background-clip: text; color: transparent; }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .header-icon-btn { width: 36px; height: 36px; border-radius: 8px; border: 1px solid #e8ecf1; background: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; color: #64748b; }

        .tab-nav { background: #fff; padding: 0 24px; border-bottom: 1px solid #e8ecf1; position: fixed; top: 56px; left: 0; right: 0; z-index: 99; height: 48px; display: flex; align-items: center; gap: 8px; }
        .tab-item { padding: 8px 20px; font-size: 14px; color: #64748b; border-radius: 6px; cursor: pointer; transition: all 0.2s; text-decoration: none; }
        .tab-item:hover { background: #f5f7fa; color: #475569; }
        .tab-item.active { background: linear-gradient(135deg, #f97316 0%, #fb923c 100%); color: #fff; font-weight: 500; }

        .main-content { margin-top: 104px; padding: 24px; display: grid; grid-template-columns: 1fr 1fr; gap: 24px; max-width: 1400px; margin-left: auto; margin-right: auto; }
        .left-panel, .right-panel { display: flex; flex-direction: column; gap: 20px; }
        .panel-section { background: #fff; border-radius: 12px; padding: 20px; border: 1px solid #e8ecf1; }
        .section-title { font-size: 15px; font-weight: 600; color: #1e293b; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }

        .upload-zone { border: 2px dashed #d1d5db; border-radius: 12px; padding: 40px 20px; text-align: center; cursor: pointer; transition: all 0.2s; background: #fafbfc; }
        .upload-zone:hover, .upload-zone.dragover { border-color: #f97316; background: #fff7ed; }
        .upload-zone.has-image { border-style: solid; border-color: #f97316; }
        .upload-icon { width: 48px; height: 48px; background: linear-gradient(135deg, #f97316 0%, #fb923c 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; font-size: 24px; }
        .upload-title { font-size: 14px; color: #475569; margin-bottom: 8px; }
        .upload-btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 20px; background: #fff; border: 1px solid #e8ecf1; border-radius: 8px; font-size: 13px; color: #f97316; cursor: pointer; margin: 12px 0; }
        .upload-hint { font-size: 12px; color: #94a3b8; line-height: 1.6; }

        .image-preview { margin-top: 12px; position: relative; display: inline-block; }
        .image-preview img { max-width: 100%; max-height: 200px; border-radius: 8px; border: 1px solid #e8ecf1; }
        .image-preview .remove-btn { position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; background: #ef4444; color: #fff; border: none; border-radius: 50%; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; }

        .credential-input { width: 100%; padding: 10px 14px; border: 1px solid #e8ecf1; border-radius: 8px; font-size: 13px; background: #fafbfc; }
        .credential-input:focus { outline: none; border-color: #f97316; background: #fff; }
        .helper { font-size: 12px; color: #94a3b8; margin-top: 8px; line-height: 1.5; }

        /* è­¦å‘Šé—ªçƒæ ·å¼ */
        .warning-blink { font-size: 14px !important; color: #dc2626 !important; font-weight: 600; animation: blink-warning 1s ease-in-out infinite; background: #fef2f2; padding: 8px 12px; border-radius: 6px; margin-top: 12px !important; }
        @keyframes blink-warning { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .prompt-wrapper { position: relative; }
        .prompt-textarea { width: 100%; min-height: 100px; padding: 12px 14px; padding-right: 90px; border: 1px solid #e8ecf1; border-radius: 8px; font-size: 13px; background: #fafbfc; resize: vertical; font-family: inherit; }
        .prompt-textarea:focus { outline: none; border-color: #f97316; background: #fff; }
        .optimize-btn { position: absolute; right: 8px; top: 8px; padding: 6px 12px; background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%); color: #fff; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px; transition: all 0.2s; }
        .optimize-btn:hover:not(:disabled) { transform: scale(1.02); box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3); }
        .optimize-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .optimize-btn.loading { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        .param-label { font-size: 13px; color: #475569; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
        .param-btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .param-btn { padding: 10px 20px; border: 1px solid #e8ecf1; border-radius: 20px; font-size: 13px; color: #475569; background: #fff; cursor: pointer; transition: all 0.2s; }
        .param-btn:hover { border-color: #f97316; background: #fff7ed; }
        .param-btn.active { background: linear-gradient(135deg, #f97316 0%, #fb923c 100%); color: #fff; border-color: transparent; }
        .param-btn:disabled { opacity: 0.5; cursor: not-allowed; background: #f1f5f9; border-color: #e2e8f0; color: #94a3b8; }
        .param-btn:disabled:hover { background: #f1f5f9; border-color: #e2e8f0; }

        .info-box { display: flex; align-items: flex-start; gap: 8px; padding: 12px 14px; background: #fff7ed; border-radius: 8px; font-size: 12px; color: #c2410c; line-height: 1.6; margin-top: 16px; }
        .info-box.warning { background: #fef3c7; color: #92400e; }

        .submit-btn { width: 100%; padding: 14px 24px; background: linear-gradient(135deg, #f97316 0%, #fb923c 100%); color: #fff; border: none; border-radius: 10px; font-size: 15px; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3); }
        .submit-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(249, 115, 22, 0.4); }
        .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        .status { font-size: 13px; padding: 10px 14px; border-radius: 8px; margin-top: 12px; }
        .status:empty { display: none; }
        .status.success { background: #ecfdf5; color: #059669; }
        .status.error { background: #fef2f2; color: #dc2626; }
        .status.info { background: #eff6ff; color: #2563eb; }

        .task-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .task-desc { font-size: 13px; color: #64748b; margin-bottom: 16px; }
        .task-list { display: flex; flex-direction: column; gap: 12px; max-height: 600px; overflow-y: auto; }
        .history-empty { text-align: center; color: #94a3b8; font-size: 13px; padding: 40px 20px; }

        .history-item { background: #f8f9fb; border: 1px solid #e8ecf1; border-radius: 10px; padding: 16px; }
        .history-item header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .history-meta { display: flex; flex-direction: column; gap: 4px; font-size: 12px; color: #64748b; }
        .history-meta strong { color: #1e293b; font-size: 13px; display: block; margin-bottom: 4px; max-width: 280px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .history-status { padding: 4px 10px; border-radius: 12px; font-size: 12px; white-space: nowrap; }
        .history-status.pending { background: #fef3c7; color: #92400e; }
        .history-status.completed { background: #d1fae5; color: #065f46; }
        .history-status.failed { background: #fee2e2; color: #991b1b; }
        .history-video { margin-top: 12px; }
        .history-video video { width: 100%; max-height: 200px; border-radius: 8px; background: #000; }
        .history-actions { display: flex; gap: 8px; margin-top: 12px; }
        .history-actions button { padding: 6px 12px; background: #fff; border: 1px solid #e8ecf1; border-radius: 6px; font-size: 12px; color: #475569; cursor: pointer; transition: all 0.2s; }
        .history-actions button:hover:not(:disabled) { border-color: #f97316; color: #f97316; }
        .history-actions button:disabled { opacity: 0.5; cursor: not-allowed; }
        .history-actions button.delete-btn { color: #ef4444; }
        .history-actions button.delete-btn:hover:not(:disabled) { border-color: #ef4444; background: #fef2f2; }

        .hidden { display: none !important; }
        .file-input { display: none; }

        /* è§’è‰²é€‰æ‹©æŒ‰é’® */
        .character-select-btn { padding: 6px 14px; background: #fff7ed; border: 1px solid #f97316; border-radius: 6px; font-size: 12px; color: #c2410c; cursor: pointer; transition: all 0.2s; }
        .character-select-btn:hover { background: #ffedd5; }

        /* è§’è‰²é€‰æ‹©å¼¹çª— */
        .character-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .character-modal.active { display: flex; }
        .character-modal-content { background: #fff; border-radius: 12px; width: 100%; max-width: 480px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column; }
        .character-modal-header { padding: 16px 20px; border-bottom: 1px solid #e8ecf1; display: flex; align-items: center; justify-content: space-between; }
        .character-modal-header h3 { font-size: 16px; color: #1e293b; }
        .character-modal-close { width: 32px; height: 32px; border: none; background: #f8f9fb; border-radius: 6px; cursor: pointer; font-size: 18px; color: #64748b; }
        .character-modal-close:hover { background: #f0f2f5; }
        .character-modal-body { padding: 16px 20px; overflow-y: auto; flex: 1; }
        .character-modal-empty { text-align: center; color: #94a3b8; font-size: 13px; padding: 40px 20px; }
        .character-modal-item { display: flex; gap: 12px; padding: 12px; background: #f8f9fb; border: 1px solid #e8ecf1; border-radius: 8px; cursor: pointer; transition: all 0.2s; margin-bottom: 8px; }
        .character-modal-item:hover { border-color: #f97316; background: #fff7ed; }
        .character-modal-item:last-child { margin-bottom: 0; }
        .character-modal-avatar { width: 48px; height: 48px; border-radius: 6px; object-fit: cover; background: #e8ecf1; flex-shrink: 0; }
        .character-modal-info { flex: 1; min-width: 0; }
        .character-modal-name { font-size: 14px; font-weight: 500; color: #1e293b; margin-bottom: 2px; }
        .character-modal-username { font-size: 12px; color: #f97316; font-family: monospace; }

        @media (max-width: 1024px) { .main-content { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .tab-nav { overflow-x: auto; padding: 0 16px; } .main-content { padding: 16px; } }
    </style>
</head>
<body>
    <header class="top-header">
        <div class="header-left">
        </div>
        <span class="page-title">Soraå›¾ç”Ÿè§†é¢‘</span>
        <div class="header-right">
            <button class="header-icon-btn" onclick="location.reload()">ğŸ”„</button>
        </div>
    </header>

    <nav class="tab-nav">
        <a href="sorawssp.html" class="tab-item">æ–‡ç”Ÿè§†é¢‘</a>
        <a href="sorotssp.html" class="tab-item active">å›¾ç”Ÿè§†é¢‘</a>
        <a href="piliang-tssp.html" class="tab-item">æ‰¹é‡å›¾ç”Ÿ</a>
        <a href="soracjjs.html" class="tab-item">åˆ›å»ºè§’è‰²</a>
    </nav>

    <main class="main-content">
        <div class="left-panel">
            <div class="panel-section">
                <h2 class="section-title">ğŸ”‘ APIKeyå¡«å†™åŒº</h2>
                <div style="margin-bottom: 12px;">
                    <label class="helper" style="margin-bottom: 6px; display: block;">Sora APIKey</label>
                    <input type="password" id="credential" class="credential-input" placeholder="ç²˜è´´Soraè®¿é—®å‡­è¯" autocomplete="off">
                    <p class="helper">å¡«å†™DUUè°ƒç”¨ç«™çš„APIkeyï¼Œå»ºè®®é™æ—¶ç‰¹ä»·åˆ†ç»„ã€defaultåˆ†ç»„ã€é€†å‘åˆ†ç»„</p>
                    <p class="helper warning-blink">âš ï¸ Soraå®˜æ–¹ä¸¥ç¦å‡ºç°çœŸäººè§†é¢‘ã€è§’è‰²ï¼Œä¸Šä¼ æ—¶è¯·æ³¨æ„è‡ªè¡Œè§„é¿ï¼</p>
                </div>
                <div>
                    <label class="helper" style="margin-bottom: 6px; display: block;">Gemini APIKeyï¼ˆç”¨äºAIæ¶¦è‰²ï¼‰</label>
                    <input type="password" id="geminiKey" class="credential-input" placeholder="ç²˜è´´Geminiè®¿é—®å‡­è¯" autocomplete="off">
                    <p class="helper">å¡«å†™DUUè°ƒç”¨ç«™çš„APIkeyï¼Œå»ºè®®åˆ›å»ºapikeyåˆ†ç»„ä¸ºé™æ—¶ç‰¹ä»·ã€ä¼˜è´¨geminiã€å®˜è½¬gemini</p>
                </div>
            </div>

            <div class="panel-section">
                <h2 class="section-title">ğŸ–¼ï¸ ä¸Šä¼ å‚è€ƒå›¾ç‰‡</h2>
                <div class="upload-zone" id="uploadZone">
                    <div class="upload-icon">ğŸ“·</div>
                    <p class="upload-title">ä¸Šä¼ å‚è€ƒå›¾ç‰‡</p>
                    <p class="upload-hint">æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                    <label class="upload-btn">
                        <input type="file" class="file-input" id="imageFile" accept="image/*">
                        ğŸ“¤ é€‰æ‹©æ–‡ä»¶
                    </label>
                    <p class="upload-hint">æ”¯æŒ JPGã€PNGã€WebPï¼Œæ–‡ä»¶å¤§å° â‰¤ 10MB</p>
                </div>
                <div id="imagePreview" class="image-preview hidden"></div>
                <div class="info-box warning">
                    <span>âš ï¸</span>
                    <span>ä¸æ”¯æŒä¸Šä¼ äººç‰©ç…§ç‰‡ç”Ÿæˆè§†é¢‘</span>
                </div>
            </div>

            <div class="panel-section">
                <h2 class="section-title">âœï¸ æç¤ºè¯</h2>
                <div class="prompt-wrapper">
                    <textarea id="promptInput" class="prompt-textarea" placeholder="æè¿°è§†é¢‘çš„åŠ¨ä½œã€åœºæ™¯ã€é£æ ¼ç­‰ï¼Œä¾‹å¦‚ï¼šè®©ç”»é¢ä¸­çš„å…ƒç´ åŠ¨èµ·æ¥..."></textarea>
                    <button type="button" class="optimize-btn" id="optimizeBtn" title="AIæ™ºèƒ½æ¶¦è‰²æç¤ºè¯">âœ¨ AIæ¶¦è‰²</button>
                </div>
                <div style="display: flex; gap: 8px; margin-top: 8px;">
                    <button type="button" class="character-select-btn" id="characterSelectBtn">ğŸ­ é€‰æ‹©è§’è‰²</button>
                    <span class="helper" style="margin: 0; line-height: 32px;">ç‚¹å‡»æ’å…¥å·²åˆ›å»ºçš„è§’è‰²åˆ°æç¤ºè¯</span>
                </div>
                <p class="helper">ç‚¹å‡»ã€ŒAIæ¶¦è‰²ã€å¯æ ¹æ®å›¾ç‰‡å†…å®¹æ™ºèƒ½ä¼˜åŒ–æç¤ºè¯ï¼Œç”Ÿæˆæ›´ä¸“ä¸šçš„è§†é¢‘æè¿°</p>
            </div>

            <div class="panel-section">
                <h2 class="section-title">âš™ï¸ å‚æ•°è®¾ç½®</h2>
                <div style="margin-bottom: 20px;">
                    <p class="param-label">ğŸ¤– æ¨¡å‹é€‰æ‹©</p>
                    <div class="param-btn-group" id="modelGroup">
                        <button type="button" class="param-btn active" data-value="sora-2-all">Sora-2</button>
                        <button type="button" class="param-btn" data-value="sora-2-pro">Sora-2-Pro</button>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <p class="param-label">ğŸï¸ ç”»è´¨é€‰æ‹©</p>
                    <div class="param-btn-group" id="qualityGroup">
                        <button type="button" class="param-btn active" data-value="720p">720p</button>
                        <button type="button" class="param-btn" data-value="1080p" disabled>1080p (ä»…Pro)</button>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <p class="param-label">ğŸ“ è§†é¢‘æ¯”ä¾‹</p>
                    <div class="param-btn-group" id="sizeGroup">
                        <button type="button" class="param-btn active" data-value="16x9">16:9 æ¨ªå±</button>
                        <button type="button" class="param-btn" data-value="9x16">9:16 ç«–å±</button>
                    </div>
                </div>
                <div>
                    <p class="param-label">â±ï¸ è§†é¢‘æ—¶é•¿</p>
                    <div class="param-btn-group" id="secondsGroup">
                        <button type="button" class="param-btn active" data-value="10">10ç§’</button>
                        <button type="button" class="param-btn" data-value="15">15ç§’</button>
                        <button type="button" class="param-btn" data-value="20">20ç§’</button>
                    </div>
                </div>
                <div class="info-box">
                    <span>â°</span>
                    <span>è§†é¢‘ç”Ÿæˆå¤§çº¦éœ€è¦ 5-10 åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…</span>
                </div>
            </div>

            <button type="button" class="submit-btn" id="submitBtn">ğŸ¬ ç”Ÿæˆè§†é¢‘</button>
            <p id="status" class="status"></p>
        </div>

        <div class="right-panel">
            <div class="panel-section" style="flex: 1;">
                <div class="task-header">
                    <h2 class="section-title" style="margin-bottom: 0;">ğŸ“‹ ä»»åŠ¡å†å²</h2>
                    <div style="display: flex; gap: 8px;">
                        <button class="param-btn" onclick="refreshAllTasks()" style="padding: 6px 12px; font-size: 12px;">ğŸ”„ åˆ·æ–°</button>
                        <button class="param-btn" onclick="clearHistory()" style="padding: 6px 12px; font-size: 12px;">æ¸…ç©º</button>
                    </div>
                </div>
                <p class="task-desc">å±•ç¤ºæœ€è¿‘çš„è§†é¢‘ç”Ÿæˆä»»åŠ¡</p>
                <p id="historyEmpty" class="history-empty">æš‚æ— ä»»åŠ¡è®°å½•</p>
                <div id="taskHistoryList" class="task-list"></div>
            </div>
        </div>
    </main>

    <!-- è§’è‰²é€‰æ‹©å¼¹çª— -->
    <div class="character-modal" id="characterModal">
        <div class="character-modal-content">
            <div class="character-modal-header">
                <h3>ğŸ­ é€‰æ‹©è§’è‰²</h3>
                <button class="character-modal-close" id="characterModalClose">âœ•</button>
            </div>
            <div class="character-modal-body" id="characterModalBody">
                <p class="character-modal-empty">æ­£åœ¨åŠ è½½...</p>
            </div>
        </div>
    </div>

    <script src="../scripts/duu-db.js"></script>
    <script src="../scripts/apikeys.js"></script>
    <script src="../scripts/auth.js"></script>
    <script src="../scripts/image-server.js"></script>
    <script>
        const API_BASE = '';
        const GEMINI_API = (apiKey) => `/v1beta/models/gemini-2.5-flash-lite-nothinking:generateContent?key=${encodeURIComponent(apiKey)}`;
        
        // åˆå§‹åŒ–ç¼“å­˜ç®¡ç†å™¨
        const pageCache = new CacheManager('sora-tssp');

        const credentialInput = document.getElementById('credential');
        const geminiKeyInput = document.getElementById('geminiKey');
        const imageFileInput = document.getElementById('imageFile');
        const uploadZone = document.getElementById('uploadZone');
        const imagePreview = document.getElementById('imagePreview');
        const promptInput = document.getElementById('promptInput');
        const optimizeBtn = document.getElementById('optimizeBtn');
        const submitBtn = document.getElementById('submitBtn');
        const statusEl = document.getElementById('status');
        const taskHistoryList = document.getElementById('taskHistoryList');
        const historyEmpty = document.getElementById('historyEmpty');
        const sizeGroup = document.getElementById('sizeGroup');
        const secondsGroup = document.getElementById('secondsGroup');
        const modelGroup = document.getElementById('modelGroup');
        const qualityGroup = document.getElementById('qualityGroup');

        let selectedFile = null;
        let selectedFileBase64 = null;
        let selectedSize = '16x9';
        let selectedSeconds = '10';
        let selectedModel = 'sora-2-all';
        let selectedQuality = '720p';
        let taskHistory = [];
        let pollingIntervals = {};

        document.addEventListener('DOMContentLoaded', async () => {
            await loadCachedState();
            setupEventListeners();
            if (window.initApiKeyInput) window.initApiKeyInput('sora', 'credential');
        });

        function setupEventListeners() {
            // APIKey ä¿å­˜åˆ°ç¼“å­˜
            credentialInput.addEventListener('input', debounce(async () => {
                await pageCache.set('soraApiKey', credentialInput.value, { ttl: null });
            }, 500));
            geminiKeyInput.addEventListener('input', debounce(async () => {
                await pageCache.set('geminiApiKey', geminiKeyInput.value, { ttl: null });
            }, 500));

            imageFileInput.addEventListener('change', handleFileSelect);
            uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
            uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
            uploadZone.addEventListener('drop', handleDrop);

            sizeGroup.addEventListener('click', async (e) => {
                if (e.target.classList.contains('param-btn')) {
                    sizeGroup.querySelectorAll('.param-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    selectedSize = e.target.dataset.value;
                    await pageCache.set('selectedSize', selectedSize, { ttl: null });
                }
            });
            secondsGroup.addEventListener('click', async (e) => {
                if (e.target.classList.contains('param-btn')) {
                    secondsGroup.querySelectorAll('.param-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    selectedSeconds = e.target.dataset.value;
                    await pageCache.set('selectedSeconds', selectedSeconds, { ttl: null });
                }
            });

            modelGroup.addEventListener('click', async (e) => {
                if (e.target.classList.contains('param-btn')) {
                    modelGroup.querySelectorAll('.param-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    selectedModel = e.target.dataset.value;
                    await pageCache.set('selectedModel', selectedModel, { ttl: null });
                    // æ›´æ–°1080pæŒ‰é’®çŠ¶æ€
                    const btn1080 = qualityGroup.querySelector('[data-value="1080p"]');
                    if (selectedModel === 'sora-2-pro') {
                        btn1080.disabled = false;
                        btn1080.textContent = '1080p';
                    } else {
                        btn1080.disabled = true;
                        btn1080.textContent = '1080p (ä»…Pro)';
                        if (selectedQuality === '1080p') {
                            qualityGroup.querySelectorAll('.param-btn').forEach(b => b.classList.remove('active'));
                            qualityGroup.querySelector('[data-value="720p"]').classList.add('active');
                            selectedQuality = '720p';
                            await pageCache.set('selectedQuality', selectedQuality, { ttl: null });
                        }
                    }
                }
            });

            qualityGroup.addEventListener('click', async (e) => {
                if (e.target.classList.contains('param-btn') && !e.target.disabled) {
                    qualityGroup.querySelectorAll('.param-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    selectedQuality = e.target.dataset.value;
                    await pageCache.set('selectedQuality', selectedQuality, { ttl: null });
                }
            });

            optimizeBtn.addEventListener('click', handleOptimize);
            submitBtn.addEventListener('click', handleSubmit);
        }

        // åŠ è½½ç¼“å­˜çŠ¶æ€
        async function loadCachedState() {
            try {
                const [soraKey, geminiKey, cachedHistory, cachedSize, cachedSeconds, cachedModel, cachedQuality] = await Promise.all([
                    pageCache.get('soraApiKey'),
                    pageCache.get('geminiApiKey'),
                    pageCache.get('taskHistory'),
                    pageCache.get('selectedSize'),
                    pageCache.get('selectedSeconds'),
                    pageCache.get('selectedModel'),
                    pageCache.get('selectedQuality')
                ]);
                
                if (soraKey) credentialInput.value = soraKey;
                if (geminiKey) geminiKeyInput.value = geminiKey;
                if (cachedHistory && Array.isArray(cachedHistory)) {
                    taskHistory = cachedHistory;
                    renderHistory();
                    // æ¢å¤æœªå®Œæˆä»»åŠ¡çš„è½®è¯¢
                    const apiKey = credentialInput.value.trim();
                    if (apiKey) taskHistory.filter(t => t.status === 'pending').forEach(t => startPolling(t.id, apiKey));
                }
                if (cachedSize) {
                    selectedSize = cachedSize;
                    sizeGroup.querySelectorAll('.param-btn').forEach(b => {
                        b.classList.toggle('active', b.dataset.value === cachedSize);
                    });
                }
                if (cachedSeconds) {
                    selectedSeconds = cachedSeconds;
                    secondsGroup.querySelectorAll('.param-btn').forEach(b => {
                        b.classList.toggle('active', b.dataset.value === cachedSeconds);
                    });
                }
                if (cachedModel) {
                    selectedModel = cachedModel;
                    modelGroup.querySelectorAll('.param-btn').forEach(b => {
                        b.classList.toggle('active', b.dataset.value === cachedModel);
                    });
                    // æ›´æ–°1080pæŒ‰é’®çŠ¶æ€
                    const btn1080 = qualityGroup.querySelector('[data-value="1080p"]');
                    if (cachedModel === 'sora-2-pro') {
                        btn1080.disabled = false;
                        btn1080.textContent = '1080p';
                    }
                }
                if (cachedQuality && (cachedQuality === '720p' || (cachedQuality === '1080p' && selectedModel === 'sora-2-pro'))) {
                    selectedQuality = cachedQuality;
                    qualityGroup.querySelectorAll('.param-btn').forEach(b => {
                        b.classList.toggle('active', b.dataset.value === cachedQuality);
                    });
                }
            } catch (e) { console.error('åŠ è½½ç¼“å­˜å¤±è´¥:', e); }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) processFile(file);
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) processFile(file);
        }

        function processFile(file) {
            if (file.size > 10 * 1024 * 1024) {
                setStatus('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 10MB', 'error');
                return;
            }
            selectedFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                selectedFileBase64 = e.target.result;
                imagePreview.innerHTML = `
                    <img src="${e.target.result}" alt="é¢„è§ˆ">
                    <button class="remove-btn" onclick="removeImage()">Ã—</button>
                `;
                imagePreview.classList.remove('hidden');
                uploadZone.classList.add('has-image');
            };
            reader.readAsDataURL(file);
        }

        function removeImage() {
            selectedFile = null;
            selectedFileBase64 = null;
            imageFileInput.value = '';
            imagePreview.innerHTML = '';
            imagePreview.classList.add('hidden');
            uploadZone.classList.remove('has-image');
        }

        // AIæ™ºèƒ½æ¶¦è‰²æç¤ºè¯
        async function handleOptimize() {
            const geminiKey = geminiKeyInput.value.trim();
            if (!geminiKey) { setStatus('è¯·å…ˆå¡«å†™ Gemini APIKey', 'error'); return; }
            if (!selectedFile) { setStatus('è¯·å…ˆä¸Šä¼ å‚è€ƒå›¾ç‰‡', 'error'); return; }

            optimizeBtn.disabled = true;
            optimizeBtn.classList.add('loading');
            optimizeBtn.textContent = 'æ¶¦è‰²ä¸­...';
            setStatus('AIæ­£åœ¨åˆ†æå›¾ç‰‡å¹¶ä¼˜åŒ–æç¤ºè¯...', 'info');

            try {
                const userPrompt = promptInput.value.trim();
                const base64Data = selectedFileBase64.split(',')[1];
                const mimeType = selectedFile.type || 'image/jpeg';

                const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„Soraè§†é¢‘æç¤ºè¯ä¼˜åŒ–ä¸“å®¶ã€‚è¯·åˆ†æè¿™å¼ å›¾ç‰‡ï¼Œå¹¶æ ¹æ®ç”¨æˆ·çš„æè¿°æ„å›¾ï¼Œç”Ÿæˆä¸€ä¸ªä¼˜åŒ–åçš„è§†é¢‘ç”Ÿæˆæç¤ºè¯ã€‚

è¦æ±‚ï¼š
1. åˆ†æå›¾ç‰‡ä¸­çš„ä¸»ä½“å…ƒç´ ã€åœºæ™¯ã€è‰²å½©ã€é£æ ¼
2. ç»“åˆç”¨æˆ·æ„å›¾ï¼Œæè¿°åˆç†çš„åŠ¨æ€æ•ˆæœå’Œè¿åŠ¨æ–¹å¼
3. æç¤ºè¯è¦å…·ä½“ã€ç”ŸåŠ¨ï¼ŒåŒ…å«åŠ¨ä½œã€é•œå¤´ã€å…‰å½±ã€æ°›å›´ç­‰ç»†èŠ‚
4. é€‚åˆSoraè§†é¢‘ç”Ÿæˆï¼Œå¼ºè°ƒæµç•…è‡ªç„¶çš„åŠ¨æ€æ•ˆæœ
5. åªè¾“å‡ºä¼˜åŒ–åçš„æç¤ºè¯ï¼Œä¸è¦ä»»ä½•è§£é‡Šã€å‰ç¼€æˆ–åç¼€

${userPrompt ? `ç”¨æˆ·åŸå§‹æè¿°ï¼š${userPrompt}` : 'ç”¨æˆ·æœªæä¾›æè¿°ï¼Œè¯·æ ¹æ®å›¾ç‰‡å†…å®¹ç”Ÿæˆåˆé€‚çš„è§†é¢‘åŠ¨æ€æ•ˆæœæè¿°'}`;

                const body = {
                    contents: [{
                        role: 'user',
                        parts: [
                            { text: systemPrompt },
                            { inline_data: { mime_type: mimeType, data: base64Data } }
                        ]
                    }]
                };

                const response = await fetch(GEMINI_API(geminiKey), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(`APIé”™è¯¯: ${response.status}`);
                }

                const result = await response.json();
                const optimizedPrompt = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim();

                if (optimizedPrompt) {
                    promptInput.value = optimizedPrompt;
                    setStatus('æç¤ºè¯ä¼˜åŒ–å®Œæˆï¼', 'success');
                } else {
                    throw new Error('æœªè·å–åˆ°ä¼˜åŒ–ç»“æœ');
                }
            } catch (error) {
                setStatus(`æ¶¦è‰²å¤±è´¥: ${error.message}`, 'error');
            } finally {
                optimizeBtn.disabled = false;
                optimizeBtn.classList.remove('loading');
                optimizeBtn.textContent = 'âœ¨ AIæ¶¦è‰²';
            }
        }

        async function handleSubmit() {
            const apiKey = credentialInput.value.trim();
            const prompt = promptInput.value.trim();

            if (!apiKey) { setStatus('è¯·å¡«å†™ APIKey', 'error'); return; }
            if (!selectedFile) { setStatus('è¯·ä¸Šä¼ å‚è€ƒå›¾ç‰‡', 'error'); return; }
            if (!prompt) { setStatus('è¯·å¡«å†™æç¤ºè¯', 'error'); return; }

            submitBtn.disabled = true;
            setStatus('æ­£åœ¨æäº¤ä»»åŠ¡...', 'info');

            try {
                const formData = new FormData();
                formData.append('model', selectedModel);
                formData.append('prompt', prompt);
                formData.append('seconds', selectedSeconds);
                formData.append('size', selectedSize);
                formData.append('watermark', 'false');
                if (selectedModel === 'sora-2-pro' && selectedQuality === '1080p') {
                    formData.append('resolution', '1080p');
                }
                formData.append('input_reference', selectedFile);

                const response = await fetch(`${API_BASE}/v1/videos`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${apiKey}` },
                    body: formData
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.message || result.error || 'è¯·æ±‚å¤±è´¥');

                const taskId = result.task_id || result.data?.task_id || result.id || result.data?.id;
                if (!taskId) throw new Error('æœªè·å–åˆ°ä»»åŠ¡ID');

                const task = {
                    id: taskId,
                    prompt: prompt,
                    size: selectedSize,
                    seconds: selectedSeconds,
                    model: selectedModel,
                    quality: selectedQuality,
                    status: 'pending',
                    createdAt: Date.now(),
                    videoUrl: null
                };

                taskHistory.unshift(task);
                saveHistory();
                renderHistory();
                startPolling(taskId, apiKey);

                setStatus('ä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨ç”Ÿæˆè§†é¢‘...', 'success');
                removeImage();
                promptInput.value = '';
            } catch (error) {
                setStatus(`æäº¤å¤±è´¥: ${error.message}`, 'error');
            } finally {
                submitBtn.disabled = false;
            }
        }

        function startPolling(taskId, apiKey) {
            if (pollingIntervals[taskId]) return;
            
            const poll = async () => {
                try {
                    const response = await fetch(`${API_BASE}/v1/videos/${taskId}`, {
                        headers: { 'Authorization': `Bearer ${apiKey}`, 'Accept': 'application/json' }
                    });
                    const result = await response.json();
                    
                    const task = taskHistory.find(t => t.id === taskId);
                    if (!task) { clearInterval(pollingIntervals[taskId]); delete pollingIntervals[taskId]; return; }

                    // å…¼å®¹ä¸¤ç§è¿”å›æ ¼å¼
                    const outerStatus = result.status?.toUpperCase();
                    const innerStatus = result.data?.status || result.status;
                    const videoUrl = result.data?.video_url || result.video_url;
                    const progress = result.data?.progress || result.progress;

                    if ((outerStatus === 'SUCCESS' && result.data?.status === 'completed') || innerStatus === 'completed') {
                        task.status = 'completed';
                        task.videoUrl = videoUrl;
                        clearInterval(pollingIntervals[taskId]);
                        delete pollingIntervals[taskId];
                        
                        // ä¿å­˜åˆ°äº‘ç«¯ï¼ˆç™»å½•ç”¨æˆ·ï¼‰
                        if (videoUrl) {
                            try {
                                await ImageServer.saveGeneration(
                                    credentialInput.value.trim(),
                                    task.prompt,
                                    [{ url: videoUrl }],
                                    'sora-image2video',
                                    'image'
                                );
                                console.log('è§†é¢‘å·²ä¿å­˜åˆ°äº‘ç«¯');
                            } catch (e) {
                                console.warn('ä¿å­˜åˆ°äº‘ç«¯å¤±è´¥:', e);
                            }
                        }
                    } else if (outerStatus === 'FAILED' || innerStatus === 'failed') {
                        task.status = 'failed';
                        task.failReason = result.fail_reason || 'ç”Ÿæˆå¤±è´¥';
                        clearInterval(pollingIntervals[taskId]);
                        delete pollingIntervals[taskId];
                    } else {
                        task.progress = progress;
                    }
                    saveHistory();
                    renderHistory();
                } catch (error) { console.error('è½®è¯¢å¤±è´¥:', error); }
            };

            poll();
            pollingIntervals[taskId] = setInterval(poll, 10000);
        }

        // loadHistory å·²ç§»è‡³ loadCachedState ä¸­

        async function saveHistory() {
            try { 
                await pageCache.set('taskHistory', taskHistory.slice(0, 20), { ttl: null }); 
            } catch (e) { console.error('ä¿å­˜å†å²å¤±è´¥:', e); }
        }

        function renderHistory() {
            if (taskHistory.length === 0) {
                historyEmpty.classList.remove('hidden');
                taskHistoryList.innerHTML = '';
                return;
            }
            historyEmpty.classList.add('hidden');
            taskHistoryList.innerHTML = taskHistory.map(task => `
                <div class="history-item" data-id="${task.id}">
                    <header>
                        <div class="history-meta">
                            <strong title="${task.prompt}">${task.prompt}</strong>
                            <span>${task.size} Â· ${task.seconds}ç§’ Â· ${formatTime(task.createdAt)}</span>
                        </div>
                        <span class="history-status ${task.status}">${getStatusText(task)}</span>
                    </header>
                    ${task.videoUrl ? `<div class="history-video"><video src="${task.videoUrl}" controls preload="metadata"></video></div>` : ''}
                    <div class="history-actions">
                        ${task.videoUrl ? `<button onclick="downloadVideo('${task.videoUrl}', '${task.id}')">ä¸‹è½½è¯¥é¡¹</button>` : ''}
                        <button class="delete-btn" onclick="deleteTask('${task.id}')">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        function getStatusText(task) {
            if (task.status === 'pending') return task.progress ? `ç”Ÿæˆä¸­ ${task.progress}` : 'ç”Ÿæˆä¸­...';
            if (task.status === 'completed') return 'å·²å®Œæˆ';
            if (task.status === 'failed') return 'å¤±è´¥';
            return task.status;
        }

        function downloadVideo(url, filename) {
            const a = document.createElement('a');
            a.href = url; a.download = `sora_${filename}.mp4`; a.target = '_blank';
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        function deleteTask(id) {
            if (!confirm('ç¡®å®šåˆ é™¤è¯¥ä»»åŠ¡ï¼Ÿ')) return;
            if (pollingIntervals[id]) { clearInterval(pollingIntervals[id]); delete pollingIntervals[id]; }
            taskHistory = taskHistory.filter(t => t.id !== id);
            saveHistory(); renderHistory();
        }

        // æ‰‹åŠ¨åˆ·æ–°æ‰€æœ‰pendingä»»åŠ¡
        async function refreshAllTasks() {
            const apiKey = credentialInput.value.trim();
            if (!apiKey) { setStatus('è¯·å…ˆå¡«å†™ APIKey', 'error'); return; }
            
            const pendingTasks = taskHistory.filter(t => t.status === 'pending');
            if (pendingTasks.length === 0) { setStatus('æ²¡æœ‰è¿›è¡Œä¸­çš„ä»»åŠ¡', 'info'); return; }
            
            setStatus(`æ­£åœ¨åˆ·æ–° ${pendingTasks.length} ä¸ªä»»åŠ¡...`, 'info');
            
            for (const task of pendingTasks) {
                try {
                    const response = await fetch(`${API_BASE}/v1/videos/${task.id}`, {
                        headers: { 'Authorization': `Bearer ${apiKey}`, 'Accept': 'application/json' }
                    });
                    const result = await response.json();
                    
                    // å…¼å®¹ä¸¤ç§è¿”å›æ ¼å¼
                    const outerStatus = result.status?.toUpperCase();
                    const innerStatus = result.data?.status || result.status;
                    const videoUrl = result.data?.video_url || result.video_url;
                    const progress = result.data?.progress || result.progress;

                    if ((outerStatus === 'SUCCESS' && result.data?.status === 'completed') || innerStatus === 'completed') {
                        task.status = 'completed';
                        task.videoUrl = videoUrl;
                        if (pollingIntervals[task.id]) { clearInterval(pollingIntervals[task.id]); delete pollingIntervals[task.id]; }
                    } else if (outerStatus === 'FAILED' || innerStatus === 'failed') {
                        task.status = 'failed';
                        task.failReason = result.fail_reason || 'ç”Ÿæˆå¤±è´¥';
                        if (pollingIntervals[task.id]) { clearInterval(pollingIntervals[task.id]); delete pollingIntervals[task.id]; }
                    } else {
                        task.progress = progress;
                    }
                } catch (e) { console.error('åˆ·æ–°ä»»åŠ¡å¤±è´¥:', task.id, e); }
            }
            
            saveHistory();
            renderHistory();
            setStatus('åˆ·æ–°å®Œæˆ', 'success');
        }

        function clearHistory() {
            if (!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰å†å²è®°å½•ï¼Ÿ')) return;
            Object.keys(pollingIntervals).forEach(id => clearInterval(pollingIntervals[id]));
            pollingIntervals = {}; taskHistory = [];
            saveHistory(); renderHistory();
        }

        function setStatus(message, type = '') {
            statusEl.textContent = message;
            statusEl.className = type ? `status ${type}` : 'status';
        }

        function formatTime(timestamp) {
            const d = new Date(timestamp);
            return `${d.getMonth()+1}/${d.getDate()} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
        }

        function debounce(fn, delay) {
            let timer;
            return (...args) => { clearTimeout(timer); timer = setTimeout(() => fn(...args), delay); };
        }

        // è§’è‰²é€‰æ‹©åŠŸèƒ½
        const characterModal = document.getElementById('characterModal');
        const characterModalBody = document.getElementById('characterModalBody');
        const characterSelectBtn = document.getElementById('characterSelectBtn');
        const characterModalClose = document.getElementById('characterModalClose');
        const characterCache = new CacheManager('sora-characters');

        characterSelectBtn.addEventListener('click', async () => {
            characterModal.classList.add('active');
            characterModalBody.innerHTML = '<p class="character-modal-empty">æ­£åœ¨åŠ è½½...</p>';
            
            try {
                const characters = await characterCache.get('characters') || [];
                
                if (characters.length === 0) {
                    characterModalBody.innerHTML = `
                        <p class="character-modal-empty">
                            æš‚æ— å·²ä¿å­˜çš„è§’è‰²<br>
                            <a href="soracjjs.html" style="color: #f97316; text-decoration: none;">å»åˆ›å»ºè§’è‰² â†’</a>
                        </p>
                    `;
                    return;
                }

                characterModalBody.innerHTML = characters.map((char, index) => `
                    <div class="character-modal-item" data-username="${char.username}">
                        <img class="character-modal-avatar" src="${char.profile_picture_url || ''}" alt="${char.note || char.username}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 48 48%22><rect fill=%22%23e8ecf1%22 width=%2248%22 height=%2248%22/><text x=%2224%22 y=%2232%22 text-anchor=%22middle%22 fill=%22%2394a3b8%22 font-size=%2218%22>ğŸ­</text></svg>'">
                        <div class="character-modal-info">
                            <div class="character-modal-name">${char.note || 'æœªå‘½åè§’è‰²'}</div>
                            <div class="character-modal-username">@${char.username}</div>
                        </div>
                    </div>
                `).join('');

                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                characterModalBody.querySelectorAll('.character-modal-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const username = item.dataset.username;
                        const mention = `@${username} `;
                        const currentValue = promptInput.value;
                        
                        // åœ¨å…‰æ ‡ä½ç½®æ’å…¥ï¼Œæˆ–è€…åœ¨å¼€å¤´æ’å…¥
                        const start = promptInput.selectionStart;
                        const end = promptInput.selectionEnd;
                        promptInput.value = currentValue.substring(0, start) + mention + currentValue.substring(end);
                        promptInput.focus();
                        promptInput.setSelectionRange(start + mention.length, start + mention.length);
                        
                        characterModal.classList.remove('active');
                        setStatus(`å·²æ’å…¥è§’è‰² @${username}`, 'success');
                    });
                });
            } catch (error) {
                console.error('åŠ è½½è§’è‰²å¤±è´¥:', error);
                characterModalBody.innerHTML = '<p class="character-modal-empty">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</p>';
            }
        });

        characterModalClose.addEventListener('click', () => {
            characterModal.classList.remove('active');
        });

        characterModal.addEventListener('click', (e) => {
            if (e.target === characterModal) {
                characterModal.classList.remove('active');
            }
        });
    </script>
</body>
</html>
