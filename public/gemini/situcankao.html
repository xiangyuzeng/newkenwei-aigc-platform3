<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å››å›¾å‚è€ƒç”Ÿæˆ</title>
    <link rel="stylesheet" href="../styles/workspace.css">
    <link rel="stylesheet" href="../styles/mobile.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif; background: #f5f7fa; min-height: 100vh; color: #1e293b; }

        .top-header { background: #fff; padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; position: fixed; top: 0; left: 0; right: 0; z-index: 100; height: 56px; }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .header-btn { display: flex; align-items: center; gap: 6px; padding: 8px 16px; background: #f8f9fb; border: 1px solid #e8ecf1; border-radius: 8px; font-size: 13px; color: #475569; cursor: pointer; transition: all 0.2s; text-decoration: none; }
        .header-btn:hover { background: #f0f2f5; border-color: #d1d5db; }
        .page-title { font-size: 20px; font-weight: 600; background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%); -webkit-background-clip: text; background-clip: text; color: transparent; }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .header-icon-btn { width: 36px; height: 36px; border-radius: 8px; border: 1px solid #e8ecf1; background: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; color: #64748b; }

        .tab-nav { background: #fff; padding: 0 24px; border-bottom: 1px solid #e8ecf1; position: fixed; top: 56px; left: 0; right: 0; z-index: 99; height: 48px; display: flex; align-items: center; gap: 8px; }
        .tab-item { padding: 8px 20px; font-size: 14px; color: #64748b; border-radius: 6px; cursor: pointer; transition: all 0.2s; text-decoration: none; }
        .tab-item:hover { background: #f5f7fa; color: #475569; }
        .tab-item.active { background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%); color: #fff; font-weight: 500; }

        .main-content { margin-top: 104px; padding: 24px; display: grid; grid-template-columns: 1fr 1fr; gap: 24px; max-width: 1400px; margin-left: auto; margin-right: auto; }
        .left-panel, .right-panel { display: flex; flex-direction: column; gap: 20px; }
        .panel-section { background: #fff; border-radius: 12px; padding: 20px; border: 1px solid #e8ecf1; }
        .section-title { font-size: 15px; font-weight: 600; color: #1e293b; margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between; }

        .credential-input { width: 100%; padding: 10px 14px; border: 1px solid #e8ecf1; border-radius: 8px; font-size: 13px; background: #fafbfc; }
        .credential-input:focus { outline: none; border-color: #ec4899; background: #fff; }
        .helper { font-size: 12px; color: #94a3b8; margin-top: 8px; line-height: 1.5; }

        /* å››å›¾ä¸Šä¼ ç½‘æ ¼ */
        .image-grid-upload { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .upload-slot { border: 2px dashed #d1d5db; border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s; background: #fafbfc; min-height: 140px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .upload-slot:hover { border-color: #ec4899; background: #fdf2f8; }
        .upload-slot.has-image { border-style: solid; border-color: #ec4899; padding: 4px; }
        .upload-slot .slot-label { font-size: 20px; font-weight: 600; color: #ec4899; margin-bottom: 6px; }
        .upload-slot .slot-hint { font-size: 11px; color: #94a3b8; }
        .upload-slot img { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; }
        .upload-slot .delete-btn { position: absolute; top: -6px; right: -6px; width: 22px; height: 22px; background: #fff; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; color: #ef4444; box-shadow: 0 2px 6px rgba(0,0,0,0.15); transition: all 0.2s; z-index: 10; }
        .upload-slot .delete-btn:hover { background: #fef2f2; transform: scale(1.1); }
        .file-input { display: none; }

        /* æç¤ºè¯è¾“å…¥ */
        .prompt-textarea { width: 100%; min-height: 120px; padding: 14px; border: 1px solid #e8ecf1; border-radius: 8px; font-size: 14px; background: #fafbfc; resize: vertical; line-height: 1.6; }
        .prompt-textarea:focus { outline: none; border-color: #ec4899; background: #fff; }
        .prompt-example { background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); border-radius: 8px; padding: 12px 16px; font-size: 12px; color: #9d174d; line-height: 1.8; margin-top: 12px; }

        /* æ¯”ä¾‹æŒ‰é’®ç»„ */
        .ratio-btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .ratio-btn { display: flex; align-items: center; gap: 6px; padding: 10px 16px; border: 1px solid #e8ecf1; border-radius: 20px; font-size: 13px; color: #475569; background: #fff; cursor: pointer; transition: all 0.2s; }
        .ratio-btn:hover { border-color: #ec4899; background: #fdf2f8; }
        .ratio-btn.active { background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%); color: #fff; border-color: transparent; }
        .ratio-icon { width: 14px; height: 14px; border: 1.5px solid currentColor; border-radius: 2px; flex-shrink: 0; }

        /* åˆ†è¾¨ç‡é€‰æ‹© */
        .model-select { width: 100%; padding: 10px 14px; border: 1px solid #e8ecf1; border-radius: 8px; font-size: 13px; background: #fff; cursor: pointer; }
        .model-select:focus { outline: none; border-color: #ec4899; }

        .submit-btn { width: 100%; padding: 14px 24px; background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%); color: #fff; border: none; border-radius: 10px; font-size: 15px; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3); }
        .submit-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(236, 72, 153, 0.4); }
        .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        .status { font-size: 13px; padding: 10px 14px; border-radius: 8px; margin-top: 12px; }
        .status:empty { display: none; }
        .status.success { background: #ecfdf5; color: #059669; }
        .status.error { background: #fef2f2; color: #dc2626; }
        .status.warning { background: #fffbeb; color: #d97706; }

        .task-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .task-desc { font-size: 13px; color: #64748b; margin-bottom: 16px; }
        .view-all-btn { padding: 6px 14px; background: #f8f9fb; border: 1px solid #e8ecf1; border-radius: 6px; font-size: 12px; color: #64748b; cursor: pointer; }
        .view-all-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .task-list { display: flex; flex-direction: column; gap: 12px; }
        .history-empty { text-align: center; color: #94a3b8; font-size: 13px; padding: 40px 20px; }

        .history-item { background: #f8f9fb; border: 1px solid #e8ecf1; border-radius: 10px; padding: 16px; }
        .history-item header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .history-meta { display: flex; flex-direction: column; gap: 4px; font-size: 12px; color: #64748b; }
        .history-meta strong { color: #1e293b; font-size: 14px; }
        .history-actions button { padding: 6px 12px; background: #fff; border: 1px solid #e8ecf1; border-radius: 6px; font-size: 12px; color: #475569; cursor: pointer; }
        .history-actions button:hover:not(:disabled) { border-color: #ec4899; color: #ec4899; }
        .history-image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; }
        .history-image img { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 8px; border: 1px solid #e8ecf1; }
        .history-image .history-actions { margin-top: 8px; }
        .history-image .history-actions button { width: 100%; font-size: 11px; }

        .image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; margin-top: 16px; }
        .image-grid figure { margin: 0; }
        .image-grid img { width: 100%; border-radius: 8px; border: 1px solid #e8ecf1; }
        .image-grid figcaption { font-size: 12px; color: #64748b; margin-top: 6px; }

        .hidden { display: none !important; }

        @media (max-width: 1024px) { .main-content { grid-template-columns: 1fr; } }
        @media (max-width: 768px) {
            .tab-nav { overflow-x: auto; padding: 0 16px; }
            .main-content { padding: 16px; }
            .image-grid-upload { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header class="top-header">
        <div class="header-left">
        </div>
        <span class="page-title">å››å›¾å‚è€ƒå°åŠ©æ‰‹</span>
        <div class="header-right">
            <button class="header-icon-btn">ğŸ””</button>
        </div>
    </header>

    <nav class="tab-nav">
        <a href="tiqu-yinhua.html" class="tab-item">æå–å°èŠ±</a>
        <a href="situcankao.html" class="tab-item active">å››å›¾å‚è€ƒ</a>
        <a href="shitucankao.html" class="tab-item">åå›¾å‚è€ƒ</a>
        <a href="zidingyi.html" class="tab-item">è‡ªå®šä¹‰</a>
        <a href="cpsj.html" class="tab-item">äº§å“æµ·æŠ¥</a>
    </nav>

    <main class="main-content">
        <div class="left-panel">
            <div class="panel-section">
                <h2 class="section-title">APIKeyå¡«å†™åŒº</h2>
                <input type="password" id="credential" class="credential-input" placeholder="ç²˜è´´è®¿é—®å‡­è¯" required autocomplete="off">
                <p class="helper">å¡«å†™DUUè°ƒç”¨ç«™çš„APIkeyï¼Œå»ºè®®åˆ›å»ºapikeyåˆ†ç»„ä¸ºé™æ—¶ç‰¹ä»·ã€ä¼˜è´¨geminiã€å®˜è½¬gemini</p>
            </div>

            <div class="panel-section">
                <h2 class="section-title">è¾“å…¥æç¤ºè¯</h2>
                <textarea id="prompt-input" class="prompt-textarea" placeholder="ç”¨ç®€å•å¤§ç™½è¯å†™å‡ºä½ çš„éœ€è¦..."></textarea>
                <div class="prompt-example">
                    ğŸ’¡ ç¤ºä¾‹ï¼šå›¾1çš„äººç‰©ç©¿å›¾2çš„è¡£æœï¼Œå¸¦å›¾3çš„å¸½å­ï¼Œæ‹¿å›¾4çš„åŒ…...
                </div>
                <div style="margin-top: 12px;">
                    <label style="display: flex; align-items: center; gap: 6px; font-size: 13px; color: #475569; cursor: pointer;">
                        <input type="checkbox" id="optimize-toggle" style="accent-color: #ec4899;"> å¯ç”¨æç¤ºè¯ä¼˜åŒ–ï¼ˆAIåˆ†æå›¾ç‰‡ç”Ÿæˆä¼˜åŒ–æç¤ºè¯ï¼‰
                    </label>
                    <p class="helper">å¼€å¯åï¼ŒAIä¼šå…ˆåˆ†æå›¾ç‰‡å†…å®¹ï¼Œç”Ÿæˆé’ˆå¯¹æ€§çš„æç¤ºè¯ï¼Œç”Ÿæˆæ•ˆæœæ›´ç²¾å‡†</p>
                </div>
            </div>

            <div class="panel-section">
                <h2 class="section-title">ä¸Šä¼ å‚è€ƒå›¾ç‰‡ï¼ˆæœ€å¤š4å¼ ï¼‰</h2>
                <div class="image-grid-upload" id="upload-grid">
                    <!-- 4ä¸ªä¸Šä¼ æ§½ä½å°†ç”±JSç”Ÿæˆ -->
                </div>
                <p class="helper" style="margin-top: 12px;">ä½¿ç”¨ Gemini 3 Pro Image Preview æ¨¡å‹ï¼Œæ”¯æŒåŒæ—¶ä¸Šä¼ æœ€å¤š4å¼ å‚è€ƒå›¾ç‰‡ï¼Œæ”¯æŒåˆ†è¾¨ç‡é€‰æ‹©</p>
            </div>

            <div class="panel-section">
                <h2 class="section-title">è¾“å‡ºè®¾ç½®</h2>
                <div style="margin-bottom: 16px;">
                    <label class="helper">è¾“å‡ºæ¯”ä¾‹</label>
                    <div class="ratio-btn-group" style="margin-top: 8px;">
                        <button type="button" class="ratio-btn active" data-ratio="1:1"><span class="ratio-icon"></span> 1:1</button>
                        <button type="button" class="ratio-btn" data-ratio="2:3"><span class="ratio-icon" style="width:12px;height:18px;"></span> 2:3</button>
                        <button type="button" class="ratio-btn" data-ratio="3:4"><span class="ratio-icon" style="width:12px;height:16px;"></span> 3:4</button>
                        <button type="button" class="ratio-btn" data-ratio="3:2"><span class="ratio-icon" style="width:18px;height:12px;"></span> 3:2</button>
                        <button type="button" class="ratio-btn" data-ratio="4:3"><span class="ratio-icon" style="width:16px;height:12px;"></span> 4:3</button>
                        <button type="button" class="ratio-btn" data-ratio="16:9"><span class="ratio-icon" style="width:16px;height:9px;"></span> 16:9</button>
                    </div>
                    <input type="hidden" id="aspect-ratio" value="1:1">
                </div>
                <div>
                    <label class="helper">è¾“å‡ºåˆ†è¾¨ç‡</label>
                    <select id="resolution-select" class="model-select" style="margin-top: 6px;">
                        <option value="1024" selected>1Kï¼ˆ1024ï¼‰</option>
                        <option value="2048">2Kï¼ˆ2048ï¼‰</option>
                        <option value="4096">4Kï¼ˆ4096ï¼‰</option>
                    </select>
                </div>
            </div>

            <button type="button" class="submit-btn" id="submitBtn">âœ¨ å¼€å§‹ç”Ÿæˆ</button>
            <p id="status" class="status" aria-live="polite"></p>

            <div class="panel-section" id="output-section" hidden>
                <h2 class="section-title">ç”Ÿæˆç»“æœ</h2>
                <div id="image-output" class="image-grid"></div>
            </div>
        </div>

        <div class="right-panel">
            <div class="panel-section" style="flex: 1;">
                <div class="task-header">
                    <h2 class="section-title" style="margin-bottom: 0;">ä»»åŠ¡å†å²</h2>
                    <button class="view-all-btn" id="download-all-images" disabled>ä¸‹è½½å…¨éƒ¨å›¾ç‰‡</button>
                </div>
                <p class="task-desc">ç”Ÿæˆå›¾ç‰‡å¤§çº¦éœ€è¦2-4åˆ†é’Ÿï¼Œå±•ç¤ºæœ€æ–°ä»»åŠ¡è®°å½•</p>
                <p id="history-empty" class="history-empty">æš‚æ— ä»»åŠ¡è®°å½•</p>
                <div id="task-history-list" class="task-list" aria-live="polite"></div>
            </div>
        </div>
    </main>

    <script src="../scripts/duu-db.js"></script>
    <script src="../scripts/apikeys.js"></script>
    <script src="../scripts/auth.js"></script>
    <script src="../scripts/image-server.js"></script>
    <script>
      // DOM å…ƒç´ 
      const statusEl = document.getElementById("status");
      const imageOutput = document.getElementById("image-output");
      const outputSection = document.getElementById("output-section");
      const credentialInput = document.getElementById("credential");
      const promptInput = document.getElementById("prompt-input");
      const submitBtn = document.getElementById("submitBtn");
      const resolutionSelect = document.getElementById("resolution-select");
      const taskHistoryList = document.getElementById("task-history-list");
      const historyEmptyState = document.getElementById("history-empty");
      const downloadAllBtn = document.getElementById("download-all-images");
      const uploadGrid = document.getElementById("upload-grid");
      const responseModalitiesInput = document.createElement('input');
      responseModalitiesInput.type = 'hidden';
      responseModalitiesInput.value = 'IMAGE';
      document.body.appendChild(responseModalitiesInput);

      // åˆå§‹åŒ–ç¼“å­˜ç³»ç»Ÿ
      const pageCache = new CacheManager('gemini-four-ref');
      
      // API Key ç¼“å­˜ - è¾“å…¥æ—¶è‡ªåŠ¨ä¿å­˜ï¼ˆå¸¦é˜²æŠ–ï¼‰
      let apiKeyTimer = null;
      if (credentialInput) {
        credentialInput.addEventListener('input', (e) => {
          const apiKey = e.target.value.trim();
          if (apiKeyTimer) clearTimeout(apiKeyTimer);
          apiKeyTimer = setTimeout(async () => {
            if (apiKey) {
              await pageCache.set('apiKey', apiKey, { ttl: null });
            }
          }, 500);
        });
      }
      
      // æç¤ºè¯ç¼“å­˜ - è¾“å…¥æ—¶è‡ªåŠ¨ä¿å­˜ï¼ˆå¸¦é˜²æŠ–ï¼‰
      let promptTimer = null;
      if (promptInput) {
        promptInput.addEventListener('input', (e) => {
          const prompt = e.target.value.trim();
          if (promptTimer) clearTimeout(promptTimer);
          promptTimer = setTimeout(async () => {
            await pageCache.set('prompt', prompt, { ttl: null });
          }, 500);
        });
      }
      
      // åˆå§‹åŒ–å…¨å±€APIKey
      if (window.initApiKeyInput) {
        window.initApiKeyInput('gemini', 'credential');
      }

      // å›¾ç‰‡æ§½ä½çŠ¶æ€ (1-4)
      const imageSlots = {};
      const previewUrls = {};
      const slotMetadata = {};
      for (let i = 1; i <= 4; i++) {
        imageSlots[i] = null;
        previewUrls[i] = null;
        slotMetadata[i] = null;
      }
      let taskHistory = [];
      let isRestoring = false;

      const TASK_STATE_KEY = 'gemini_four_ref_last_task';
      const TASK_STATE_VERSION = 1;
      const TASK_STATE_EXPIRY_MS = 12 * 60 * 60 * 1000;
      const MAX_HISTORY_ENTRIES = 10;

      const pruneHistory = (history = []) => history.slice(0, MAX_HISTORY_ENTRIES);

      const prepareHistoryForStorage = (history = []) =>
        pruneHistory(history).map((entry) => ({
          ...entry,
          createdAt: entry.createdAt instanceof Date ? entry.createdAt.getTime() : entry.createdAt,
        }));

      const restoreHistoryFromStorage = (history = []) =>
        history.map((entry) => ({
          ...entry,
          createdAt: entry.createdAt ? new Date(entry.createdAt) : new Date(),
        }));

      const setStatus = (message = '', type = '') => {
        const normalizedType = typeof type === 'string' ? type.trim() : '';
        statusEl.textContent = message;
        statusEl.className = normalizedType ? `status ${normalizedType}` : 'status';
      };

      // æ¨¡å‹é…ç½® - ä½¿ç”¨ Gemini 3 Pro Image Preview
      const MODEL_ENDPOINT = (apiKey) => `/v1beta/models/gemini-3-pro-image-preview:generateContent?key=${encodeURIComponent(apiKey)}`;
      
      // æç¤ºè¯ä¼˜åŒ–æ¨¡å‹é…ç½®
      const OPTIMIZER_MODEL_ENDPOINT = (apiKey) => `/v1beta/models/gemini-2.5-flash-lite-nothinking:generateContent?key=${encodeURIComponent(apiKey)}`;
      
      // è·å–ä¼˜åŒ–å¼€å…³å…ƒç´ 
      const optimizeToggle = document.getElementById("optimize-toggle");
      
      // ä¸ºå›¾ç‰‡ç”Ÿæˆä¼˜åŒ–æç¤ºè¯
      const optimizePromptForImages = async (imageSlots, credential) => {
        const systemPrompt = `# Role
ä½ æ˜¯ä¸€ä½ç²¾é€š "nanobanana" å›¾åƒç¼–è¾‘æ¨¡å‹çš„æç¤ºè¯ä¸“å®¶ã€‚ä½ çš„æ ¸å¿ƒèƒ½åŠ›æ˜¯ç†è§£ç”¨æˆ·çš„å¤šå›¾å‚è€ƒæ„å›¾ï¼Œç”Ÿæˆç²¾å‡†ã€å…‹åˆ¶ä¸”é«˜è´¨é‡çš„ä¸­æ–‡ç¼–è¾‘æŒ‡ä»¤ã€‚

# Task
æ ¹æ®ç”¨æˆ·çš„è‡ªç„¶è¯­è¨€æè¿°ï¼Œç”Ÿæˆé€‚ç”¨äº nanobanana çš„ä¸­æ–‡ Promptã€‚

# Constraints & Rules
1. ä¸­æ–‡è¾“å‡ºï¼šæ‰€æœ‰çš„ Prompt å¿…é¡»ä½¿ç”¨ç®€ä½“ä¸­æ–‡ã€‚
2. å‘½ä»¤å¼å¥å¼ï¼šä½¿ç”¨ç›´æ¥ã€æœæ–­çš„åŠ¨ä½œåŠ¨è¯å¼€å¤´ï¼ˆå¦‚ï¼šæ›¿æ¢ã€ä¿®æ”¹ã€èåˆã€ä¿æŒã€æå–ï¼‰ã€‚
3. å¤šå›¾é€»è¾‘å¤„ç†ï¼š
   - ç”¨æˆ·å¯èƒ½æä¾›å¤šå¼ å‚è€ƒå›¾ï¼ˆå‚è€ƒå›¾1ã€å‚è€ƒå›¾2...ï¼‰å’Œä¸€å¼ ç›®æ ‡å›¾ã€‚
   - å¿…é¡»æ¸…æ™°ç•Œå®š"å‚è€ƒæº"ä¸"ç›®æ ‡å¯¹è±¡"çš„å…³ç³»ï¼ˆä¾‹å¦‚ï¼š"æå–å‚è€ƒå›¾1çš„é£æ ¼èµ‹äºˆç›®æ ‡å›¾"ã€"å°†å‚è€ƒå›¾2çš„ç‰©ä½“èåˆè¿›ç›®æ ‡å›¾"ï¼‰ã€‚
4. å…‹åˆ¶è”æƒ³ï¼ˆé«˜ä¿çœŸï¼‰ï¼š
   - ä¸¥ç¦éšæ„æ·»åŠ ç”¨æˆ·æœªæåŠçš„ç‰©ä½“æˆ–å¤æ‚èƒŒæ™¯ã€‚
   - ä»…åœ¨æè´¨ã€å…‰å½±ã€æ¸…æ™°åº¦è¿™ä¸‰ä¸ªç»´åº¦è¿›è¡Œå¿…è¦çš„ä¸“ä¸šæœ¯è¯­è¡¥å…¨ï¼Œä»¥ä¿è¯ç”Ÿæˆè´¨é‡ã€‚
5. ç”»è´¨å¢å¼ºï¼šåœ¨ Prompt æœ«å°¾è¿½åŠ  2 ä¸ªé€šç”¨çš„ç”»è´¨å¢å¼ºè¯ã€‚

# Output Format
ç›´æ¥è¾“å‡º Prompt å†…å®¹ï¼Œä¸åŒ…å«ä»»ä½•è§£é‡Šã€å‰è¨€æˆ–é¢å¤–ç¬¦å·ã€‚

# Workflow
1. åˆ†æç”¨æˆ·è¾“å…¥ï¼Œè¯†åˆ«æ¶‰åŠçš„å›¾ç‰‡æ•°é‡åŠå„è‡ªçš„è§’è‰²ï¼ˆå‚è€ƒ vs ç›®æ ‡ï¼‰ã€‚
2. æå–æ ¸å¿ƒåŠ¨ä½œï¼ˆæ¢è„¸ã€æ¢è£…ã€é£æ ¼è¿ç§»ã€èƒŒæ™¯æ›¿æ¢ç­‰ï¼‰ã€‚
3. ç¼–å†™ä¸­æ–‡æŒ‡ä»¤ï¼Œç¡®ä¿æŒ‡ä»£æ˜ç¡®ï¼ˆå¦‚"å°†å‚è€ƒå›¾Açš„..."ï¼‰ã€‚
4. æ£€æŸ¥æ˜¯å¦è¿‡åº¦è”æƒ³ï¼Œåˆ é™¤å¤šä½™çš„å½¢å®¹è¯ã€‚
5. è¿½åŠ ç”»è´¨è¯ã€‚

# Examples
User: æŠŠè¿™å¼ å›¾é‡Œçš„äººæ¢æˆè¿™å‡ å¼ å‚è€ƒå›¾é‡Œçš„é‚£ä¸ªæ¨¡ç‰¹ï¼Œè¡£æœä¸è¦å˜ã€‚
Output: ä¿æŒç›®æ ‡å›¾ä¸­çš„æœè£…å’ŒèƒŒæ™¯ä¸å˜ï¼Œå°†äººç‰©é¢éƒ¨å’Œä½“å‹æ›¿æ¢ä¸ºå‚è€ƒå›¾ä¸­çš„æ¨¡ç‰¹ç‰¹å¾ã€‚ç¡®ä¿é¢éƒ¨å…‰å½±ä¸åŸç¯å¢ƒå®Œç¾èåˆï¼Œçš®è‚¤è´¨æ„ŸçœŸå®è‡ªç„¶ã€‚é«˜ç”»è´¨ï¼Œç»†èŠ‚æ¸…æ™°ã€‚

User: ç”¨å‚è€ƒå›¾1çš„é…è‰²å’Œå‚è€ƒå›¾2çš„ç”»é£ï¼Œé‡ç»˜è¿™å¼ è‰å›¾ã€‚
Output: æå–å‚è€ƒå›¾1çš„è‰²å½©æ–¹æ¡ˆï¼Œç»“åˆå‚è€ƒå›¾2çš„ç»˜ç”»é£æ ¼ï¼Œå¯¹ç›®æ ‡è‰å›¾è¿›è¡Œä¸Šè‰²å’Œç»†åŒ–é‡ç»˜ã€‚ä¿æŒè‰å›¾åŸæœ‰çš„æ„å›¾å’Œè½®å»“ï¼Œè‰²å½©è¿‡æ¸¡è‡ªç„¶ã€‚æ°ä½œï¼Œé«˜åˆ†è¾¨ç‡ã€‚

User: ç»™è¿™ä¸ªæ¯å­åŠ ä¸ªç›–å­ã€‚
Output: åœ¨æ¯å­ä¸Šæ–¹æ·»åŠ ä¸€ä¸ªæè´¨åŒ¹é…çš„ç›–å­ã€‚ç¡®ä¿ç›–å­çš„é€è§†è§’åº¦ã€å…‰å½±åå°„ä¸æ¯èº«ä¸€è‡´ã€‚çœŸå®æ„Ÿï¼Œ8kç”»è´¨ã€‚

# Quality Boosters (Randomly pick 2)
(é«˜ç”»è´¨, ç»†èŠ‚æ¸…æ™°, çœŸå®å…‰å½±, ç”µå½±çº§è´¨æ„Ÿ, 8kåˆ†è¾¨ç‡)`;

        // è·å–ç”¨æˆ·è¾“å…¥çš„åŸå§‹æç¤ºè¯
        const userPrompt = promptInput.value.trim();
        const userInstruction = userPrompt 
          ? `${systemPrompt}\n\nç”¨æˆ·éœ€æ±‚ï¼š${userPrompt}\n\nè¯·åˆ†æè¿™4å¼ å‚è€ƒå›¾ç‰‡ï¼Œæ ¹æ®ç”¨æˆ·éœ€æ±‚ç”Ÿæˆä¼˜åŒ–åçš„æç¤ºè¯ï¼š`
          : `${systemPrompt}\n\nè¯·åˆ†æè¿™4å¼ å‚è€ƒå›¾ç‰‡ï¼Œè¯†åˆ«å„å›¾çš„æ ¸å¿ƒå…ƒç´ å¹¶ç”Ÿæˆåˆ›æ„ç»„åˆæç¤ºè¯ï¼š`;

        const parts = [{ text: userInstruction }];
        
        // æ·»åŠ æ‰€æœ‰å·²ä¸Šä¼ çš„å›¾ç‰‡
        for (let i = 1; i <= 4; i++) {
          if (imageSlots[i]) {
            const { base64, mimeType } = await readFileAsBase64(imageSlots[i]);
            parts.push({
              inline_data: {
                mime_type: mimeType || "image/jpeg",
                data: base64,
              },
            });
          }
        }

        const body = {
          contents: [
            {
              role: "user",
              parts: parts,
            },
          ],
        };

        const response = await fetch(OPTIMIZER_MODEL_ENDPOINT(credential), {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${credential}`,
          },
          body: JSON.stringify(body),
        });

        const responseText = await response.text();
        if (!response.ok) {
          throw new Error(`${response.status} ${response.statusText}\n${responseText}`);
        }

        let json;
        try {
          json = JSON.parse(responseText);
        } catch (error) {
          throw new Error("å“åº”å·²è¿”å›ï¼Œä½†è§£æ JSON å¤±è´¥ã€‚");
        }

        const candidates = json?.candidates || [];
        let optimizedText = "";

        candidates.forEach((candidate) => {
          candidate.content?.parts?.forEach((part) => {
            if (part.text) {
              optimizedText += part.text;
            }
          });
        });

        return optimizedText.trim() || promptInput.value.trim();
      };

      // åˆå§‹åŒ–ä¸Šä¼ æ§½ä½
      const initUploadSlots = () => {
        uploadGrid.innerHTML = '';
        for (let i = 1; i <= 4; i++) {
          const slot = document.createElement('label');
          slot.className = 'upload-slot';
          slot.id = `slot-${i}`;
          slot.dataset.slot = i;
          slot.innerHTML = `
            <input type="file" class="file-input" accept="image/*" data-slot="${i}">
            <span class="slot-label">å›¾${i}</span>
            <span class="slot-hint">ç‚¹å‡»ä¸Šä¼ </span>
          `;
          uploadGrid.appendChild(slot);
          
          slot.querySelector('input[type="file"]').addEventListener('change', handleFileChange);
        }
      };

      // å·¥å…·å‡½æ•°
      const readFileAsBase64 = (file) =>
        new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            const result = reader.result;
            const base64 = result.split(",").pop();
            resolve({ base64, mimeType: file.type });
          };
          reader.onerror = () => reject(reader.error);
          reader.readAsDataURL(file);
        });

      const escapeHtml = (value) =>
        value.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;");

      const formatDate = (date) =>
        `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}-${String(date.getDate()).padStart(2, "0")} ${String(date.getHours()).padStart(2, "0")}:${String(date.getMinutes()).padStart(2, "0")}:${String(date.getSeconds()).padStart(2, "0")}`;

      const getExtensionFromMime = (mimeType = "") => {
        const [, subtype = "png"] = mimeType.split("/");
        return subtype.split("+")[0];
      };

      const buildImageHref = ({ mimeType, data, url }) =>
        url || `data:${mimeType || "image/png"};base64,${data}`;

      // æ–‡ä»¶ä¸Šä¼ å¤„ç†
      const handleFileChange = (e) => {
        const slotNum = parseInt(e.target.dataset.slot, 10);
        const file = e.target.files[0];
        if (!file || !file.type.startsWith('image/')) return;
        
        imageSlots[slotNum] = file;
        if (previewUrls[slotNum]) URL.revokeObjectURL(previewUrls[slotNum]);
        
        const objectUrl = URL.createObjectURL(file);
        previewUrls[slotNum] = objectUrl;
        
        const slot = document.getElementById(`slot-${slotNum}`);
        slot.classList.add('has-image');
        slot.innerHTML = `
          <input type="file" class="file-input" accept="image/*" data-slot="${slotNum}">
          <img src="${objectUrl}" alt="å›¾${slotNum}">
          <button type="button" class="delete-btn" data-slot="${slotNum}">âœ•</button>
        `;
        
        slot.querySelector('input[type="file"]').addEventListener('change', handleFileChange);
        slot.querySelector('.delete-btn').addEventListener('click', (ev) => {
          ev.preventDefault();
          ev.stopPropagation();
          removeImage(slotNum);
        });
      };

      const removeImage = (slotNum) => {
        imageSlots[slotNum] = null;
        if (previewUrls[slotNum]) {
          URL.revokeObjectURL(previewUrls[slotNum]);
          previewUrls[slotNum] = null;
        }
        
        const slot = document.getElementById(`slot-${slotNum}`);
        slot.classList.remove('has-image');
        slot.innerHTML = `
          <input type="file" class="file-input" accept="image/*" data-slot="${slotNum}">
          <span class="slot-label">å›¾${slotNum}</span>
          <span class="slot-hint">ç‚¹å‡»ä¸Šä¼ </span>
        `;
        
        slot.querySelector('input[type="file"]').addEventListener('change', handleFileChange);
      };

      // æ¯”ä¾‹æŒ‰é’®åˆ‡æ¢
      const ratioBtns = document.querySelectorAll(".ratio-btn");
      const aspectRatioInput = document.getElementById("aspect-ratio");
      ratioBtns.forEach(btn => {
        btn.addEventListener("click", async () => {
          ratioBtns.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          aspectRatioInput.value = btn.dataset.ratio;
          if (!isRestoring) {
            await pageCache.set('aspectRatio', btn.dataset.ratio, { ttl: null });
          }
        });
      });

      resolutionSelect.addEventListener('change', async () => {
        if (!isRestoring) {
          await pageCache.set('resolution', resolutionSelect.value, { ttl: null });
        }
      });

      // åŠ è½½çŠ¶æ€
      const toggleLoading = (isLoading) => {
        submitBtn.disabled = isLoading;
        if (isLoading) {
          setStatus('æ­£åœ¨ç”Ÿæˆå›¾ç‰‡ï¼Œè¯·ç¨å€™...');
        }
      };

      // ä»»åŠ¡å†å²æ¸²æŸ“
      const renderHistory = () => {
        taskHistory = pruneHistory(taskHistory);
        if (taskHistory.length === 0) {
          historyEmptyState.hidden = false;
          taskHistoryList.innerHTML = "";
          downloadAllBtn.disabled = true;
          return;
        }
        historyEmptyState.hidden = true;
        taskHistoryList.innerHTML = taskHistory.map((entry, index) => {
          const position = taskHistory.length - index;
          const headerTitle = `ä»»åŠ¡ #${position}`;
          const createdAt = entry.createdAt instanceof Date ? entry.createdAt : new Date(entry.createdAt);
          const metaLines = [
            `<span><strong>æ—¶é—´ï¼š</strong>${formatDate(createdAt)}</span>`,
            `<span><strong>æç¤ºè¯ï¼š</strong>${escapeHtml((entry.prompt || "(ç©º)").substring(0, 40))}...</span>`,
          ];
          const imageContent = entry.images.length
            ? entry.images.map((image, imageIndex) => {
                const href = buildImageHref(image);
                const extension = getExtensionFromMime(image.mimeType);
                const preview = image.data ? href : image.url;
                return `
                  <article class="history-image">
                    <img src="${preview}" alt="ç”Ÿæˆå›¾åƒ" loading="lazy" />
                    <div class="history-actions">
                      <button type="button" data-role="download-image" data-task="${entry.id}" data-index="${imageIndex}">
                        ä¸‹è½½ (${extension.toUpperCase()})
                      </button>
                    </div>
                  </article>
                `;
              }).join("")
            : `<p class="helper">æœ¬æ¬¡å“åº”æ²¡æœ‰å›¾åƒè¾“å‡ºã€‚</p>`;
          return `
            <article class="history-item" data-task="${entry.id}">
              <header>
                <div class="history-meta">
                  <strong>${headerTitle}</strong>
                  ${metaLines.join("")}
                </div>
                <div class="history-actions">
                  <button type="button" data-role="download-task" data-task="${entry.id}" ${entry.images.length === 0 ? "disabled" : ""}>
                    ä¸‹è½½è¯¥é¡¹ (${entry.images.length})
                  </button>
                  <button type="button" data-role="delete-task" data-task="${entry.id}" style="margin-left: 8px; color: #ef4444;">
                    åˆ é™¤
                  </button>
                </div>
              </header>
              <div class="history-image-grid">${imageContent}</div>
            </article>
          `;
        }).join("");
        downloadAllBtn.disabled = !taskHistory.some((entry) => entry.images.length > 0);
      };

      const recordTask = async ({ prompt, images }) => {
        const entry = {
          id: `task-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
          createdAt: new Date(),
          prompt,
          images,
        };
        taskHistory.unshift(entry);
        taskHistory = pruneHistory(taskHistory);
        renderHistory();
        await pageCache.set('taskHistory', prepareHistoryForStorage(taskHistory), { ttl: null });
        
        // ä¿å­˜åˆ°æœåŠ¡å™¨
        const apiKey = credentialInput.value.trim();
        if (apiKey && images.length > 0) {
          try {
            const serverImages = images.map(img => {
              if (img.data && img.mimeType) {
                return { base64: `data:${img.mimeType};base64,${img.data}` };
              }
              if (img.url) {
                return { url: img.url };
              }
              return img;
            });
            await ImageServer.saveGeneration(apiKey, prompt, serverImages, 'gemini-situcankao', 'multi');
          } catch (e) {
            console.warn('ä¿å­˜åˆ°æœåŠ¡å™¨å¤±è´¥:', e);
          }
        }
      };

      // ä¸‹è½½åŠŸèƒ½
      const triggerDownload = (href, filename) => {
        const link = document.createElement("a");
        link.href = href;
        link.download = filename;
        link.rel = "noopener";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      downloadAllBtn.addEventListener("click", () => {
        const downloadables = taskHistory.flatMap((entry, entryIndex) =>
          entry.images.map((image, imageIndex) => ({
            href: buildImageHref(image),
            filename: `${entry.id}-${String(imageIndex + 1).padStart(2, "0")}.${getExtensionFromMime(image.mimeType)}`,
            order: entryIndex * 100 + imageIndex,
          }))
        );
        if (downloadables.length === 0) {
          setStatus('æš‚æ— å¯ä¸‹è½½çš„å›¾åƒã€‚', '');
          return;
        }
        downloadables.sort((a, b) => a.order - b.order).forEach((item, index) => {
          setTimeout(() => triggerDownload(item.href, item.filename), index * 180);
        });
        setStatus(`å·²å¼€å§‹ä¸‹è½½ ${downloadables.length} å¼ å›¾åƒã€‚`, 'success');
      });

      taskHistoryList.addEventListener("click", (event) => {
        const button = event.target.closest("button[data-role]");
        if (!button) return;
        const taskId = button.getAttribute("data-task");
        const entry = taskHistory.find((item) => item.id === taskId);
        if (!entry) return;
        if (button.dataset.role === "download-task") {
          entry.images.forEach((image, index) => {
            const extension = getExtensionFromMime(image.mimeType);
            const filename = `${entry.id}-${String(index + 1).padStart(2, "0")}.${extension}`;
            setTimeout(() => triggerDownload(buildImageHref(image), filename), index * 150);
          });
          return;
        }
        if (button.dataset.role === "download-image") {
          const imageIndex = Number(button.getAttribute("data-index"));
          const image = entry.images[imageIndex];
          if (!image) return;
          const extension = getExtensionFromMime(image.mimeType);
          const filename = `${entry.id}-${String(imageIndex + 1).padStart(2, "0")}.${extension}`;
          triggerDownload(buildImageHref(image), filename);
        }
        if (button.dataset.role === "delete-task") {
          if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
            taskHistory = taskHistory.filter((item) => item.id !== taskId);
            renderHistory();
            pageCache.set('taskHistory', prepareHistoryForStorage(taskHistory), { ttl: null });
          }
        }
      });

      // API è¯·æ±‚
      const buildRequestBody = async (customPrompt = null) => {
        const prompt = customPrompt || promptInput.value.trim();
        const aspectRatio = aspectRatioInput.value;
        const targetResolution = Number(resolutionSelect.value);
        
        const parts = [{ text: prompt }];
        
        // æ·»åŠ æ‰€æœ‰å·²ä¸Šä¼ çš„å›¾ç‰‡
        for (let i = 1; i <= 4; i++) {
          if (imageSlots[i]) {
            const { base64, mimeType } = await readFileAsBase64(imageSlots[i]);
            parts.push({
              inline_data: {
                mime_type: mimeType || "image/jpeg",
                data: base64,
              },
            });
          }
        }
        
        return {
          contents: [{ role: "user", parts }],
          generationConfig: {
            responseModalities: ["IMAGE"],
            imageConfig: { 
              aspectRatio,
              targetResolution,
            },
          },
        };
      };

      // æ‰§è¡ŒAPIè¯·æ±‚ï¼ˆæ”¯æŒè‡ªåŠ¨åˆ‡æ¢å¤‡ç”¨Keyï¼‰
      const executeRequest = async (body, apiKey) => {
        const doRequest = async (key) => {
          const response = await fetch(MODEL_ENDPOINT(key), {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${key}`,
            },
            body: JSON.stringify(body),
          });

          const responseText = await response.text();
          if (!response.ok) {
            throw new Error(`${response.status} ${response.statusText}\n${responseText}`);
          }

          let json;
          try {
            json = JSON.parse(responseText);
          } catch (error) {
            throw new Error("å“åº”å·²è¿”å›ï¼Œä½†è§£æ JSON å¤±è´¥ã€‚");
          }
          return { json };
        };

        // è·å–å¤‡ç”¨Key
        const backupKey = window.DuuApiKeys ? window.DuuApiKeys.getBackup('gemini') : '';

        try {
          return await doRequest(apiKey);
        } catch (error) {
          const errorMsg = error.message || '';
          // åˆ¤æ–­æ˜¯å¦éœ€è¦åˆ‡æ¢Key
          if (backupKey && backupKey !== apiKey && window.shouldRetryWithBackup && window.shouldRetryWithBackup(errorMsg)) {
            console.log('é¦–é€‰Keyå¤±è´¥ï¼Œå°è¯•å¤‡ç”¨Key...', errorMsg);
            setStatus('é¦–é€‰Keyä¸å¯ç”¨ï¼Œæ­£åœ¨å°è¯•å¤‡ç”¨Key...');
            return await doRequest(backupKey);
          }
          throw error;
        }
      };

      const renderImageOutputs = (candidates = []) => {
        const images = [];
        candidates.forEach((candidate) => {
          candidate.content?.parts?.forEach((part) => {
            const inlineData = part.inline_data ?? (part.inlineData ? { mime_type: part.inlineData.mimeType, data: part.inlineData.data } : null);
            if (inlineData?.mime_type && inlineData?.data) {
              images.push({ mimeType: inlineData.mime_type, data: inlineData.data });
            }
          });
        });
        if (images.length === 0) {
          imageOutput.innerHTML = "";
          outputSection.hidden = true;
          return images;
        }
        outputSection.hidden = false;
        imageOutput.innerHTML = images.map(({ mimeType, data }) => {
          const src = `data:${mimeType};base64,${data}`;
          return `<figure><img src="${src}" alt="ç”Ÿæˆå›¾åƒ" /><figcaption>${mimeType}</figcaption></figure>`;
        }).join("");
        return images;
      };

      // ä¸»æäº¤
      submitBtn.addEventListener("click", async () => {
        try {
          toggleLoading(true);
          imageOutput.innerHTML = "";
          setStatus('', '');

          const credential = credentialInput.value.trim();
          if (!credential) {
            setStatus("è¯·ç²˜è´´è®¿é—®å‡­è¯ã€‚", 'error');
            toggleLoading(false);
            return;
          }

          let prompt = promptInput.value.trim();
          if (!prompt) {
            setStatus("è¯·è¾“å…¥æç¤ºè¯ã€‚", 'error');
            toggleLoading(false);
            return;
          }

          // æ£€æŸ¥æ˜¯å¦è‡³å°‘ä¸Šä¼ äº†ä¸€å¼ å›¾ç‰‡
          const hasImage = Object.values(imageSlots).some(slot => slot !== null);
          if (!hasImage) {
            setStatus("è¯·è‡³å°‘ä¸Šä¼ ä¸€å¼ å‚è€ƒå›¾ç‰‡ã€‚", 'error');
            toggleLoading(false);
            return;
          }

          // å¦‚æœå¯ç”¨äº†æç¤ºè¯ä¼˜åŒ–ï¼Œå…ˆä¼˜åŒ–æç¤ºè¯
          if (optimizeToggle && optimizeToggle.checked) {
            setStatus("æ­£åœ¨åˆ†æå›¾ç‰‡ï¼Œä¼˜åŒ–æç¤ºè¯ä¸­...");
            try {
              const optimizedPrompt = await optimizePromptForImages(imageSlots, credential);
              if (optimizedPrompt) {
                prompt = optimizedPrompt;
                console.log("ä¼˜åŒ–åçš„æç¤ºè¯:", prompt);
              }
            } catch (optError) {
              console.warn("æç¤ºè¯ä¼˜åŒ–å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æç¤ºè¯:", optError);
              setStatus("æç¤ºè¯ä¼˜åŒ–å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æç¤ºè¯ç»§ç»­...", 'warning');
              await new Promise(r => setTimeout(r, 1000));
            }
          }

          setStatus("æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...");

          const body = await buildRequestBody(prompt);
          const { json } = await executeRequest(body, credential);
          const candidates = json.candidates || [];
          const images = renderImageOutputs(candidates);
          
          await recordTask({ prompt, images: images || [] });
          setStatus("ç”Ÿæˆå®Œæˆï¼", 'success');
        } catch (error) {
          console.error(error);
          setStatus(`è¯·æ±‚å¼‚å¸¸ï¼š${error.message}`, 'error');
        } finally {
          toggleLoading(false);
        }
      });

      // é¡µé¢åŠ è½½æ—¶æ¢å¤ç¼“å­˜çŠ¶æ€
      (async function restoreCachedState() {
        isRestoring = true;
        
        try {
          const [cachedApiKey, cachedPrompt, cachedAspectRatio, cachedResolution, cachedHistory] = await Promise.all([
            pageCache.get('apiKey'),
            pageCache.get('prompt'),
            pageCache.get('aspectRatio'),
            pageCache.get('resolution'),
            pageCache.get('taskHistory')
          ]);
          
          if (cachedApiKey && credentialInput) {
            credentialInput.value = cachedApiKey;
          }
          
          if (cachedPrompt && promptInput) {
            promptInput.value = cachedPrompt;
          }
          
          if (cachedAspectRatio) {
            aspectRatioInput.value = cachedAspectRatio;
            ratioBtns.forEach(btn => {
              btn.classList.toggle('active', btn.dataset.ratio === cachedAspectRatio);
            });
          }
          
          if (cachedResolution && resolutionSelect) {
            resolutionSelect.value = cachedResolution;
          }
          
          isRestoring = false;
          
          setTimeout(() => {
            if (cachedHistory && Array.isArray(cachedHistory)) {
              taskHistory = restoreHistoryFromStorage(cachedHistory);
              taskHistory = taskHistory.slice(0, MAX_HISTORY_ENTRIES);
              renderHistory();
            }
          }, 100);
          
        } catch (error) {
          console.error('æ¢å¤ç¼“å­˜çŠ¶æ€å¤±è´¥:', error);
          isRestoring = false;
        }
      })();

      // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
      window.addEventListener('beforeunload', () => {
        Object.values(previewUrls).forEach(url => {
          if (url) URL.revokeObjectURL(url);
        });
      });

      // åˆå§‹åŒ–
      initUploadSlots();
      renderHistory();
    </script>
</body>
</html>
