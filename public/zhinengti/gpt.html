<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPT - AIæ™ºèƒ½ä½“</title>
    <!-- Markdown æ¸²æŸ“ + ä»£ç é«˜äº® -->
    <script src="../vendor/marked/marked.umd.js"></script>
    <link rel="stylesheet" href="../vendor/highlight/styles/github-dark.min.css">
    <script src="../vendor/highlight/highlight.bundle.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* ä¸»é¢˜å˜é‡ */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f7f7f8;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #374151;
            --text-muted: #6b7280;
            --text-placeholder: #9ca3af;
            --border-color: #e5e5e5;
            --border-light: #e5e7eb;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
            --user-msg-bg: #3b82f6;
            --user-msg-text: #ffffff;
            --assistant-msg-bg: #f3f4f6;
            --assistant-msg-text: #111827;
        }
        
        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #252525;
            --bg-tertiary: #2d2d2d;
            --text-primary: #e5e5e5;
            --text-secondary: #b0b0b0;
            --text-muted: #808080;
            --text-placeholder: #606060;
            --border-color: #3a3a3a;
            --border-light: #404040;
            --accent-color: #10b981;
            --accent-hover: #059669;
            --user-msg-bg: #10b981;
            --user-msg-text: #ffffff;
            --assistant-msg-bg: #2d2d2d;
            --assistant-msg-text: #e5e5e5;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif; 
            background: var(--bg-primary); 
            color: var(--text-primary);
            height: 100vh; 
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }
        
        .chat-container { display: flex; height: 100vh; }
        
        /* å·¦ä¾§å†å²è®°å½• */
        .chat-sidebar { width: 260px; background: var(--bg-secondary); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; }
        .sidebar-header { padding: 16px; border-bottom: 1px solid var(--border-color); }
        .new-chat-btn { width: 100%; padding: 10px 16px; background: var(--bg-primary); border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; }
        .new-chat-btn:hover { background: var(--bg-tertiary); }
        .search-input { width: 100%; margin-top: 10px; padding: 8px 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 13px; background: var(--bg-primary); color: var(--text-primary); outline: none; }
        .search-input:focus { border-color: var(--accent-color); }
        .search-input::placeholder { color: var(--text-placeholder); }
        .chat-history { flex: 1; overflow-y: auto; padding: 8px; }
        .history-item { padding: 10px 12px; margin-bottom: 4px; border-radius: 8px; font-size: 14px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; position: relative; }
        .history-item:hover { background: var(--bg-tertiary); }
        .history-item.active { background: var(--bg-tertiary); }
        .history-item.pinned { border-left: 3px solid var(--accent-color); }
        .history-item-text { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .history-item-pin { opacity: 0; width: 20px; height: 20px; border-radius: 4px; background: var(--accent-color); color: #fff; border: none; font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-right: 4px; }
        .history-item-pin.pinned { opacity: 1; background: #f59e0b; }
        .history-item:hover .history-item-pin { opacity: 1; }
        .history-item-delete { opacity: 0; width: 20px; height: 20px; border-radius: 4px; background: #ef4444; color: #fff; border: none; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .history-item:hover .history-item-delete { opacity: 1; }
        .sidebar-footer { padding: 12px; border-top: 1px solid var(--border-color); }
        .back-home-btn { width: 100%; padding: 8px 12px; background: transparent; border: 1px solid var(--border-light); border-radius: 6px; font-size: 13px; color: var(--text-muted); cursor: pointer; }
        .back-home-btn:hover { background: var(--bg-tertiary); }
        
        /* å³ä¾§å¯¹è¯åŒº */
        .chat-main { flex: 1; display: flex; flex-direction: column; background: var(--bg-primary); }
        .chat-header { padding: 16px 24px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; }
        .chat-title { font-size: 16px; font-weight: 600; color: var(--text-primary); }
        .header-actions { display: flex; align-items: center; gap: 12px; }
        .api-hint { font-size: 13px; color: #ef4444; font-weight: 500; animation: redBlink 1s ease-in-out infinite; }
        @keyframes redBlink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .api-hint.hidden { display: none; }
        .settings-btn { width: 40px; height: 40px; background: var(--bg-tertiary); border: 1px solid var(--border-light); border-radius: 8px; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .settings-btn:hover { background: var(--accent-color); color: #fff; border-color: var(--accent-color); }
        
        .chat-messages { flex: 1; overflow-y: auto; padding: 24px; }
        .message { margin-bottom: 24px; display: flex; gap: 16px; position: relative; }
        .message.user { flex-direction: row-reverse; }
        .message-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--bg-tertiary); display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
        .message.user .message-avatar { background: var(--user-msg-bg); color: #fff; }
        .message-body { max-width: 70%; position: relative; }
        .message-content { padding: 12px 16px; border-radius: 12px; font-size: 14px; line-height: 1.6; word-break: break-word; }
        .message.user .message-content { background: var(--user-msg-bg); color: var(--user-msg-text); border-radius: 12px 12px 0 12px; white-space: pre-wrap; }
        .message.assistant .message-content { background: var(--assistant-msg-bg); color: var(--assistant-msg-text); border-radius: 12px 12px 12px 0; }
        .message-actions { display: flex; gap: 4px; margin-top: 6px; opacity: 0; transition: opacity 0.2s; }
        .message:hover .message-actions { opacity: 1; }
        .message.user .message-actions { justify-content: flex-end; }
        .msg-action-btn { padding: 4px 8px; background: var(--bg-tertiary); border: 1px solid var(--border-light); border-radius: 6px; font-size: 12px; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; gap: 4px; transition: all 0.2s; }
        .msg-action-btn:hover { background: var(--accent-color); color: #fff; border-color: var(--accent-color); }
        .message-time { font-size: 11px; color: var(--text-placeholder); margin-top: 4px; }
        .message.user .message-time { text-align: right; }
        
        /* Markdown æ ·å¼ */
        .message-content p { margin: 0 0 12px 0; }
        .message-content p:last-child { margin-bottom: 0; }
        .message-content h1, .message-content h2, .message-content h3 { margin: 16px 0 8px 0; font-weight: 600; }
        .message-content h1 { font-size: 1.4em; }
        .message-content h2 { font-size: 1.2em; }
        .message-content h3 { font-size: 1.1em; }
        .message-content ul, .message-content ol { margin: 8px 0; padding-left: 24px; }
        .message-content li { margin: 4px 0; }
        .message-content code { background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 4px; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.9em; }
        .message-content pre { margin: 12px 0; border-radius: 8px; overflow: hidden; position: relative; }
        .message-content pre code { display: block; padding: 16px; background: #1e1e1e; color: #d4d4d4; overflow-x: auto; font-size: 13px; line-height: 1.5; }
        .message-content blockquote { margin: 12px 0; padding: 8px 16px; border-left: 4px solid var(--accent-color); background: rgba(0,0,0,0.05); }
        .message-content a { color: var(--accent-color); text-decoration: none; }
        .message-content a:hover { text-decoration: underline; }
        .message-content table { border-collapse: collapse; margin: 12px 0; width: 100%; }
        .message-content th, .message-content td { border: 1px solid var(--border-light); padding: 8px 12px; text-align: left; }
        .message-content th { background: var(--bg-tertiary); font-weight: 600; }
        .code-copy-btn { position: absolute; top: 8px; right: 8px; padding: 4px 8px; background: rgba(255,255,255,0.1); border: none; border-radius: 4px; color: #aaa; font-size: 12px; cursor: pointer; opacity: 0; transition: opacity 0.2s; }
        .message-content pre:hover .code-copy-btn { opacity: 1; }
        .code-copy-btn:hover { background: rgba(255,255,255,0.2); color: #fff; }
        
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); }
        .empty-state-icon { font-size: 64px; margin-bottom: 16px; }
        .empty-state-text { font-size: 18px; font-weight: 500; margin-bottom: 8px; }
        .empty-state-desc { font-size: 14px; }
        
        /* è¾“å…¥åŒº */
        .chat-input-area { padding: 20px 24px 24px; background: var(--bg-secondary); border-top: 1px solid var(--border-color); }
        .input-container { max-width: 900px; margin: 0 auto; background: var(--bg-primary); border: 2px solid var(--border-light); border-radius: 16px; overflow: hidden; }
        .input-container:focus-within { border-color: var(--accent-color); }
        .input-content { padding: 12px 16px; }
        .file-preview-area { display: none; padding: 12px 0 8px; border-bottom: 1px solid var(--bg-tertiary); margin-bottom: 8px; }
        .file-preview-area.has-files { display: block; }
        .file-preview-list { display: flex; gap: 8px; flex-wrap: wrap; }
        .file-preview-item { position: relative; padding: 8px 12px; background: var(--bg-tertiary); border-radius: 8px; font-size: 13px; color: var(--text-secondary); display: flex; align-items: center; gap: 6px; }
        .file-preview-item .remove-file { position: absolute; top: -6px; right: -6px; width: 18px; height: 18px; background: #ef4444; color: #fff; border: none; border-radius: 50%; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .input-row { display: flex; gap: 8px; align-items: flex-end; }
        .chat-input { flex: 1; min-height: 24px; max-height: 200px; padding: 0; border: none; font-size: 15px; font-family: inherit; resize: none; outline: none; line-height: 1.5; color: var(--text-primary); background: transparent; }
        .chat-input::placeholder { color: var(--text-placeholder); }
        .input-actions { display: flex; gap: 6px; align-items: center; }
        .action-btn { width: 36px; height: 36px; background: transparent; border: none; border-radius: 8px; font-size: 20px; cursor: pointer; color: var(--text-muted); }
        .action-btn:hover { background: var(--bg-tertiary); color: var(--text-secondary); }
        .send-btn { width: 36px; height: 36px; background: var(--accent-color); color: #fff; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .send-btn:hover { transform: scale(1.05); }
        .send-btn:disabled { background: var(--text-muted); cursor: not-allowed; transform: none; }
        .send-btn svg { width: 18px; height: 18px; fill: currentColor; }
        .send-btn svg.spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .stop-btn { width: 36px; height: 36px; background: #ef4444; color: #fff; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .stop-btn:hover { background: #dc2626; transform: scale(1.05); }
        .stop-btn svg { width: 14px; height: 14px; fill: currentColor; }
        .input-hint { padding: 8px 16px 4px; font-size: 12px; color: var(--text-placeholder); display: flex; justify-content: space-between; }
        .token-count { color: var(--text-muted); }
</style>
</head>
<body>
    <div class="chat-container">
        <aside class="chat-sidebar" id="chatSidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" onclick="newChat()"><span>â•</span><span>æ–°å»ºå¯¹è¯</span></button>
                <input type="text" class="search-input" id="searchInput" placeholder="ğŸ” æœç´¢å†å²å¯¹è¯..." oninput="filterHistory()" autocomplete="off">
            </div>
            <div class="chat-history" id="chatHistory"></div>
            <div class="sidebar-footer">
            </div>
        </aside>
        
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
        <main class="chat-main">
            <header class="chat-header">
                <div style="display:flex;align-items:center;gap:12px;">
                    <button class="menu-btn" onclick="toggleSidebar()" title="èœå•">â˜°</button>
                    <h1 class="chat-title">ğŸš€ GPT</h1>
                </div>
                <div class="header-actions">
                    <span class="api-hint" id="apiHint">âš ï¸ è¯·å…ˆè¿›è¡Œè®¾ç½®ï¼Œå¡«å†™API Keyï¼</span>
                    <button class="settings-btn" onclick="clearChat()" title="æ¸…ç©ºå¯¹è¯">ğŸ§¹</button>
                    <button class="settings-btn" onclick="exportChat()" title="å¯¼å‡ºå¯¹è¯">ğŸ“¥</button>
                    <button class="settings-btn" onclick="openSettings()" title="è®¾ç½®">âš™ï¸</button>
                </div>
            </header>
            
            <div class="chat-messages" id="chatMessages">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸš€</div>
                    <div class="empty-state-text">å¼€å§‹ä¸ GPT å¯¹è¯</div>
                    <div class="empty-state-desc">ç‚¹å‡»å³ä¸Šè§’ âš™ï¸ è®¾ç½® API Key å’Œæ¨¡å‹</div>
                </div>
            </div>
            
            <div class="chat-input-area">
                <input type="file" id="fileInput" accept="image/*,.pdf,.txt,.doc,.docx,.json,.xml,.csv,.md,.js,.py,.java,.cpp,.html,.css" multiple style="display: none;">
                <div class="input-container">
                    <div class="input-content">
                        <div id="filePreviewArea" class="file-preview-area">
                            <div id="filePreviewList" class="file-preview-list"></div>
                        </div>
                        <div class="input-row">
                            <textarea class="chat-input" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1" autocomplete="off"></textarea>
                            <div class="input-actions">
                                <button class="action-btn" onclick="document.getElementById('fileInput').click()" title="ä¸Šä¼ æ–‡ä»¶">ğŸ“</button>
                                <button class="send-btn" id="sendBtn" onclick="sendMessage()" title="å‘é€"><svg viewBox="0 0 24 24"><path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z"/></svg></button>
                                <button class="stop-btn" id="stopBtn" onclick="stopGeneration()" title="åœæ­¢ç”Ÿæˆ" style="display:none;"><svg viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="2"/></svg></button>
                            </div>
                        </div>
                    </div>
                    <div class="input-hint">
                        <span>Shift + Enter æ¢è¡Œ Â· æ”¯æŒå›¾ç‰‡ã€PDFã€æ–‡æ¡£ç­‰</span>
                        <span class="token-count" id="tokenCount">é¢„ä¼°: 0 tokens</span>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- è®¾ç½®å¼¹çª— -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-overlay" onclick="closeSettings()"></div>
        <div class="settings-panel">
            <div class="settings-header">
                <h2>âš™ï¸ è®¾ç½®</h2>
                <button class="settings-close" onclick="closeSettings()">Ã—</button>
            </div>
            <div class="settings-body">
                <div class="setting-group">
                    <label class="setting-label">ğŸ”‘ API Key</label>
                    <input type="password" id="settingsApiKey" class="setting-input" placeholder="è¾“å…¥ä½ çš„ API Key" autocomplete="off">
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">ğŸ¤– æ¨¡å‹</label>
                    <select id="settingsModel" class="setting-select">
                        <option value="gpt-5.2" selected>GPT-5.2 (æ¨è)</option>
                        <option value="gpt-5.2-pro">GPT-5.2 Pro (æ£˜æ‰‹é—®é¢˜Â·å¯èƒ½éœ€å‡ åˆ†é’Ÿ)</option>
                        <option value="gpt-5.1-2025-11-13">GPT-5.1 (2025-11-13)</option>
                        <option value="gpt-5">GPT-5</option>
                    </select>
                    <input type="text" id="customModel" class="setting-input" placeholder="æˆ–è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹åç§°" style="margin-top: 8px;" autocomplete="off">
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">ğŸ“š ä¸Šä¸‹æ–‡æ•°é‡ <span id="contextValue">10</span> æ¡</label>
                    <input type="range" id="settingsContext" class="setting-range" min="1" max="50" value="10">
                    <div class="setting-hint">æ›´å¤šä¸Šä¸‹æ–‡è®°å¿†æ›´ç²¾ç¡®ï¼Œä½†æ¶ˆè€—æ›´å¤šé¢åº¦</div>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">ğŸ“ æœ€å¤§å›å¤é•¿åº¦ <span id="maxTokensValue">4096</span></label>
                    <input type="range" id="settingsMaxTokens" class="setting-range" min="256" max="16384" step="256" value="4096">
                    <div class="setting-hint">max_tokens è¶Šå¤§ï¼Œå¯èƒ½æ¶ˆè€—æ›´å¤šé¢åº¦</div>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">ğŸ­ è§’è‰²è®¾å®š</label>
                    <textarea id="settingsSystemPrompt" class="setting-textarea" placeholder="ç»™ä¼šè¯è®¾ç½®ä¸“å±è§’è‰²ï¼ˆå¯é€‰ï¼‰"></textarea>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">ğŸ¨ ä¸»é¢˜</label>
                    <div class="theme-toggle">
                        <button class="theme-btn active" data-theme="light" onclick="setTheme('light')">â˜€ï¸ ç™½å¤©</button>
                        <button class="theme-btn" data-theme="dark" onclick="setTheme('dark')">ğŸŒ™ å¤œé—´</button>
                    </div>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">ğŸ’° ä»·æ ¼å‚è€ƒ <span class="price-hint-blink">ä»·æ ¼ä»…ä¾›å‚è€ƒï¼ŒæœªåŠ ä¼˜æƒ æŠ˜æ‰£ï¼Œå®é™…æ›´ä¾¿å®œ</span></label>
                    <div class="price-table" id="priceInfo">
                        <div class="price-header">
                            <span>åˆ†ç»„</span>
                            <span>æç¤º</span>
                            <span>è¡¥å…¨</span>
                        </div>
                        <div class="price-row"><span>é™æ—¶ç‰¹ä»·åˆ†ç»„</span><span class="price-cell">Â¥0.7880<br><small>/ 1M tokens</small></span><span class="price-cell">Â¥6.3000<br><small>/ 1M tokens</small></span></div>
                        <div class="price-row"><span>Codexä¸“å±åˆ†ç»„</span><span class="price-cell">Â¥1.0500<br><small>/ 1M tokens</small></span><span class="price-cell">Â¥8.4000<br><small>/ 1M tokens</small></span></div>
                        <div class="price-row"><span>defaultåˆ†ç»„</span><span class="price-cell">Â¥1.3130<br><small>/ 1M tokens</small></span><span class="price-cell">Â¥10.5000<br><small>/ 1M tokens</small></span></div>
                        <div class="price-row"><span>é€†å‘åˆ†ç»„</span><span class="price-cell">Â¥1.8370<br><small>/ 1M tokens</small></span><span class="price-cell">Â¥14.7000<br><small>/ 1M tokens</small></span></div>
                        <div class="price-row"><span>çº¯AZåˆ†ç»„</span><span class="price-cell">Â¥1.9690<br><small>/ 1M tokens</small></span><span class="price-cell">Â¥15.7500<br><small>/ 1M tokens</small></span></div>
                        <div class="price-row"><span>å®˜è½¬åˆ†ç»„</span><span class="price-cell">Â¥3.9380<br><small>/ 1M tokens</small></span><span class="price-cell">Â¥31.5000<br><small>/ 1M tokens</small></span></div>
                        <div class="price-row"><span>å®˜è½¬OpenAIåˆ†ç»„</span><span class="price-cell">Â¥7.8750<br><small>/ 1M tokens</small></span><span class="price-cell">Â¥63.0000<br><small>/ 1M tokens</small></span></div>
                        <div class="price-row"><span>ä¼˜è´¨å®˜è½¬OpenAIåˆ†ç»„</span><span class="price-cell">Â¥10.5000<br><small>/ 1M tokens</small></span><span class="price-cell">Â¥84.0000<br><small>/ 1M tokens</small></span></div>
                    </div>
                </div>
            </div>
            <div class="settings-footer">
                <button class="btn-reset" onclick="resetSettings()">æ¢å¤é»˜è®¤</button>
                <button class="btn-save" onclick="saveSettings()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <style>
        /* è®¾ç½®å¼¹çª—æ ·å¼ */
        .settings-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 1000; }
        .settings-modal.open { display: flex; align-items: center; justify-content: center; }
        .settings-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); }
        .settings-panel { position: relative; width: 90%; max-width: 500px; max-height: 90vh; background: var(--bg-primary); border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; }
        .settings-header { padding: 16px 20px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; }
        .settings-header h2 { font-size: 18px; font-weight: 600; color: var(--text-primary); }
        .settings-close { width: 32px; height: 32px; background: var(--bg-tertiary); border: none; border-radius: 8px; font-size: 20px; cursor: pointer; color: var(--text-muted); }
        .settings-close:hover { background: #ef4444; color: #fff; }
        .settings-body { flex: 1; overflow-y: auto; padding: 20px; }
        .setting-group { margin-bottom: 20px; }
        .setting-label { display: block; font-size: 14px; font-weight: 500; color: var(--text-primary); margin-bottom: 8px; }
        .setting-input { width: 100%; padding: 10px 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; background: var(--bg-primary); color: var(--text-primary); }
        .setting-input:focus { outline: none; border-color: var(--accent-color); }
        .setting-select { width: 100%; padding: 10px 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; background: var(--bg-primary); color: var(--text-primary); }
        .setting-range { width: 100%; height: 6px; border-radius: 3px; background: var(--bg-tertiary); -webkit-appearance: none; appearance: none; }
        .setting-range::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--accent-color); cursor: pointer; }
        .setting-hint { font-size: 12px; color: var(--text-muted); margin-top: 6px; }
        .setting-textarea { width: 100%; height: 80px; padding: 10px 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; background: var(--bg-primary); color: var(--text-primary); resize: none; font-family: inherit; }
        .theme-toggle { display: flex; gap: 8px; }
        .theme-btn { flex: 1; padding: 10px; border: 2px solid var(--border-light); border-radius: 8px; background: var(--bg-primary); color: var(--text-secondary); font-size: 14px; cursor: pointer; transition: all 0.2s; }
        .theme-btn.active { border-color: var(--accent-color); background: var(--accent-color); color: #fff; }
        .price-table { background: var(--bg-tertiary); border-radius: 8px; padding: 12px; }
        .price-header { display: grid; grid-template-columns: 1fr 1fr 1fr; padding: 8px 0; font-size: 13px; color: var(--text-tertiary); border-bottom: 1px solid var(--border-light); text-align: center; }
        .price-header span:first-child { text-align: left; }
        .price-row { display: grid; grid-template-columns: 1fr 1fr 1fr; padding: 10px 0; font-size: 13px; color: var(--text-secondary); border-bottom: 1px solid var(--border-light); align-items: center; }
        .price-row:last-child { border-bottom: none; }
        .price-row span:first-child { font-weight: 500; }
        .price-cell { text-align: center; color: #f5a623; font-weight: 600; }
        .price-cell small { color: var(--text-tertiary); font-weight: 400; }
        @keyframes redBlink { 0%, 100% { color: #ff4444; } 50% { color: #ff0000; opacity: 0.6; } }
        .price-hint-blink { animation: redBlink 1s ease-in-out infinite; font-size: 12px; font-weight: normal; }
        .settings-footer { padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; gap: 12px; justify-content: flex-end; }
        .btn-reset { padding: 10px 20px; border: 1px solid var(--border-light); border-radius: 8px; background: var(--bg-primary); color: var(--text-secondary); font-size: 14px; cursor: pointer; }
        .btn-save { padding: 10px 24px; border: none; border-radius: 8px; background: var(--accent-color); color: #fff; font-size: 14px; font-weight: 500; cursor: pointer; }
        .btn-save:hover { background: var(--accent-hover); }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .chat-sidebar { 
                position: fixed; 
                left: -280px; 
                top: 0; 
                height: 100vh; 
                z-index: 1000; 
                transition: left 0.3s;
                width: 280px;
            }
            .chat-sidebar.open { left: 0; }
            .sidebar-overlay { 
                display: none; 
                position: fixed; 
                top: 0; left: 0; right: 0; bottom: 0; 
                background: rgba(0,0,0,0.5); 
                z-index: 999; 
            }
            .sidebar-overlay.open { display: block; }
            .menu-btn { display: flex !important; }
            .settings-panel { width: 95%; max-height: 85vh; }
        }
        .menu-btn { 
            display: none; 
            width: 40px; height: 40px; 
            background: var(--bg-tertiary); 
            border: 1px solid var(--border-light); 
            border-radius: 8px; 
            font-size: 20px; 
            cursor: pointer; 
            align-items: center; 
            justify-content: center; 
        }
        .menu-btn:hover { background: var(--accent-color); color: #fff; }
    </style>

    <script src="../scripts/duu-db.js"></script>
    <script>
        // ========== å…¨å±€å˜é‡ ==========
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const chatHistory = document.getElementById('chatHistory');
        const fileInput = document.getElementById('fileInput');
        const filePreviewArea = document.getElementById('filePreviewArea');
        const filePreviewList = document.getElementById('filePreviewList');
        
        let uploadedFiles = [];
        let messages = [];
        let sessions = [];
        let currentSessionId = null;
        let abortController = null;
        
        // è®¾ç½®é¡¹
        let settings = {
            apiKey: '',
            model: 'gpt-5.2',
            customModel: '',
            contextCount: 10,
            maxTokens: 4096,
            systemPrompt: '',
            theme: 'light'
        };
        
        // ========== åˆå§‹åŒ– ==========
        async function init() {
            loadSettings();
            loadSessions();
            applyTheme();
            updateApiHint();
            
            if (sessions.length === 0) {
                createNewSession();
            } else {
                loadSession(sessions[0].id);
            }
            renderHistory();
            loadDraft();
        }
        
        // ========== è‰ç¨¿åŠŸèƒ½ ==========
        function saveDraft() {
            localStorage.setItem('gpt-draft', chatInput.value);
        }
        
        function loadDraft() {
            const draft = localStorage.getItem('gpt-draft');
            if (draft) {
                chatInput.value = draft;
                chatInput.style.height = 'auto';
                chatInput.style.height = Math.min(chatInput.scrollHeight, 200) + 'px';
                updateTokenCount();
            }
        }
        
        function clearDraft() {
            localStorage.removeItem('gpt-draft');
        }
        
        function updateApiHint() {
            const hint = document.getElementById('apiHint');
            if (hint) {
                hint.classList.toggle('hidden', !!settings.apiKey);
            }
        }
        
        // ========== è®¾ç½®ç›¸å…³ ==========
        function loadSettings() {
            const saved = localStorage.getItem('gpt-settings');
            if (saved) {
                settings = { ...settings, ...JSON.parse(saved) };
                // æ£€æŸ¥å­˜å‚¨çš„ model æ˜¯å¦åœ¨å¯é€‰åˆ—è¡¨ä¸­ï¼Œä¸åœ¨åˆ™é‡ç½®ä¸ºé»˜è®¤
                const validModels = ['gpt-5.2', 'gpt-5.2-pro', 'gpt-5.1-2025-11-13', 'gpt-5'];
                if (!validModels.includes(settings.model)) {
                    settings.model = 'gpt-5.2';
                }
            }
        }
        
        function saveSettingsToStorage() {
            localStorage.setItem('gpt-settings', JSON.stringify(settings));
        }
        
        // æ¨¡å‹ä»·æ ¼é…ç½®
        const modelPrices = {
            'gpt-5.2': [
                { name: 'é™æ—¶ç‰¹ä»·åˆ†ç»„', input: '0.7880', output: '6.3000' },
                { name: 'Codexä¸“å±åˆ†ç»„', input: '1.0500', output: '8.4000' },
                { name: 'defaultåˆ†ç»„', input: '1.3130', output: '10.5000' },
                { name: 'é€†å‘åˆ†ç»„', input: '1.8370', output: '14.7000' },
                { name: 'çº¯AZåˆ†ç»„', input: '1.9690', output: '15.7500' },
                { name: 'å®˜è½¬åˆ†ç»„', input: '3.9380', output: '31.5000' },
                { name: 'å®˜è½¬OpenAIåˆ†ç»„', input: '7.8750', output: '63.0000' },
                { name: 'ä¼˜è´¨å®˜è½¬OpenAIåˆ†ç»„', input: '10.5000', output: '84.0000' }
            ],
            'gpt-5.2-pro': [
                { name: 'ä¼˜è´¨å®˜è½¬OpenAIåˆ†ç»„', input: '126.0000', output: '1008.0000' }
            ],
            'gpt-5.1-2025-11-13': [
                { name: 'é™æ—¶ç‰¹ä»·åˆ†ç»„', input: '0.5630', output: '4.5000' },
                { name: 'defaultåˆ†ç»„', input: '0.9380', output: '7.5000' },
                { name: 'é€†å‘åˆ†ç»„', input: '1.3130', output: '10.5000' },
                { name: 'çº¯AZåˆ†ç»„', input: '1.4060', output: '11.2500' },
                { name: 'å®˜è½¬åˆ†ç»„', input: '2.8130', output: '22.5000' },
                { name: 'å®˜è½¬OpenAIåˆ†ç»„', input: '5.6250', output: '45.0000' },
                { name: 'ä¼˜è´¨å®˜è½¬OpenAIåˆ†ç»„', input: '7.5000', output: '60.0000' }
            ],
            'gpt-5': [
                { name: 'é™æ—¶ç‰¹ä»·åˆ†ç»„', input: '0.5630', output: '4.5000' },
                { name: 'Codexä¸“å±åˆ†ç»„', input: '0.7500', output: '6.0000' },
                { name: 'defaultåˆ†ç»„', input: '0.9380', output: '7.5000' },
                { name: 'é€†å‘åˆ†ç»„', input: '1.3130', output: '10.5000' },
                { name: 'çº¯AZåˆ†ç»„', input: '1.4060', output: '11.2500' },
                { name: 'å®˜è½¬åˆ†ç»„', input: '2.8130', output: '22.5000' },
                { name: 'å®˜è½¬OpenAIåˆ†ç»„', input: '5.6250', output: '45.0000' },
                { name: 'ä¼˜è´¨å®˜è½¬OpenAIåˆ†ç»„', input: '7.5000', output: '60.0000' }
            ]
        };
        
        function updatePriceInfo(model) {
            const priceInfo = document.getElementById('priceInfo');
            const prices = modelPrices[model] || modelPrices['gpt-5.2'];
            priceInfo.innerHTML = `
                <div class="price-header"><span>åˆ†ç»„</span><span>æç¤º</span><span>è¡¥å…¨</span></div>
                ${prices.map(p => `<div class="price-row"><span>${p.name}</span><span class="price-cell">Â¥${p.input}<br><small>/ 1M tokens</small></span><span class="price-cell">Â¥${p.output}<br><small>/ 1M tokens</small></span></div>`).join('')}
            `;
        }
        
        function openSettings() {
            document.getElementById('settingsModal').classList.add('open');
            document.getElementById('settingsApiKey').value = settings.apiKey;
            document.getElementById('settingsModel').value = settings.model;
            document.getElementById('customModel').value = settings.customModel;
            document.getElementById('settingsContext').value = settings.contextCount;
            document.getElementById('contextValue').textContent = settings.contextCount;
            document.getElementById('settingsMaxTokens').value = settings.maxTokens;
            document.getElementById('maxTokensValue').textContent = settings.maxTokens;
            document.getElementById('settingsSystemPrompt').value = settings.systemPrompt;
            updateThemeButtons();
            updatePriceInfo(settings.model);
        }
        
        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('open');
        }
        
        // ESC å…³é—­è®¾ç½®å¼¹çª—
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('settingsModal');
                if (modal.classList.contains('open')) {
                    closeSettings();
                }
            }
        });
        
        function saveSettings() {
            settings.apiKey = document.getElementById('settingsApiKey').value.trim();
            settings.model = document.getElementById('settingsModel').value;
            settings.customModel = document.getElementById('customModel').value.trim();
            settings.contextCount = parseInt(document.getElementById('settingsContext').value);
            settings.maxTokens = parseInt(document.getElementById('settingsMaxTokens').value);
            settings.systemPrompt = document.getElementById('settingsSystemPrompt').value.trim();
            saveSettingsToStorage();
            updateApiHint();
            closeSettings();
            showToast('è®¾ç½®å·²ä¿å­˜');
        }
        
        function resetSettings() {
            showConfirmDialog('ç¡®å®šè¦æ¢å¤é»˜è®¤è®¾ç½®å—ï¼Ÿ', () => {
                settings = {
                    apiKey: '',
                    model: 'gpt-5.2',
                    customModel: '',
                    contextCount: 10,
                    maxTokens: 4096,
                    systemPrompt: '',
                    theme: settings.theme
                };
                openSettings();
            });
        }
        
        // æ»‘å—å®æ—¶æ›´æ–°
        document.getElementById('settingsContext').addEventListener('input', function() {
            document.getElementById('contextValue').textContent = this.value;
        });
        document.getElementById('settingsMaxTokens').addEventListener('input', function() {
            document.getElementById('maxTokensValue').textContent = this.value;
        });
        
        // æ¨¡å‹åˆ‡æ¢æ—¶æ›´æ–°ä»·æ ¼
        document.getElementById('settingsModel').addEventListener('change', function() {
            updatePriceInfo(this.value);
        });
        
        // ========== ä¸»é¢˜ç›¸å…³ ==========
        function setTheme(theme) {
            settings.theme = theme;
            applyTheme();
            updateThemeButtons();
            saveSettingsToStorage();
        }
        
        function applyTheme() {
            document.documentElement.setAttribute('data-theme', settings.theme);
        }
        
        function updateThemeButtons() {
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === settings.theme);
            });
        }
        
        // ========== ä¼šè¯ç®¡ç† ==========
        function loadSessions() {
            const saved = localStorage.getItem('gpt-sessions');
            sessions = saved ? JSON.parse(saved) : [];
        }
        
        function saveSessions() {
            localStorage.setItem('gpt-sessions', JSON.stringify(sessions));
        }
        
        function createNewSession() {
            const id = Date.now().toString();
            sessions.unshift({ id, title: 'æ–°å¯¹è¯', createdAt: new Date().toISOString() });
            currentSessionId = id;
            messages = [];
            saveSessions();
            saveMessages();
            renderHistory();
            renderMessages();
        }
        
        function loadSession(id) {
            currentSessionId = id;
            const saved = localStorage.getItem(`gpt-messages-${id}`);
            messages = saved ? JSON.parse(saved) : [];
            renderMessages();
            renderHistory();
        }
        
        function deleteSession(id, e) {
            e.stopPropagation();
            showConfirmDialog('ç¡®å®šåˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿ', () => {
                sessions = sessions.filter(s => s.id !== id);
                localStorage.removeItem(`gpt-messages-${id}`);
                saveSessions();
                if (id === currentSessionId) {
                    if (sessions.length > 0) loadSession(sessions[0].id);
                    else createNewSession();
                }
                renderHistory();
            });
        }
        
        function saveMessages() {
            localStorage.setItem(`gpt-messages-${currentSessionId}`, JSON.stringify(messages));
            // æ›´æ–°ä¼šè¯æ ‡é¢˜
            if (messages.length > 0) {
                const session = sessions.find(s => s.id === currentSessionId);
                if (session && session.title === 'æ–°å¯¹è¯') {
                    const firstMsg = messages.find(m => m.role === 'user');
                    if (firstMsg) {
                        session.title = firstMsg.content.substring(0, 20) + (firstMsg.content.length > 20 ? '...' : '');
                        saveSessions();
                        renderHistory();
                    }
                }
            }
        }
        
        function newChat() {
            createNewSession();
            chatInput.value = '';
            chatInput.focus();
            toggleSidebar(false);
        }
        
        function toggleSidebar(show) {
            const sidebar = document.getElementById('chatSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (show === undefined) show = !sidebar.classList.contains('open');
            sidebar.classList.toggle('open', show);
            overlay.classList.toggle('open', show);
        }
        
        // ========== æ¸²æŸ“ ==========
        function renderHistory(filter = '') {
            const keyword = filter.toLowerCase();
            const filtered = keyword ? sessions.filter(s => s.title.toLowerCase().includes(keyword)) : sessions;
            const sorted = [...filtered].sort((a, b) => (b.pinned ? 1 : 0) - (a.pinned ? 1 : 0));
            chatHistory.innerHTML = sorted.map(s => `
                <div class="history-item ${s.id === currentSessionId ? 'active' : ''} ${s.pinned ? 'pinned' : ''}" onclick="loadSession('${s.id}')" ondblclick="renameSession('${s.id}', event)">
                    <span class="history-item-text">${s.pinned ? 'ğŸ“Œ' : 'ğŸ’¬'} ${s.title}</span>
                    <button class="history-item-pin ${s.pinned ? 'pinned' : ''}" onclick="togglePin('${s.id}', event)" title="${s.pinned ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶'}">ğŸ“Œ</button>
                    <button class="history-item-delete" onclick="deleteSession('${s.id}', event)">Ã—</button>
                </div>
            `).join('') || '<div style="padding:12px;color:var(--text-muted);font-size:13px;text-align:center;">æ— åŒ¹é…ç»“æœ</div>';
        }
        
        function togglePin(id, e) {
            e.stopPropagation();
            const session = sessions.find(s => s.id === id);
            if (session) {
                session.pinned = !session.pinned;
                saveSessions();
                renderHistory();
                showToast(session.pinned ? 'å·²ç½®é¡¶' : 'å·²å–æ¶ˆç½®é¡¶');
            }
        }
        
        function renameSession(id, e) {
            e.stopPropagation();
            const session = sessions.find(s => s.id === id);
            if (!session) return;
            showInputDialog('é‡å‘½åä¼šè¯', session.title, (newTitle) => {
                if (newTitle && newTitle.trim()) {
                    session.title = newTitle.trim();
                    saveSessions();
                    renderHistory();
                    showToast('å·²é‡å‘½å');
                }
            });
        }
        
        function filterHistory() {
            const keyword = document.getElementById('searchInput').value.trim();
            renderHistory(keyword);
        }
        
        function renderMessages() {
            if (messages.length === 0) {
                chatMessages.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸš€</div>
                        <div class="empty-state-text">å¼€å§‹ä¸ GPT å¯¹è¯</div>
                        <div class="empty-state-desc">ç‚¹å‡»å³ä¸Šè§’ âš™ï¸ è®¾ç½® API Key å’Œæ¨¡å‹</div>
                    </div>
                `;
                return;
            }
            chatMessages.innerHTML = messages.map((msg, idx) => `
                <div class="message ${msg.role}" data-idx="${idx}">
                    <div class="message-avatar">${msg.role === 'user' ? 'ğŸ‘¤' : 'ğŸš€'}</div>
                    <div class="message-body">
                        <div class="message-content">${msg.role === 'user' ? escapeHtml(msg.content) : renderMarkdown(msg.content)}</div>
                        <div class="message-actions">
                            <button class="msg-action-btn" onclick="copyMessage(${idx})" title="å¤åˆ¶">ğŸ“‹ å¤åˆ¶</button>
                            ${msg.role === 'user' ? `<button class="msg-action-btn" onclick="editMessage(${idx})" title="ç¼–è¾‘">âœï¸ ç¼–è¾‘</button>` : `<button class="msg-action-btn" onclick="regenerateMessage(${idx})" title="é‡æ–°ç”Ÿæˆ">ğŸ”„ é‡æ–°ç”Ÿæˆ</button>`}
                        </div>
                        ${msg.time ? `<div class="message-time">${msg.time}</div>` : ''}
                    </div>
                </div>
            `).join('');
            chatMessages.scrollTop = chatMessages.scrollHeight;
            document.querySelectorAll('.message-content pre code').forEach(block => {
                hljs.highlightElement(block);
                if (!block.parentElement.querySelector('.code-copy-btn')) {
                    const btn = document.createElement('button');
                    btn.className = 'code-copy-btn';
                    btn.textContent = 'å¤åˆ¶';
                    btn.onclick = () => {
                        navigator.clipboard.writeText(block.textContent).then(() => {
                            btn.textContent = 'å·²å¤åˆ¶';
                            setTimeout(() => btn.textContent = 'å¤åˆ¶', 1500);
                        });
                    };
                    block.parentElement.appendChild(btn);
                }
            });
        }
        
        function renderMarkdown(text) {
            if (typeof marked === 'undefined') return escapeHtml(text);
            try {
                marked.setOptions({ breaks: true, gfm: true });
                return marked.parse(text);
            } catch (e) {
                return escapeHtml(text);
            }
        }
        
        function copyMessage(idx) {
            const msg = messages[idx];
            if (msg) {
                navigator.clipboard.writeText(msg.content).then(() => showToast('å·²å¤åˆ¶')).catch(() => {});
            }
        }
        
        function editMessage(idx) {
            const msg = messages[idx];
            if (!msg || msg.role !== 'user') return;
            chatInput.value = msg.content;
            chatInput.focus();
            messages = messages.slice(0, idx);
            renderMessages();
            saveMessages();
            showToast('å·²åŠ è½½åˆ°è¾“å…¥æ¡†ï¼Œä¿®æ”¹åå‘é€');
        }
        
        async function regenerateMessage(idx) {
            if (idx <= 0 || messages[idx].role !== 'assistant') return;
            const userMsg = messages[idx - 1];
            if (!userMsg || userMsg.role !== 'user') return;
            messages.splice(idx, 1);
            renderMessages();
            saveMessages();
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<svg viewBox="0 0 24 24" class="spin"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="31.4 31.4" stroke-linecap="round"/></svg>';
            try {
                const response = await callAPI(userMsg.content);
                messages.push({ role: 'assistant', content: response });
                renderMessages();
                saveMessages();
            } catch (error) {
                messages.push({ role: 'assistant', content: `âŒ é”™è¯¯: ${error.message}` });
                renderMessages();
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z"/></svg>';
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ========== å‘é€æ¶ˆæ¯ ==========
        function getTimeStr() {
            const now = new Date();
            return now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        }
        
        async function sendMessage() {
            const text = chatInput.value.trim();
            if (!text && uploadedFiles.length === 0) return;
            if (!settings.apiKey) {
                showToast('è¯·å…ˆåœ¨è®¾ç½®ä¸­å¡«å†™ API Key');
                openSettings();
                return;
            }
            
            const currentFiles = [...uploadedFiles];
            messages.push({ role: 'user', content: text, time: getTimeStr(), files: currentFiles });
            chatInput.value = '';
            clearDraft();
            clearFiles();
            renderMessages();
            saveMessages();
            
            sendBtn.style.display = 'none';
            document.getElementById('stopBtn').style.display = 'flex';
            
            // æ·»åŠ ç©ºçš„ AI æ¶ˆæ¯ç”¨äºæµå¼æ˜¾ç¤º
            messages.push({ role: 'assistant', content: '', time: getTimeStr() });
            const aiMsgIdx = messages.length - 1;
            renderMessages();
            
            try {
                await callAPIStream(text, currentFiles, (chunk) => {
                    messages[aiMsgIdx].content += chunk;
                    renderMessages();
                });
                saveMessages();
            } catch (error) {
                if (error.name !== 'AbortError') {
                    messages[aiMsgIdx].content = messages[aiMsgIdx].content || `âŒ é”™è¯¯: ${error.message}`;
                }
                renderMessages();
                saveMessages();
            } finally {
                sendBtn.style.display = 'flex';
                document.getElementById('stopBtn').style.display = 'none';
                abortController = null;
                chatInput.focus();
            }
        }
        
        // åœæ­¢ç”Ÿæˆ
        function stopGeneration() {
            if (abortController) {
                abortController.abort();
                showToast('å·²åœæ­¢ç”Ÿæˆ');
            }
        }
        
        // æµå¼ API è°ƒç”¨
        async function callAPIStream(userMessage, files, onChunk) {
            abortController = new AbortController();
            const model = settings.customModel || settings.model;
            const contextMessages = messages.slice(0, -1).slice(-settings.contextCount * 2);
            
            const apiMessages = [];
            if (settings.systemPrompt) {
                apiMessages.push({ role: 'system', content: settings.systemPrompt });
            }
            
            // å¤„ç†å†å²æ¶ˆæ¯
            contextMessages.forEach(m => {
                if (m.content || (m.files && m.files.length > 0)) {
                    if (m.files && m.files.length > 0) {
                        const content = [];
                        if (m.content) content.push({ type: 'text', text: m.content });
                        m.files.forEach(f => {
                            if (f.type.startsWith('image/')) {
                                content.push({ type: 'image_url', image_url: { url: `data:${f.type};base64,${f.base64}` } });
                            }
                        });
                        apiMessages.push({ role: m.role, content });
                    } else {
                        apiMessages.push({ role: m.role, content: m.content });
                    }
                }
            });
            
            // å¤„ç†å½“å‰æ¶ˆæ¯
            if (files && files.length > 0) {
                const content = [];
                if (userMessage) content.push({ type: 'text', text: userMessage });
                files.forEach(f => {
                    if (f.type.startsWith('image/')) {
                        content.push({ type: 'image_url', image_url: { url: `data:${f.type};base64,${f.base64}` } });
                    } else {
                        content.push({ type: 'text', text: `[æ–‡ä»¶: ${f.name}]` });
                    }
                });
                apiMessages.push({ role: 'user', content });
            } else if (userMessage) {
                apiMessages.push({ role: 'user', content: userMessage });
            }
            
            const response = await fetch('/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${settings.apiKey}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: apiMessages,
                    max_tokens: settings.maxTokens,
                    stream: true
                }),
                signal: abortController.signal
            });
            
            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.error?.message || `HTTP ${response.status}`);
            }
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop() || '';
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = line.slice(6);
                        if (data === '[DONE]') continue;
                        try {
                            const json = JSON.parse(data);
                            const content = json.choices?.[0]?.delta?.content;
                            if (content) onChunk(content);
                        } catch (e) {}
                    }
                }
            }
        }
        
        // éæµå¼å¤‡ç”¨
        async function callAPI(userMessage) {
            const model = settings.customModel || settings.model;
            const contextMessages = messages.slice(-settings.contextCount * 2);
            
            const apiMessages = [];
            if (settings.systemPrompt) {
                apiMessages.push({ role: 'system', content: settings.systemPrompt });
            }
            contextMessages.forEach(m => {
                apiMessages.push({ role: m.role, content: m.content });
            });
            
            const response = await fetch('/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${settings.apiKey}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: apiMessages,
                    max_tokens: settings.maxTokens
                })
            });
            
            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.error?.message || `HTTP ${response.status}`);
            }
            
            const data = await response.json();
            return data.choices[0].message.content;
        }
        
        // ========== Token ä¼°ç®— ==========
        function estimateTokens(text) {
            if (!text) return 0;
            const chineseChars = (text.match(/[\u4e00-\u9fa5]/g) || []).length;
            const otherChars = text.length - chineseChars;
            return Math.ceil(chineseChars / 1.5 + otherChars / 4);
        }
        
        function updateTokenCount() {
            const inputTokens = estimateTokens(chatInput.value);
            const contextTokens = messages.slice(-settings.contextCount * 2).reduce((sum, m) => sum + estimateTokens(m.content), 0);
            const systemTokens = estimateTokens(settings.systemPrompt);
            const total = inputTokens + contextTokens + systemTokens;
            document.getElementById('tokenCount').textContent = `é¢„ä¼°: ${total} tokens`;
        }
        
        // ========== äº‹ä»¶ç›‘å¬ ==========
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
            updateTokenCount();
            saveDraft();
        });
        
        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // ç²˜è´´æ–‡ä»¶æ”¯æŒ
        chatInput.addEventListener('paste', async function(e) {
            const items = e.clipboardData?.items;
            if (!items) return;
            for (const item of items) {
                if (item.kind === 'file') {
                    e.preventDefault();
                    const file = item.getAsFile();
                    if (file) {
                        if (file.size > 10 * 1024 * 1024) {
                            showToast('æ–‡ä»¶è¶…è¿‡10MBé™åˆ¶');
                            return;
                        }
                        const base64 = await fileToBase64(file);
                        const name = file.name || `ç²˜è´´æ–‡ä»¶_${Date.now()}${file.type.startsWith('image/') ? '.png' : ''}`;
                        uploadedFiles.push({ name, type: file.type, base64 });
                        renderFilePreview();
                        showToast('æ–‡ä»¶å·²æ·»åŠ ');
                    }
                    break;
                }
            }
        });
        
        // ========== ç‚¹å‡»æ¶ˆæ¯å¤åˆ¶ ==========
        chatMessages.addEventListener('click', function(e) {
            const msgContent = e.target.closest('.message-content');
            if (msgContent && !e.target.closest('button') && !e.target.closest('a')) {
                navigator.clipboard.writeText(msgContent.textContent).then(() => showToast('æ¶ˆæ¯å·²å¤åˆ¶')).catch(() => {});
            }
        });
        
        // æ¸…ç©ºå¯¹è¯
        function clearChat() {
            if (messages.length === 0) {
                showToast('å½“å‰å¯¹è¯å·²ä¸ºç©º');
                return;
            }
            showConfirmDialog('ç¡®å®šè¦æ¸…ç©ºå½“å‰å¯¹è¯å—ï¼Ÿ', () => {
                messages = [];
                saveMessages();
                renderMessages();
                showToast('å¯¹è¯å·²æ¸…ç©º');
            });
        }
        
        // è‡ªå®šä¹‰ç¡®è®¤å¼¹çª—
        function showConfirmDialog(msg, onConfirm) {
            let dialog = document.getElementById('confirmDialog');
            if (!dialog) {
                dialog = document.createElement('div');
                dialog.id = 'confirmDialog';
                dialog.innerHTML = `
                    <div class="confirm-overlay"></div>
                    <div class="confirm-box">
                        <div class="confirm-msg"></div>
                        <div class="confirm-btns">
                            <button class="confirm-btn cancel">æˆ‘å†æƒ³æƒ³</button>
                            <button class="confirm-btn ok">ç¡®å®š</button>
                        </div>
                    </div>
                `;
                dialog.style.cssText = 'display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:9999;';
                const style = document.createElement('style');
                style.textContent = `
                    #confirmDialog .confirm-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);}
                    #confirmDialog .confirm-box{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg-primary);border-radius:12px;padding:24px;min-width:300px;box-shadow:0 4px 20px rgba(0,0,0,0.3);}
                    #confirmDialog .confirm-msg{font-size:16px;color:var(--text-primary);margin-bottom:20px;text-align:center;}
                    #confirmDialog .confirm-btns{display:flex;gap:12px;justify-content:center;}
                    #confirmDialog .confirm-btn{padding:10px 24px;border-radius:8px;font-size:14px;cursor:pointer;border:none;}
                    #confirmDialog .confirm-btn.cancel{background:var(--bg-tertiary);color:var(--text-secondary);}
                    #confirmDialog .confirm-btn.ok{background:var(--accent-color);color:#fff;}
                    #confirmDialog .confirm-btn:hover{opacity:0.9;}
                `;
                document.head.appendChild(style);
                document.body.appendChild(dialog);
            }
            dialog.querySelector('.confirm-msg').textContent = msg;
            dialog.style.display = 'block';
            dialog.querySelector('.cancel').onclick = () => { dialog.style.display = 'none'; };
            dialog.querySelector('.ok').onclick = () => { dialog.style.display = 'none'; onConfirm(); };
            dialog.querySelector('.confirm-overlay').onclick = () => { dialog.style.display = 'none'; };
        }
        
        // è‡ªå®šä¹‰è¾“å…¥å¼¹çª—
        function showInputDialog(title, defaultValue, onConfirm) {
            let dialog = document.getElementById('inputDialog');
            if (!dialog) {
                dialog = document.createElement('div');
                dialog.id = 'inputDialog';
                dialog.innerHTML = `
                    <div class="input-overlay"></div>
                    <div class="input-box">
                        <div class="input-title"></div>
                        <input type="text" class="input-field" autocomplete="off" />
                        <div class="input-btns">
                            <button class="input-btn cancel">å–æ¶ˆ</button>
                            <button class="input-btn ok">ç¡®å®š</button>
                        </div>
                    </div>
                `;
                dialog.style.cssText = 'display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:9999;';
                const style = document.createElement('style');
                style.textContent = `
                    #inputDialog .input-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);}
                    #inputDialog .input-box{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg-primary);border-radius:12px;padding:24px;min-width:320px;box-shadow:0 4px 20px rgba(0,0,0,0.3);}
                    #inputDialog .input-title{font-size:16px;color:var(--text-primary);margin-bottom:16px;text-align:center;}
                    #inputDialog .input-field{width:100%;padding:10px 12px;border:1px solid var(--border-color);border-radius:8px;background:var(--bg-secondary);color:var(--text-primary);font-size:14px;box-sizing:border-box;}
                    #inputDialog .input-field:focus{outline:none;border-color:var(--accent-color);}
                    #inputDialog .input-btns{display:flex;gap:12px;justify-content:center;margin-top:20px;}
                    #inputDialog .input-btn{padding:10px 24px;border-radius:8px;font-size:14px;cursor:pointer;border:none;}
                    #inputDialog .input-btn.cancel{background:var(--bg-tertiary);color:var(--text-secondary);}
                    #inputDialog .input-btn.ok{background:var(--accent-color);color:#fff;}
                    #inputDialog .input-btn:hover{opacity:0.9;}
                `;
                document.head.appendChild(style);
                document.body.appendChild(dialog);
            }
            const titleEl = dialog.querySelector('.input-title');
            const inputEl = dialog.querySelector('.input-field');
            titleEl.textContent = title;
            inputEl.value = defaultValue || '';
            dialog.style.display = 'block';
            inputEl.focus();
            inputEl.select();
            dialog.querySelector('.cancel').onclick = () => { dialog.style.display = 'none'; };
            dialog.querySelector('.ok').onclick = () => { dialog.style.display = 'none'; onConfirm(inputEl.value); };
            dialog.querySelector('.input-overlay').onclick = () => { dialog.style.display = 'none'; };
            inputEl.onkeydown = (e) => { if (e.key === 'Enter') { dialog.style.display = 'none'; onConfirm(inputEl.value); } };
        }
        
        // å¯¼å‡ºå¯¹è¯
        function exportChat() {
            if (messages.length === 0) {
                showToast('æš‚æ— å¯¹è¯å¯å¯¼å‡º');
                return;
            }
            const session = sessions.find(s => s.id === currentSessionId);
            const title = session?.title || 'å¯¹è¯';
            let md = `# ${title}\n\nå¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString()}\n\n---\n\n`;
            messages.forEach(m => {
                const role = m.role === 'user' ? 'ğŸ‘¤ ç”¨æˆ·' : 'ğŸš€ GPT';
                md += `### ${role}\n\n${m.content}\n\n---\n\n`;
            });
            const blob = new Blob([md], { type: 'text/markdown;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${title}-${Date.now()}.md`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('å¯¹è¯å·²å¯¼å‡º');
        }
        
        function showToast(msg) {
            let toast = document.getElementById('copyToast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'copyToast';
                toast.style.cssText = 'position:fixed;bottom:100px;left:50%;transform:translateX(-50%);padding:10px 20px;background:rgba(0,0,0,0.8);color:#fff;border-radius:8px;font-size:14px;z-index:9999;opacity:0;transition:opacity 0.3s;';
                document.body.appendChild(toast);
            }
            toast.textContent = msg;
            toast.style.opacity = '1';
            setTimeout(() => { toast.style.opacity = '0'; }, 1500);
        }
        
        // ========== æ–‡ä»¶ä¸Šä¼ å¤„ç† ==========
        fileInput.addEventListener('change', async function(e) {
            const files = Array.from(e.target.files);
            for (const file of files) {
                if (file.size > 10 * 1024 * 1024) {
                    showToast(`æ–‡ä»¶ ${file.name} è¶…è¿‡10MBé™åˆ¶`);
                    continue;
                }
                const base64 = await fileToBase64(file);
                uploadedFiles.push({ name: file.name, type: file.type, base64 });
            }
            renderFilePreview();
            fileInput.value = '';
        });
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        function renderFilePreview() {
            if (uploadedFiles.length === 0) {
                filePreviewArea.classList.remove('has-files');
                filePreviewList.innerHTML = '';
                return;
            }
            filePreviewArea.classList.add('has-files');
            filePreviewList.innerHTML = uploadedFiles.map((f, i) => `
                <div class="file-preview-item">
                    <span>${f.type.startsWith('image/') ? 'ğŸ–¼ï¸' : 'ğŸ“„'} ${f.name.length > 15 ? f.name.slice(0, 12) + '...' : f.name}</span>
                    <button class="remove-file" onclick="removeFile(${i})">Ã—</button>
                </div>
            `).join('');
        }
        
        function removeFile(idx) {
            uploadedFiles.splice(idx, 1);
            renderFilePreview();
        }
        
        function clearFiles() {
            uploadedFiles = [];
            renderFilePreview();
        }
        
        // åˆå§‹åŒ–
        init();
    </script>
</body>
</html>
