<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯çµæ–‡ç”Ÿè§†é¢‘</title>
    <link rel="stylesheet" href="../styles/workspace.css">
    <link rel="stylesheet" href="../styles/mobile.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif; background: #f5f7fa; min-height: 100vh; color: #1e293b; }

        .top-header { background: #fff; padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; position: fixed; top: 0; left: 0; right: 0; z-index: 100; height: 56px; }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .header-btn { display: flex; align-items: center; gap: 6px; padding: 8px 16px; background: #f8f9fb; border: 1px solid #e8ecf1; border-radius: 8px; font-size: 13px; color: #475569; cursor: pointer; transition: all 0.2s; text-decoration: none; }
        .header-btn:hover { background: #f0f2f5; border-color: #d1d5db; }
        .page-title { font-size: 20px; font-weight: 600; background: linear-gradient(135deg, #10b981 0%, #34d399 100%); -webkit-background-clip: text; background-clip: text; color: transparent; }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .header-icon-btn { width: 36px; height: 36px; border-radius: 8px; border: 1px solid #e8ecf1; background: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; color: #64748b; }

        .tab-nav { background: #fff; padding: 0 24px; border-bottom: 1px solid #e8ecf1; position: fixed; top: 56px; left: 0; right: 0; z-index: 99; height: 48px; display: flex; align-items: center; gap: 8px; }
        .tab-item { padding: 8px 20px; font-size: 14px; color: #64748b; border-radius: 6px; cursor: pointer; transition: all 0.2s; text-decoration: none; }
        .tab-item:hover { background: #f5f7fa; color: #475569; }
        .tab-item.active { background: linear-gradient(135deg, #10b981 0%, #34d399 100%); color: #fff; font-weight: 500; }

        .main-content { margin-top: 104px; padding: 24px; display: grid; grid-template-columns: 1fr 1fr; gap: 24px; max-width: 1400px; margin-left: auto; margin-right: auto; }
        .left-panel, .right-panel { display: flex; flex-direction: column; gap: 20px; }
        .panel-section { background: #fff; border-radius: 12px; padding: 20px; border: 1px solid #e8ecf1; }
        .section-title { font-size: 15px; font-weight: 600; color: #1e293b; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }

        .credential-input { width: 100%; padding: 10px 14px; border: 1px solid #e8ecf1; border-radius: 8px; font-size: 13px; background: #fafbfc; }
        .credential-input:focus { outline: none; border-color: #10b981; background: #fff; }
        .helper { font-size: 12px; color: #94a3b8; margin-top: 8px; line-height: 1.5; }

        /* è­¦å‘Šé—ªçƒæ ·å¼ */
        .warning-blink { font-size: 14px !important; color: #dc2626 !important; font-weight: 600; animation: blink-warning 1s ease-in-out infinite; background: #fef2f2; padding: 8px 12px; border-radius: 6px; margin-top: 12px !important; }
        @keyframes blink-warning { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .prompt-textarea { width: 100%; min-height: 120px; padding: 12px 14px; border: 1px solid #e8ecf1; border-radius: 8px; font-size: 13px; background: #fafbfc; resize: vertical; font-family: inherit; }
        .prompt-textarea:focus { outline: none; border-color: #10b981; background: #fff; }

        .prompt-examples { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
        .prompt-example { padding: 6px 12px; background: #ecfdf5; border: 1px solid #d1fae5; border-radius: 16px; font-size: 12px; color: #059669; cursor: pointer; transition: all 0.2s; }
        .prompt-example:hover { background: #d1fae5; }

        .param-label { font-size: 13px; color: #475569; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
        .param-btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .param-btn { padding: 10px 20px; border: 1px solid #e8ecf1; border-radius: 20px; font-size: 13px; color: #475569; background: #fff; cursor: pointer; transition: all 0.2s; }
        .param-btn:hover { border-color: #10b981; background: #ecfdf5; }
        .param-btn.active { background: linear-gradient(135deg, #10b981 0%, #34d399 100%); color: #fff; border-color: transparent; }

        .model-select { width: 100%; padding: 10px 14px; border: 1px solid #e8ecf1; border-radius: 8px; font-size: 13px; background: #fff; cursor: pointer; }
        .model-select:focus { outline: none; border-color: #10b981; }

        .submit-btn { width: 100%; padding: 14px 24px; background: linear-gradient(135deg, #10b981 0%, #34d399 100%); color: #fff; border: none; border-radius: 10px; font-size: 15px; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
        .submit-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4); }
        .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        .status { font-size: 13px; padding: 10px 14px; border-radius: 8px; margin-top: 12px; }
        .status:empty { display: none; }
        .status.success { background: #ecfdf5; color: #059669; }
        .status.error { background: #fef2f2; color: #dc2626; }
        .status.info { background: #ecfdf5; color: #059669; }

        .task-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .task-desc { font-size: 13px; color: #64748b; margin-bottom: 16px; }
        .task-list { display: flex; flex-direction: column; gap: 12px; max-height: 600px; overflow-y: auto; }
        .history-empty { text-align: center; color: #94a3b8; font-size: 13px; padding: 40px 20px; }

        .history-item { background: #f8f9fb; border: 1px solid #e8ecf1; border-radius: 10px; padding: 16px; }
        .history-item header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .history-meta { display: flex; flex-direction: column; gap: 4px; font-size: 12px; color: #64748b; flex: 1; min-width: 0; }
        .history-meta strong { color: #1e293b; font-size: 13px; display: block; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .history-status { padding: 4px 10px; border-radius: 12px; font-size: 12px; white-space: nowrap; }
        .history-status.pending { background: #fef3c7; color: #92400e; }
        .history-status.processing { background: #dbeafe; color: #1d4ed8; }
        .history-status.completed { background: #d1fae5; color: #065f46; }
        .history-status.failed { background: #fee2e2; color: #991b1b; }
        .history-video { margin-top: 12px; }
        .history-video video { width: 100%; max-height: 200px; border-radius: 8px; background: #000; }
        .history-actions { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
        .history-actions button { padding: 6px 12px; background: #fff; border: 1px solid #e8ecf1; border-radius: 6px; font-size: 12px; color: #475569; cursor: pointer; }
        .history-actions button:hover:not(:disabled) { border-color: #10b981; color: #10b981; }
        .history-actions button:disabled { opacity: 0.5; cursor: not-allowed; }
        .history-actions button.delete-btn { color: #ef4444; }
        .history-actions button.delete-btn:hover { border-color: #ef4444; }

        @keyframes redBlink { 0%, 100% { color: #ef4444; } 50% { color: #fca5a5; } }
        .red-blink { animation: redBlink 1s infinite; }

        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-bar { background: #e8ecf1; border-radius: 8px; height: 8px; overflow: hidden; margin-bottom: 8px; }
        .progress-bar-fill { height: 100%; background: linear-gradient(135deg, #10b981 0%, #34d399 100%); transition: width 0.3s; }
        .progress-text { font-size: 12px; color: #64748b; text-align: center; }

        .hidden { display: none !important; }
        @media (max-width: 1024px) { .main-content { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .tab-nav { overflow-x: auto; padding: 0 16px; } .main-content { padding: 16px; } }
    </style>
</head>
<body>
    <header class="top-header">
        <div class="header-left">
        </div>
        <span class="page-title">å¯çµæ–‡ç”Ÿè§†é¢‘</span>
        <div class="header-right">
            <button class="header-icon-btn" onclick="location.reload()">ğŸ”„</button>
        </div>
    </header>

    <nav class="tab-nav">
        <a href="klwssp.html" class="tab-item active">æ–‡ç”Ÿè§†é¢‘</a>
        <a href="kltssp.html" class="tab-item">å›¾ç”Ÿè§†é¢‘</a>
    </nav>

    <main class="main-content">
        <div class="left-panel">
            <div class="panel-section">
                <h2 class="section-title">ğŸ”‘ APIKeyå¡«å†™åŒº</h2>
                <input type="password" id="credential" class="credential-input" placeholder="ç²˜è´´å¯çµè®¿é—®å‡­è¯" autocomplete="off">
                <p class="helper">å¡«å†™DUUè°ƒç”¨ç«™çš„APIKeyï¼Œ<span class="red-blink">ç›®å‰å¯çµåªæ”¯æŒdefaultåˆ†ç»„</span></p>
                <p class="helper warning-blink">âš ï¸ å¯çµè¾ƒè´µï¼Œéœ€è¦é…Œæƒ…ä½¿ç”¨ï¼</p>
            </div>

            <div class="panel-section">
                <h2 class="section-title">âœï¸ æç¤ºè¯</h2>
                <textarea id="promptInput" class="prompt-textarea" placeholder="è¯¦ç»†æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘å†…å®¹ï¼Œä¸è¶…è¿‡500å­—ç¬¦..."></textarea>
                <p class="helper">æ­£å‘æ–‡æœ¬æç¤ºï¼Œæè¿°æƒ³è¦ç”Ÿæˆçš„è§†é¢‘å†…å®¹</p>
                <div class="prompt-examples">
                    <span class="prompt-example" onclick="setPrompt('ä¸€åªçŒ«å’ªåœ¨çª—å°ä¸Šæ™’å¤ªé˜³ï¼Œæ…µæ‡’åœ°æ‰“å“ˆæ¬ ï¼Œé˜³å…‰æ¸©æš–')">ğŸ± çŒ«å’ªæ™’å¤ªé˜³</span>
                    <span class="prompt-example" onclick="setPrompt('åŸå¸‚å¤œæ™¯ï¼Œéœ“è™¹ç¯é—ªçƒï¼Œè½¦æµç©¿æ¢­ï¼Œç¹åéƒ½å¸‚')">ğŸŒƒ åŸå¸‚å¤œæ™¯</span>
                    <span class="prompt-example" onclick="setPrompt('æ¨±èŠ±æ ‘ä¸‹ï¼ŒèŠ±ç“£éšé£é£˜è½ï¼Œå”¯ç¾æµªæ¼«ï¼Œæ˜¥å¤©æ°”æ¯')">ğŸŒ¸ æ¨±èŠ±é£˜è½</span>
                    <span class="prompt-example" onclick="setPrompt('åœ¨æµ·æ»©ä¸Šåº¦å‡çš„å¿«ä¹åœºæ™¯ï¼Œé˜³å…‰æ²™æ»©ï¼Œæµ·æµªè½»æ‹')">ğŸ–ï¸ æµ·æ»©åº¦å‡</span>
                </div>
            </div>

            <div class="panel-section">
                <h2 class="section-title">âš™ï¸ å‚æ•°è®¾ç½®</h2>
                <div style="margin-bottom: 20px;">
                    <p class="param-label">ğŸ¤– æ¨¡å‹é€‰æ‹©</p>
                    <select id="modelSelect" class="model-select">
                        <option value="kling-v2-5-turbo" selected>Kling v2.5 Turboï¼ˆå¿«é€Ÿï¼‰</option>
                        <option value="kling-v1-6">Kling v1.6</option>
                        <option value="kling-v1-5">Kling v1.5</option>
                        <option value="kling-v1">Kling v1</option>
                    </select>
                </div>
                <div style="margin-bottom: 20px;">
                    <p class="param-label">ğŸ“ è§†é¢‘æ¯”ä¾‹</p>
                    <div class="param-btn-group" id="ratioGroup">
                        <button type="button" class="param-btn active" data-value="16:9">16:9 æ¨ªå±</button>
                        <button type="button" class="param-btn" data-value="9:16">9:16 ç«–å±</button>
                        <button type="button" class="param-btn" data-value="1:1">1:1 æ–¹å½¢</button>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <p class="param-label">â±ï¸ è§†é¢‘æ—¶é•¿</p>
                    <div class="param-btn-group" id="durationGroup">
                        <button type="button" class="param-btn active" data-value="5">5ç§’</button>
                        <button type="button" class="param-btn" data-value="10">10ç§’</button>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <p class="param-label">ğŸ¬ ç”Ÿæˆæ¨¡å¼</p>
                    <div class="param-btn-group" id="modeGroup">
                        <button type="button" class="param-btn active" data-value="std">æ ‡å‡†æ¨¡å¼</button>
                        <button type="button" class="param-btn" data-value="pro">ä¸“ä¸šæ¨¡å¼</button>
                    </div>
                </div>
                <div>
                    <p class="param-label">ğŸ”¢ ç”Ÿæˆæ•°é‡</p>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <select id="countSelect" class="model-select" style="flex: 1;">
                            <option value="1" selected>1 ä¸ª</option>
                            <option value="5">5 ä¸ª</option>
                            <option value="10">10 ä¸ª</option>
                            <option value="custom">è‡ªå®šä¹‰</option>
                        </select>
                        <input type="number" id="customCount" class="credential-input" min="1" max="50" value="3" style="flex: 1; display: none;" placeholder="è¾“å…¥æ•°é‡">
                    </div>
                    <p class="helper">åŒæ—¶ç”Ÿæˆå¤šä¸ªè§†é¢‘ï¼Œæœ€å¤§å¹¶å‘20ä¸ªï¼Œè¶…è¿‡20ä¸ªè‡ªåŠ¨åˆ†æ‰¹æ‰§è¡Œ</p>
                </div>
            </div>

            <div id="progress-container" style="margin-bottom: 12px;"></div>
            <button type="button" class="submit-btn" id="submitBtn">ğŸ¬ å¼€å§‹ç”Ÿæˆ</button>
            <p id="status" class="status"></p>
        </div>

        <div class="right-panel">
            <div class="panel-section" style="flex: 1;">
                <div class="task-header">
                    <h2 class="section-title" style="margin-bottom: 0;">ä»»åŠ¡å†å²</h2>
                </div>
                <p class="task-desc">ç”Ÿæˆè§†é¢‘å¤§çº¦éœ€è¦1-3åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…</p>
                <p id="history-empty" class="history-empty">æš‚æ— ä»»åŠ¡è®°å½•</p>
                <div id="task-history-list" class="task-list"></div>
            </div>
        </div>
    </main>

    <script src="../scripts/duu-db.js"></script>
    <script src="../scripts/apikeys.js"></script>
    <script src="../scripts/auth.js"></script>
    <script src="../scripts/image-server.js"></script>
    <script src="../scripts/batch-processor.js"></script>
    <script>
        const PAGE_KEY = 'kling-text2video';
        const API_BASE = '';
        
        const statusEl = document.getElementById('status');
        const promptInput = document.getElementById('promptInput');
        const submitBtn = document.getElementById('submitBtn');
        const modelSelect = document.getElementById('modelSelect');
        const historyList = document.getElementById('task-history-list');
        const historyEmpty = document.getElementById('history-empty');
        
        let selectedRatio = '16:9';
        let selectedDuration = 5;
        let selectedMode = 'std';
        let taskHistory = [];
        let pollingTimers = {};
        const MAX_CONCURRENT = 20;

        const pageCache = new CacheManager('kling-wssp');
        const countSelect = document.getElementById('countSelect');
        const customCount = document.getElementById('customCount');
        const progressContainer = document.getElementById('progress-container');

        // æ•°é‡é€‰æ‹©åˆ‡æ¢
        countSelect.addEventListener('change', () => {
            customCount.style.display = countSelect.value === 'custom' ? 'block' : 'none';
        });

        // è·å–ç”Ÿæˆæ•°é‡
        const getCount = () => {
            if (countSelect.value === 'custom') {
                return Math.max(1, Math.min(50, parseInt(customCount.value) || 1));
            }
            return parseInt(countSelect.value);
        };

        // è¿›åº¦æ¡
        const showProgress = (current, total) => {
            const percent = Math.round((current / total) * 100);
            progressContainer.innerHTML = `
                <div class="progress-bar"><div class="progress-bar-fill" style="width: ${percent}%"></div></div>
                <p class="progress-text">è¿›åº¦: ${current}/${total} (${percent}%)</p>
            `;
        };

        const hideProgress = () => {
            progressContainer.innerHTML = '';
        };

        // API Key ç¼“å­˜ - è¾“å…¥æ—¶è‡ªåŠ¨ä¿å­˜ï¼ˆå¸¦é˜²æŠ–ï¼‰
        let apiKeyTimer = null;
        const credentialInput = document.getElementById('credential');
        credentialInput.addEventListener('input', (e) => {
            const apiKey = e.target.value.trim();
            if (apiKeyTimer) clearTimeout(apiKeyTimer);
            apiKeyTimer = setTimeout(async () => {
                if (apiKey) {
                    await pageCache.set('apiKey', apiKey, { ttl: null });
                }
            }, 500);
        });

        // æç¤ºè¯ç¼“å­˜ - è¾“å…¥æ—¶è‡ªåŠ¨ä¿å­˜ï¼ˆå¸¦é˜²æŠ–ï¼‰
        let promptTimer = null;
        promptInput.addEventListener('input', (e) => {
            const prompt = e.target.value.trim();
            if (promptTimer) clearTimeout(promptTimer);
            promptTimer = setTimeout(async () => {
                await pageCache.set('prompt', prompt, { ttl: null });
            }, 500);
        });

        // é¡µé¢åŠ è½½æ—¶æ¢å¤ç¼“å­˜
        (async function restoreCachedState() {
            try {
                const [cachedApiKey, cachedPrompt, cachedModel, cachedRatio, cachedDuration, cachedMode] = await Promise.all([
                    pageCache.get('apiKey'),
                    pageCache.get('prompt'),
                    pageCache.get('model'),
                    pageCache.get('ratio'),
                    pageCache.get('duration'),
                    pageCache.get('mode')
                ]);
                
                if (cachedApiKey) credentialInput.value = cachedApiKey;
                if (cachedPrompt) promptInput.value = cachedPrompt;
                if (cachedModel) modelSelect.value = cachedModel;
                
                if (cachedRatio) {
                    selectedRatio = cachedRatio;
                    document.querySelectorAll('#ratioGroup .param-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.value === cachedRatio);
                    });
                }
                if (cachedDuration) {
                    selectedDuration = parseInt(cachedDuration);
                    document.querySelectorAll('#durationGroup .param-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.value === cachedDuration);
                    });
                }
                if (cachedMode) {
                    selectedMode = cachedMode;
                    document.querySelectorAll('#modeGroup .param-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.value === cachedMode);
                    });
                }
            } catch (e) {
                console.warn('æ¢å¤ç¼“å­˜å¤±è´¥:', e);
            }
        })();

        // å‚æ•°æŒ‰é’®ç»„
        const setupParamGroup = (groupId, callback) => {
            const group = document.getElementById(groupId);
            group.querySelectorAll('.param-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    group.querySelectorAll('.param-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    callback(btn.dataset.value);
                });
            });
        };

        setupParamGroup('ratioGroup', (val) => { selectedRatio = val; pageCache.set('ratio', val, { ttl: null }); });
        setupParamGroup('durationGroup', (val) => { selectedDuration = parseInt(val); pageCache.set('duration', val, { ttl: null }); });
        setupParamGroup('modeGroup', (val) => { selectedMode = val; pageCache.set('mode', val, { ttl: null }); });

        modelSelect.addEventListener('change', () => {
            pageCache.set('model', modelSelect.value, { ttl: null });
        });

        const setPrompt = (text) => { promptInput.value = text; };

        const setStatus = (msg, type = '') => {
            statusEl.textContent = msg;
            statusEl.className = type ? `status ${type}` : 'status';
        };

        const formatDate = (date) => {
            const d = new Date(date);
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        };

        const getStatusText = (status) => {
            const map = { pending: 'æ’é˜Ÿä¸­', processing: 'ç”Ÿæˆä¸­', completed: 'å·²å®Œæˆ', failed: 'å¤±è´¥', submitted: 'æ’é˜Ÿä¸­' };
            return map[status] || status || 'æœªçŸ¥';
        };

        const renderHistory = () => {
            if (taskHistory.length === 0) {
                historyEmpty.hidden = false;
                historyList.innerHTML = '';
                return;
            }
            historyEmpty.hidden = true;
            historyList.innerHTML = taskHistory.map((task, idx) => {
                const status = task.status || 'pending';
                return `
                <article class="history-item" data-task-id="${task.taskId || ''}">
                    <header>
                        <div class="history-meta">
                            <strong title="${task.prompt || ''}">${(task.prompt || 'æ— æç¤ºè¯').substring(0, 40)}${task.prompt?.length > 40 ? '...' : ''}</strong>
                            <span>æ—¶é—´ï¼š${formatDate(task.createdAt)}</span>
                            <span>æ¨¡å‹ï¼š${task.model || 'kling-v2-5-turbo'}</span>
                        </div>
                        <span class="history-status ${status}">${getStatusText(status)}</span>
                    </header>
                    ${task.videoUrl ? `<div class="history-video"><video src="${task.videoUrl}" controls preload="metadata"></video></div>` : ''}
                    <div class="history-actions">
                        ${status === 'pending' || status === 'processing' ? `<button onclick="refreshTask(${idx})">åˆ·æ–°çŠ¶æ€</button>` : ''}
                        ${task.videoUrl ? `<button onclick="downloadVideo('${task.videoUrl}', '${task.taskId}')">ä¸‹è½½è§†é¢‘</button>` : ''}
                        <button class="delete-btn" onclick="deleteTask(${idx})">åˆ é™¤</button>
                    </div>
                </article>
            `}).join('');
        };

        const saveHistory = async () => {
            try {
                for (const task of taskHistory.slice(0, 10)) {
                    await HistoryDB.saveTask(PAGE_KEY, {
                        id: task.id,
                        taskId: task.taskId,
                        prompt: task.prompt,
                        model: task.model,
                        status: task.status,
                        videoUrl: task.videoUrl,
                        createdAt: task.createdAt
                    });
                }
            } catch (e) {
                console.warn('ä¿å­˜å†å²å¤±è´¥:', e);
            }
        };

        const deleteTask = async (idx) => {
            const task = taskHistory[idx];
            if (task?.taskId && pollingTimers[task.taskId]) {
                clearInterval(pollingTimers[task.taskId]);
                delete pollingTimers[task.taskId];
            }
            taskHistory.splice(idx, 1);
            renderHistory();
            if (task?.id) {
                await HistoryDB.deleteTask(task.id).catch(console.warn);
            }
        };

        const downloadVideo = (url, taskId) => {
            const a = document.createElement('a');
            a.href = url;
            a.download = `kling-${taskId || Date.now()}.mp4`;
            a.target = '_blank';
            a.click();
        };

        // æäº¤å•ä¸ªä»»åŠ¡
        const submitSingleTask = async (credential, prompt, index) => {
            const body = {
                model_name: modelSelect.value,
                prompt: prompt,
                duration: String(selectedDuration),
                aspect_ratio: selectedRatio,
                mode: selectedMode
            };

            const response = await fetch(`${API_BASE}/kling/v1/videos/text2video`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'Authorization': `Bearer ${credential}`
                },
                body: JSON.stringify(body)
            });

            const result = await response.json();

            if (!response.ok) {
                const errMsg = typeof result.message === 'string' ? result.message 
                    : (typeof result.error === 'string' ? result.error 
                    : JSON.stringify(result.message || result.error || result));
                throw new Error(errMsg || `è¯·æ±‚å¤±è´¥: ${response.status}`);
            }

            const taskId = result.data?.task_id || result.task_id || result.id;
            if (!taskId) {
                throw new Error('æœªè·å–åˆ°ä»»åŠ¡ID');
            }

            return { taskId, index };
        };

        // æäº¤ä»»åŠ¡ï¼ˆæ”¯æŒå¹¶å‘ï¼‰
        const submitTask = async () => {
            const credential = document.getElementById('credential').value.trim();
            const prompt = promptInput.value.trim();

            if (!credential) {
                setStatus('è¯·å¡«å†™APIKey', 'error');
                return;
            }
            if (!prompt) {
                setStatus('è¯·è¾“å…¥æç¤ºè¯', 'error');
                return;
            }
            if (prompt.length > 500) {
                setStatus('æç¤ºè¯ä¸èƒ½è¶…è¿‡500å­—ç¬¦', 'error');
                return;
            }

            const count = getCount();
            submitBtn.disabled = true;

            if (count === 1) {
                // å•ä¸ªä»»åŠ¡
                setStatus('æ­£åœ¨æäº¤ä»»åŠ¡...', 'info');
                try {
                    const { taskId } = await submitSingleTask(credential, prompt, 0);
                    
                    const task = {
                        id: `task-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
                        taskId: taskId,
                        prompt: prompt,
                        model: modelSelect.value,
                        status: 'pending',
                        videoUrl: null,
                        createdAt: Date.now()
                    };

                    taskHistory.unshift(task);
                    renderHistory();
                    saveHistory();
                    setStatus(`ä»»åŠ¡å·²æäº¤ï¼ŒID: ${taskId}`, 'success');
                    startPolling(taskId, credential);
                } catch (error) {
                    const errMsg = typeof error === 'string' ? error : (error.message || JSON.stringify(error));
                    setStatus(`æäº¤å¤±è´¥: ${errMsg}`, 'error');
                } finally {
                    submitBtn.disabled = false;
                }
            } else {
                // æ‰¹é‡å¹¶å‘ä»»åŠ¡
                setStatus(`æ­£åœ¨æäº¤ ${count} ä¸ªä»»åŠ¡...`, 'info');
                showProgress(0, count);

                let completed = 0;
                let succeeded = 0;
                let failed = 0;

                // å¹¶å‘æ§åˆ¶
                const runBatch = async (tasks) => {
                    const results = await Promise.allSettled(tasks);
                    for (const result of results) {
                        completed++;
                        showProgress(completed, count);
                        
                        if (result.status === 'fulfilled') {
                            succeeded++;
                            const { taskId } = result.value;
                            
                            const task = {
                                id: `task-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
                                taskId: taskId,
                                prompt: prompt,
                                model: modelSelect.value,
                                status: 'pending',
                                videoUrl: null,
                                createdAt: Date.now()
                            };

                            taskHistory.unshift(task);
                            startPolling(taskId, credential);
                        } else {
                            failed++;
                            console.warn('ä»»åŠ¡æäº¤å¤±è´¥:', result.reason);
                        }
                    }
                    renderHistory();
                    saveHistory();
                };

                // åˆ†æ‰¹æ‰§è¡Œ
                for (let i = 0; i < count; i += MAX_CONCURRENT) {
                    const batch = [];
                    for (let j = i; j < Math.min(i + MAX_CONCURRENT, count); j++) {
                        batch.push(submitSingleTask(credential, prompt, j));
                    }
                    await runBatch(batch);
                }

                hideProgress();
                if (failed === 0) {
                    setStatus(`å…¨éƒ¨ ${succeeded} ä¸ªä»»åŠ¡æäº¤æˆåŠŸï¼`, 'success');
                } else {
                    setStatus(`å®Œæˆ: æˆåŠŸ ${succeeded} ä¸ªï¼Œå¤±è´¥ ${failed} ä¸ª`, failed > 0 ? 'error' : 'success');
                }
                submitBtn.disabled = false;
            }
        };

        // è½®è¯¢ä»»åŠ¡çŠ¶æ€
        const startPolling = (taskId, credential) => {
            if (pollingTimers[taskId]) {
                clearInterval(pollingTimers[taskId]);
            }

            const poll = async () => {
                try {
                    const response = await fetch(`${API_BASE}/kling/v1/videos/text2video/${taskId}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'Authorization': `Bearer ${credential}`
                        }
                    });

                    const result = await response.json();
                    console.log('è½®è¯¢ç»“æœ:', taskId, result);
                    
                    const data = result.data || result;
                    
                    // æŸ¥æ‰¾ä»»åŠ¡
                    const task = taskHistory.find(t => t.taskId === taskId);
                    if (!task) {
                        clearInterval(pollingTimers[taskId]);
                        delete pollingTimers[taskId];
                        return;
                    }

                    // å…¼å®¹å¤šç§çŠ¶æ€å­—æ®µ
                    const status = data.task_status || data.status;
                    console.log('ä»»åŠ¡çŠ¶æ€:', status);
                    
                    if (status === 'succeed' || status === 'completed' || status === 'success') {
                        task.status = 'completed';
                        // å…¼å®¹å¤šç§è§†é¢‘URLè·¯å¾„
                        task.videoUrl = data.task_result?.videos?.[0]?.url 
                            || data.task_result?.images?.[0]?.url
                            || data.videos?.[0]?.url
                            || data.video_url
                            || data.url;
                        
                        clearInterval(pollingTimers[taskId]);
                        delete pollingTimers[taskId];
                        setStatus(`è§†é¢‘ç”Ÿæˆå®Œæˆï¼`, 'success');
                        
                        // ä¿å­˜åˆ°äº‘ç«¯ï¼ˆç™»å½•ç”¨æˆ·ï¼‰
                        if (task.videoUrl) {
                            try {
                                await ImageServer.saveGeneration(
                                    credentialInput.value.trim(),
                                    task.prompt,
                                    [{ url: task.videoUrl }],
                                    'kling-text2video',
                                    'text'
                                );
                                console.log('è§†é¢‘å·²ä¿å­˜åˆ°äº‘ç«¯');
                            } catch (e) {
                                console.warn('ä¿å­˜åˆ°äº‘ç«¯å¤±è´¥:', e);
                            }
                        }
                    } else if (status === 'failed' || status === 'error') {
                        task.status = 'failed';
                        clearInterval(pollingTimers[taskId]);
                        delete pollingTimers[taskId];
                        setStatus(`è§†é¢‘ç”Ÿæˆå¤±è´¥: ${data.task_status_msg || data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                    } else if (status === 'processing' || status === 'running') {
                        task.status = 'processing';
                    } else if (status === 'submitted' || status === 'pending' || status === 'queued') {
                        task.status = 'pending';
                    }

                    renderHistory();
                    saveHistory();

                } catch (error) {
                    console.warn('è½®è¯¢å¤±è´¥:', error);
                }
            };

            // ç«‹å³æ‰§è¡Œä¸€æ¬¡
            poll();
            // æ¯10ç§’è½®è¯¢ä¸€æ¬¡
            pollingTimers[taskId] = setInterval(poll, 10000);
        };

        // æ‰‹åŠ¨åˆ·æ–°ä»»åŠ¡çŠ¶æ€
        const refreshTask = async (idx) => {
            const task = taskHistory[idx];
            if (!task?.taskId) return;

            const credential = document.getElementById('credential').value.trim();
            if (!credential) {
                setStatus('è¯·å¡«å†™APIKeyä»¥åˆ·æ–°çŠ¶æ€', 'error');
                return;
            }

            setStatus('æ­£åœ¨åˆ·æ–°...', 'info');
            startPolling(task.taskId, credential, idx);
        };

        // åŠ è½½å†å²å¹¶æ¢å¤æœªå®Œæˆä»»åŠ¡çš„è½®è¯¢
        (async () => {
            try {
                const tasks = await HistoryDB.getTasks(PAGE_KEY);
                if (tasks?.length) {
                    taskHistory = tasks.map(t => ({
                        ...t,
                        createdAt: t.createdAt || Date.now()
                    }));
                    renderHistory();
                    
                    // æ¢å¤æœªå®Œæˆä»»åŠ¡çš„è½®è¯¢
                    const credential = credentialInput.value.trim();
                    if (credential) {
                        taskHistory.forEach(task => {
                            const status = task.status || 'pending';
                            if ((status === 'pending' || status === 'processing') && task.taskId) {
                                startPolling(task.taskId, credential);
                            }
                        });
                    }
                }
            } catch (e) {
                console.warn('åŠ è½½å†å²å¤±è´¥:', e);
            }
        })();

        submitBtn.addEventListener('click', submitTask);

        // åˆå§‹åŒ–å…¨å±€APIKey
        if (window.initApiKeyInput) {
            window.initApiKeyInput('kling', 'credential');
        }

        // é¡µé¢å…³é—­æ—¶æ¸…ç†è½®è¯¢
        window.addEventListener('beforeunload', () => {
            Object.values(pollingTimers).forEach(timer => clearInterval(timer));
        });
    </script>
</body>
</html>
